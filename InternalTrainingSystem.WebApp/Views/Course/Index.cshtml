@model List<InternalTrainingSystem.WebApp.Models.DTOs.CourseDto>
@{
    ViewData["Title"] = "Danh Sách Khóa Học";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-book me-2"></i>Danh Sách Khóa Học
                        </h4>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-light btn-sm" onclick="refreshCourseList()">
                                <i class="fas fa-sync-alt me-1"></i>Làm mới
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Search and Filter Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput"
                                    placeholder="Tìm kiếm khóa học...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="levelFilter">
                                <option value="">Tất cả cấp độ</option>
                                <option value="Beginner">Cơ bản</option>
                                <option value="Intermediate">Trung cấp</option>
                                <option value="Advanced">Nâng cao</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="categoryFilter">
                                <option value="">Tất cả danh mục</option>
                            </select>
                        </div>
                    </div>

                    <!-- Course Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Tổng khóa học</h6>
                                            <h3 class="mb-0" id="totalCourses">@Model.Count</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-book fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Khóa học đang hoạt động</h6>
                                            <h3 class="mb-0" id="activeCourses">@Model.Count(c => c.IsActive)</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Danh mục</h6>
                                            <h3 class="mb-0" id="totalCategories">@Model.Select(c =>
                                                                                                c.CategoryName).Distinct().Count()</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-tags fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Thời lượng trung bình</h6>
                                            <h3 class="mb-0" id="avgDuration">@(Model.Any() ? Math.Round(Model.Average(c
                                                                                                => c.Duration), 0) : 0)h</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-clock fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Course List -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="courseTable">
                            <thead class="table-primary">
                                <tr>
                                    <th scope="col" style="width: 5%">#</th>
                                    <th scope="col" style="width: 25%">Tên khóa học</th>
                                    <th scope="col" style="width: 30%">Mô tả</th>
                                    <th scope="col" style="width: 10%">Thời lượng</th>
                                    <th scope="col" style="width: 10%">Cấp độ</th>
                                    <th scope="col" style="width: 10%">Danh mục</th>
                                    <th scope="col" style="width: 5%">Trạng thái</th>
                                    <th scope="col" style="width: 5%">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Any())
                                {
                                    @for (int i = 0; i < Model.Count; i++)
                                    {
                                        var course = Model[i];
                                        <tr data-course-id="@course.CourseId" data-course-name="@course.CourseName.ToLower()"
                                            data-level="@course.Level" data-category="@course.CategoryName">
                                            <td>@(i + 1)</td>
                                            <td>
                                                <div class="fw-bold text-primary">@course.CourseName</div>
                                                <small class="text-muted">ID: @course.CourseId</small>
                                            </td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 300px;"
                                                    title="@course.Description">
                                                    @(string.IsNullOrEmpty(course.Description) ? "Không có mô tả" :
                                                                                                course.Description)
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">@course.Duration giờ</span>
                                            </td>
                                            <td>
                                                @{
                                                    var levelClass = course.Level switch
                                                    {
                                                        "Beginner" => "bg-success",
                                                        "Intermediate" => "bg-warning",
                                                        "Advanced" => "bg-danger",
                                                        _ => "bg-secondary"
                                                    };
                                                    var levelText = course.Level switch
                                                    {
                                                        "Beginner" => "Cơ bản",
                                                        "Intermediate" => "Trung cấp",
                                                        "Advanced" => "Nâng cao",
                                                        _ => course.Level
                                                    };
                                                }
                                                <span class="badge @levelClass">@levelText</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">@course.CategoryName</span>
                                            </td>
                                            <td>
                                                @if (course.IsActive)
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-circle me-1"></i>Hoạt động
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-pause-circle me-1"></i>Tạm dừng
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                                        onclick="viewCourseDetails(@course.CourseId)" title="Xem chi tiết">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-success btn-sm"
                                                        onclick="enrollCourse(@course.CourseId)" title="Đăng ký">
                                                        <i class="fas fa-user-plus"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="text-muted">
                                                <i class="fas fa-folder-open fa-3x mb-3"></i>
                                                <p class="mb-0">Không có khóa học nào được tìm thấy</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination (if needed in future) -->
                    <nav aria-label="Course pagination" class="d-flex justify-content-center mt-4">
                        <div class="text-muted">
                            Hiển thị <span id="visibleCourses">@Model.Count</span> trong tổng số <span
                                id="totalCoursesCount">@Model.Count</span> khóa học
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize category filter with unique categories
            populateCategoryFilter();

            // Search functionality
            $('#searchInput').on('keyup', function () {
                filterCourses();
            });

            // Level filter
            $('#levelFilter').on('change', function () {
                filterCourses();
            });

            // Category filter
            $('#categoryFilter').on('change', function () {
                filterCourses();
            });
        });

        function populateCategoryFilter() {
            const categories = [];
            $('#courseTable tbody tr[data-course-id]').each(function () {
                const category = $(this).data('category');
                if (category && !categories.includes(category)) {
                    categories.push(category);
                }
            });

            categories.sort().forEach(category => {
                $('#categoryFilter').append(`<option value="${category}">${category}</option>`);
            });
        }

        function filterCourses() {
            const searchTerm = $('#searchInput').val().toLowerCase();
            const levelFilter = $('#levelFilter').val();
            const categoryFilter = $('#categoryFilter').val();

            let visibleCount = 0;

            $('#courseTable tbody tr[data-course-id]').each(function () {
                const courseName = $(this).data('course-name');
                const level = $(this).data('level');
                const category = $(this).data('category');

                const matchesSearch = !searchTerm || courseName.includes(searchTerm);
                const matchesLevel = !levelFilter || level === levelFilter;
                const matchesCategory = !categoryFilter || category === categoryFilter;

                if (matchesSearch && matchesLevel && matchesCategory) {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });

            $('#visibleCourses').text(visibleCount);

            // Show/hide no results message
            if (visibleCount === 0) {
                if ($('#noResultsRow').length === 0) {
                    $('#courseTable tbody').append(`
                                <tr id="noResultsRow">
                                    <td colspan="8" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-search fa-3x mb-3"></i>
                                            <p class="mb-0">Không tìm thấy khóa học phù hợp với tiêu chí tìm kiếm</p>
                                        </div>
                                    </td>
                                </tr>
                            `);
                }
            } else {
                $('#noResultsRow').remove();
            }
        }

        function refreshCourseList() {
            location.reload();
        }

        function viewCourseDetails(courseId) {
            window.location.href = '@Url.Action("Details", "Course")/' + courseId;
        }

        function enrollCourse(courseId) {
            // Implement course enrollment functionality
            if (confirm('Bạn có muốn đăng ký khóa học này không?')) {
                alert('Đăng ký khóa học ID: ' + courseId);
            }
        }
    </script>
}

@section Styles {
    <style>
        .card {
            border: none;
            border-radius: 10px;
        }

        .card-header {
            border-radius: 10px 10px 0 0 !important;
        }

        .table th {
            border-top: none;
            font-weight: 600;
        }

        .btn-group .btn {
            border-radius: 4px;
            margin-right: 2px;
        }

        .badge {
            font-size: 0.75em;
        }

        .text-truncate {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .table-responsive {
            border-radius: 8px;
        }

        .input-group-text {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
    </style>
}