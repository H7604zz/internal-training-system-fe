@{
    ViewData["Title"] = "Làm bài kiểm tra";
    var quizId = ViewBag.QuizId;
}

@section Styles {
    <link rel="stylesheet" href="~/css/lam-bai.css" asp-append-version="true" />
}

<div class="quiz-container">
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Đang tải bài kiểm tra...</p>
        </div>
    </div>

    <!-- Quiz Header -->
    <div id="quiz-header" class="quiz-header" style="display: none;">
        <h1 class="quiz-title" id="quiz-title">Bài kiểm tra</h1>
        <div class="quiz-meta">
            <div class="quiz-meta-item">
                <i class="fas fa-clock"></i>
                <span>Thời gian: <strong id="quiz-time-limit">--</strong></span>
            </div>
            <div class="quiz-meta-item">
                <i class="fas fa-question-circle"></i>
                <span>Số câu hỏi: <strong id="quiz-question-count">--</strong></span>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="quiz-content-wrapper" style="display: none;" id="quiz-content-wrapper">
        <!-- Sidebar -->
        <div class="quiz-sidebar" id="quiz-sidebar">
            <!-- Timer -->
            <div class="sidebar-section" id="timer-section-sidebar">
                <h4 class="sidebar-title"><i class="fas fa-clock me-2"></i>Thời gian còn lại</h4>
                <div class="timer" id="timer">
                    <span id="timer-display">00:00:00</span>
                </div>
            </div>

            <!-- Progress -->
            <div class="sidebar-section">
                <h4 class="sidebar-title"><i class="fas fa-tasks me-2"></i>Tiến độ</h4>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="answered-count">0</span>/<span id="total-count">0</span> câu hỏi
                </div>
            </div>

            <!-- Submit Button -->
            <div class="sidebar-section">
                <button type="button" class="btn-submit-quiz" onclick="submitQuiz()">
                    <i class="fas fa-paper-plane me-2"></i>Nộp bài
                </button>
            </div>
        </div>

        <!-- Questions Container -->
        <div class="quiz-main-content">
            <div id="questions-container"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let quizId = @quizId;
        let attemptId = null;
        let quizData = null;
        let timerInterval = null;
        let startTime = null;
        let timeLimit = 0; // in seconds
        let endTime = null;
        let userAnswers = {}; // { questionId: [answerId1, answerId2, ...] }
        let isSubmitting = false; // prevent double submit and race with timer
        let autoSaveInterval = null;

        // LocalStorage helper functions
        function getQuizStateKey() {
            return `quiz_state_${quizId}`;
        }

        function saveQuizState() {
            if (!attemptId) return;
            
            const state = {
                attemptId: attemptId,
                quizId: quizId,
                userAnswers: userAnswers,
                timestamp: new Date().toISOString(),
                startTime: startTime ? startTime.toISOString() : null,
                endTime: endTime ? endTime.toISOString() : null,
                timeLimit: timeLimit // Save original time limit in minutes
            };
            
            try {
                localStorage.setItem(getQuizStateKey(), JSON.stringify(state));
                console.log('Quiz state saved:', { 
                    attemptId: state.attemptId, 
                    endTime: state.endTime, 
                    timeLimit: state.timeLimit,
                    answersCount: Object.keys(userAnswers).length 
                });
            } catch (e) {
                console.error('Failed to save quiz state:', e);
            }
        }

        function loadQuizState() {
            try {
                const stateStr = localStorage.getItem(getQuizStateKey());
                if (!stateStr) return null;
                
                const state = JSON.parse(stateStr);
                
                // Check if state is for current quiz
                if (state.quizId !== quizId) return null;
                
                return state;
            } catch (e) {
                console.error('Failed to load quiz state:', e);
                return null;
            }
        }

        function clearQuizState() {
            try {
                localStorage.removeItem(getQuizStateKey());
            } catch (e) {
                console.error('Failed to clear quiz state:', e);
            }
        }

        function isAttemptExpired(savedEndTime) {
            if (!savedEndTime) return false;
            const end = new Date(savedEndTime);
            const now = new Date();
            return now >= end;
        }

        // Initialize quiz
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeQuiz();
        });

        async function initializeQuiz() {
            try {
                // Check if there's a saved quiz state
                const savedState = loadQuizState();
                
                // Get quiz info first to check if we need to start a new attempt
                const infoResponse = await fetch(`/bai-thi/get-quiz-info/${quizId}`);
                if (!infoResponse.ok) {
                    throw new Error('Không thể lấy thông tin quiz');
                }
                const quizInfo = await infoResponse.json();

                // Check if quiz is locked or no attempts remaining
                if (quizInfo.isLocked) {
                    clearQuizState();
                    alert('Bài kiểm tra này đã bị khóa!');
                    window.location.href = '/khoa-hoc';
                    return;
                }

                if (quizInfo.remainingAttempts === 0 && quizInfo.maxAttempts > 0) {
                    clearQuizState();
                    alert('Bạn đã hết lượt làm bài!');
                    window.history.back();
                    return;
                }

                // Try to get existing attempt or start new one
                // For now, we assume we need lessonId to start attempt
                // This should be passed from the HocTap page
                const urlParams = new URLSearchParams(window.location.search);
                const lessonId = urlParams.get('lessonId');
                
                if (!lessonId) {
                    alert('Thiếu thông tin bài học. Vui lòng quay lại trang học tập.');
                    window.history.back();
                    return;
                }

                // Check if we can resume from saved state
                let shouldCreateNewAttempt = true;
                if (savedState && savedState.attemptId) {
                    // Check if saved attempt is expired
                    if (savedState.endTime && isAttemptExpired(savedState.endTime)) {
                        console.log('Saved attempt has expired, creating new attempt');
                        clearQuizState();
                    } else {
                        // Try to verify if the saved attempt is still valid
                        try {
                            const verifyResponse = await fetch(`/bai-thi/get-quiz-for-attempt/${quizId}/${savedState.attemptId}?shuffleQuestions=false&shuffleAnswers=false`);
                            if (verifyResponse.ok) {
                                // Attempt is still valid, use it
                                console.log('Resuming from saved attempt:', savedState.attemptId);
                                console.log('Saved state:', savedState);
                                attemptId = savedState.attemptId;
                                shouldCreateNewAttempt = false;
                                
                                // Restore saved answers
                                userAnswers = savedState.userAnswers || {};
                                
                                // Restore time info
                                if (savedState.startTime) {
                                    startTime = new Date(savedState.startTime);
                                    console.log('Restored startTime:', startTime);
                                }
                                
                                if (savedState.endTime) {
                                    endTime = new Date(savedState.endTime);
                                    console.log('Restored endTime:', endTime);
                                } else if (savedState.timeLimit && savedState.timeLimit > 0 && startTime) {
                                    // Calculate endTime from startTime + timeLimit
                                    endTime = new Date(startTime.getTime() + savedState.timeLimit * 60 * 1000);
                                    console.log('Calculated endTime from startTime + timeLimit:', endTime);
                                }
                                
                                if (endTime) {
                                    console.log('Current time:', new Date());
                                    console.log('Time remaining (seconds):', Math.floor((endTime - new Date()) / 1000));
                                }
                                
                                // Restore original timeLimit for display
                                if (savedState.timeLimit !== undefined) {
                                    timeLimit = savedState.timeLimit;
                                    console.log('Restored timeLimit:', timeLimit, 'minutes');
                                }
                            } else if (verifyResponse.status === 409) {
                                // Attempt timed out
                                console.log('Saved attempt timed out, creating new attempt');
                                clearQuizState();
                            } else {
                                console.log('Saved attempt is invalid, creating new attempt');
                                clearQuizState();
                            }
                        } catch (e) {
                            console.log('Could not verify saved attempt, creating new attempt:', e);
                            clearQuizState();
                        }
                    }
                }

                // Start new attempt if needed
                if (shouldCreateNewAttempt) {
                    const startResponse = await fetch(`/bai-thi/start-quiz/${lessonId}`, {
                        method: 'POST'
                    });

                    if (!startResponse.ok) {
                        throw new Error('Không thể bắt đầu làm bài');
                    }

                    const startData = await startResponse.json();
                    console.log('Started new attempt:', startData);
                    attemptId = startData.attemptId;
                    
                    // Server returns startTimeUtc and endTimeUtc
                    startTime = new Date(startData.startTimeUtc || startData.startTime);
                    timeLimit = startData.timeLimit || 0; // in minutes
                    
                    if (startData.endTimeUtc || startData.endTime) {
                        endTime = new Date(startData.endTimeUtc || startData.endTime);
                        console.log('New attempt endTime from server:', endTime);
                    } else if (timeLimit > 0 && startTime) {
                        // Calculate endTime if not provided by server
                        endTime = new Date(startTime.getTime() + timeLimit * 60 * 1000);
                        console.log('Calculated endTime (startTime + timeLimit):', endTime);
                    } else {
                        console.log('No time limit for this quiz');
                    }
                    
                    // Save initial state
                    saveQuizState();
                    console.log('Initial state saved to localStorage');
                }

                // Load quiz questions
                await loadQuiz();
            } catch (error) {
                alert('Có lỗi xảy ra khi khởi tạo bài kiểm tra: ' + error.message);
                window.history.back();
            }
        }

        async function loadQuiz() {
            try {
                // Check if we're resuming - if so, don't shuffle to maintain answer mapping
                const isResuming = Object.keys(userAnswers).length > 0;
                const response = await fetch(`/bai-thi/get-quiz-for-attempt/${quizId}/${attemptId}?shuffleQuestions=${!isResuming}&shuffleAnswers=${!isResuming}`);
                
                if (!response.ok) {
                    if (response.status === 409) {
                        clearQuizState();
                        alert('Bài làm đã hết thời gian');
                        window.history.back();
                        return;
                    }
                    throw new Error('Không thể tải bài kiểm tra');
                }

                quizData = await response.json();
                
                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';
                
                // Display quiz
                displayQuiz();
                
                // Start timer if time limit exists
                if (timeLimit > 0) {
                    startTimer();
                }
                
                // Start auto-save interval (save every 10 seconds)
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                }
                autoSaveInterval = setInterval(() => {
                    saveQuizState();
                }, 10000);
            } catch (error) {
                alert('Có lỗi xảy ra khi tải bài kiểm tra: ' + error.message);
                window.history.back();
            }
        }

        function displayQuiz() {
            // Show quiz sections
            document.getElementById('quiz-header').style.display = 'block';
            document.getElementById('quiz-content-wrapper').style.display = 'flex';
            
            if (timeLimit > 0) {
                document.getElementById('timer-section-sidebar').style.display = 'block';
            } else {
                document.getElementById('timer-section-sidebar').style.display = 'none';
            }

            // Set quiz info
            document.getElementById('quiz-title').textContent = quizData.title || 'Bài kiểm tra';
            document.getElementById('quiz-time-limit').textContent = timeLimit > 0 ? `${timeLimit} phút` : 'Không giới hạn';
            document.getElementById('quiz-question-count').textContent = quizData.questions.length;
            document.getElementById('total-count').textContent = quizData.questions.length;

            // Render questions
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            if (!quizData.questions || quizData.questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Không có câu hỏi nào trong bài kiểm tra này</p>
                    </div>
                `;
                return;
            }

            quizData.questions.forEach((question, index) => {
                const questionCard = createQuestionCard(question, index + 1);
                container.appendChild(questionCard);
            });

            // Restore saved answers if any
            restoreSavedAnswers();

            updateProgress();
        }

        function restoreSavedAnswers() {
            if (!userAnswers || Object.keys(userAnswers).length === 0) return;
            
            Object.keys(userAnswers).forEach(questionId => {
                const answerIds = userAnswers[questionId];
                if (!Array.isArray(answerIds) || answerIds.length === 0) return;
                
                const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
                if (!card) return;
                
                // Check/select the saved answers
                answerIds.forEach(answerId => {
                    const option = card.querySelector(`.answer-option[data-answer-id="${answerId}"]`);
                    if (!option) return;
                    
                    const input = option.querySelector('input');
                    if (input) {
                        input.checked = true;
                        option.classList.add('selected');
                    }
                });
            });
        }

        function createQuestionCard(question, number) {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.dataset.questionId = question.questionId;

            const isMultipleChoice = question.questionType === 'MultipleChoice';
            const inputType = isMultipleChoice ? 'checkbox' : 'radio';
            const inputName = `question-${question.questionId}`;

            let answersHtml = '';
            if (question.answers && question.answers.length > 0) {
                question.answers.forEach(answer => {
                    answersHtml += `
                        <label class="answer-option" data-answer-id="${answer.answerId}">
                            <input type="${inputType}" name="${inputName}" value="${answer.answerId}" 
                                onchange="handleAnswerChange(${question.questionId}, ${answer.answerId}, this.checked)">
                            <span class="answer-text">${answer.answerText}</span>
                        </label>
                    `;
                });
            }

            card.innerHTML = `
                <div class="question-number">Câu ${number}</div>
                <span class="question-points">${question.points || 0} điểm</span>
                <div class="question-text">${question.questionText}</div>
                <div class="answers-container">
                    ${answersHtml}
                </div>
            `;

            return card;
        }

        function handleAnswerChange(questionId, answerId, isChecked) {
            const question = quizData.questions.find(q => q.questionId === questionId);
            const isMultipleChoice = question.questionType === 'MultipleChoice';

            if (!userAnswers[questionId]) {
                userAnswers[questionId] = [];
            }

            if (isMultipleChoice) {
                // Multiple choice: add or remove answer
                if (isChecked) {
                    if (!userAnswers[questionId].includes(answerId)) {
                        userAnswers[questionId].push(answerId);
                    }
                } else {
                    userAnswers[questionId] = userAnswers[questionId].filter(id => id !== answerId);
                }
            } else {
                // Single choice: replace with new answer
                userAnswers[questionId] = [answerId];
            }

            // Update UI
            const card = document.querySelector(`.question-card[data-question-id="${questionId}"]`);
            card.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
            userAnswers[questionId].forEach(id => {
                const option = card.querySelector(`.answer-option[data-answer-id="${id}"]`);
                if (option) option.classList.add('selected');
            });

            updateProgress();
            
            // Save state immediately when answer changes
            saveQuizState();
        }

        function updateProgress() {
            if (!quizData || !quizData.questions) return;
            const totalCount = quizData.questions.length;
            const answeredCount = quizData.questions.filter(q => {
                const a = userAnswers[q.questionId];
                return Array.isArray(a) && a.length > 0;
            }).length;
            const percentage = totalCount > 0 ? Math.round((answeredCount / totalCount) * 100) : 0;

            document.getElementById('answered-count').textContent = answeredCount;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
        }

        function startTimer() {
            // Always calculate from endTime if it exists (for resume scenarios)
            let remainingSeconds;
            if (endTime) {
                const now = new Date();
                remainingSeconds = Math.max(0, Math.floor((endTime - now) / 1000));
                console.log('Timer starting with endTime:', {
                    endTime: endTime.toISOString(),
                    now: now.toISOString(),
                    remainingSeconds: remainingSeconds,
                    remainingMinutes: Math.floor(remainingSeconds / 60)
                });
            } else {
                // Fresh start - use timeLimit
                remainingSeconds = timeLimit * 60;
                console.log('Timer starting with timeLimit:', {
                    timeLimit: timeLimit,
                    remainingSeconds: remainingSeconds
                });
            }

            console.log('Starting timer with remaining seconds:', remainingSeconds);
            updateTimerDisplay(remainingSeconds);

            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay(remainingSeconds);

                const timer = document.getElementById('timer');
                
                // Warning at 5 minutes
                if (remainingSeconds <= 300 && remainingSeconds > 60) {
                    timer.classList.add('warning');
                    timer.classList.remove('danger');
                }
                // Danger at 1 minute
                else if (remainingSeconds <= 60) {
                    timer.classList.add('danger');
                    timer.classList.remove('warning');
                }

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    
                    // Clear auto-save interval
                    if (autoSaveInterval) {
                        clearInterval(autoSaveInterval);
                        autoSaveInterval = null;
                    }
                    
                    alert('Hết thời gian làm bài!');
                    // Auto-submit when time is up without confirmation
                    submitQuiz({ skipConfirm: true });
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
        }

        async function submitQuiz(options = {}) {
            const { skipConfirm = false } = options;
            if (isSubmitting) {
                return; // prevent double submit from button + timer
            }
            // Check if all questions are answered
            const totalCount = quizData.questions.length;
            const unansweredQuestions = quizData.questions.filter(q => {
                const answers = userAnswers[q.questionId];
                return !Array.isArray(answers) || answers.length === 0;
            });
            const answeredQuestions = quizData.questions.filter(q => !unansweredQuestions.includes(q));
            const answeredCount = answeredQuestions.length;

            if (!skipConfirm && answeredCount < totalCount) {
                const unansweredCount = totalCount - answeredCount;
                if (!confirm(`Bạn chưa trả lời ${unansweredCount} câu hỏi. Bạn có chắc chắn muốn nộp bài?`)) {
                    return;
                }
            }

            isSubmitting = true;

            // Stop timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // Disable submit button
            const submitBtn = document.querySelector('.btn-submit-quiz');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang nộp bài...';

            // Show loading overlay
            document.getElementById('loading-overlay').style.display = 'flex';
            document.querySelector('.loading-content p').textContent = 'Đang nộp bài và chấm điểm...';

            try {
                // Prepare submission data
                const submissionData = {
                    answers: Object.keys(userAnswers).map(questionId => ({
                        questionId: parseInt(questionId),
                        selectedAnswerIds: userAnswers[questionId]
                    }))
                };

                // Get lessonId from URL params
                const urlParams = new URLSearchParams(window.location.search);
                const lessonId = urlParams.get('lessonId');

                const response = await fetch(`/bai-thi/submit-quiz/${lessonId}/${attemptId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submissionData)
                });

                if (!response.ok) {
                    throw new Error('Không thể nộp bài');
                }

                const result = await response.json();

                // Clear saved state after successful submission
                clearQuizState();
                
                // Clear auto-save interval
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }

                // Redirect to result page
                window.location.href = `/bai-thi/ket-qua/${attemptId}`;
            } catch (error) {
                alert('Có lỗi xảy ra khi nộp bài: ' + error.message);
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Nộp bài';
                
                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';
                
                // Restart timer if applicable
                if (timeLimit > 0) {
                    startTimer();
                }
                isSubmitting = false;
            }
        }

        // Prevent accidental page refresh/close
        window.addEventListener('beforeunload', function (e) {
            // Do not block navigation during intentional submission
            if (isSubmitting) return;
            if (attemptId && timerInterval) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
}
