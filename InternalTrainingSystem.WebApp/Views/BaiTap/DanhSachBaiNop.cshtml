@model List<InternalTrainingSystem.WebApp.Models.DTOs.AssignmentSubmissionSummaryDto>

@{
    ViewData["Title"] = "Danh Sách Bài Nộp";
    var assignmentId = ViewBag.AssignmentId;
}

@section Styles {
    <link rel="stylesheet" href="~/css/bai-tap.css" asp-append-version="true" />
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-list-alt me-2"></i>Danh Sách Bài Nộp
                    </h2>
                    <p class="text-muted mb-0">
                        Tổng số: <strong>@Model.Count</strong> bài nộp
                    </p>
                </div>
                <div>
                    <button onclick="history.back()" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Quay Lại
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Statistics -->
    @if (Model != null && Model.Any())
    {
        var totalSubmissions = Model.Count;
        var gradedSubmissions = Model.Count(s => s.IsGraded);
        var lateSubmissions = Model.Count(s => s.IsLate);
        var avgScore = Model.Where(s => s.Score.HasValue).Any() 
            ? Model.Where(s => s.Score.HasValue).Average(s => s.Score!.Value) 
            : (decimal?)null;

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                        <h4 class="mb-0">@totalSubmissions</h4>
                        <small class="text-muted">Tổng bài nộp</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h4 class="mb-0">@gradedSubmissions</h4>
                        <small class="text-muted">Đã chấm điểm</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h4 class="mb-0">@lateSubmissions</h4>
                        <small class="text-muted">Nộp muộn</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-star fa-2x text-info mb-2"></i>
                        <h4 class="mb-0">@(avgScore.HasValue ? avgScore.Value.ToString("0.##") : "N/A")</h4>
                        <small class="text-muted">Điểm trung bình</small>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Submissions Table -->
    @if (Model != null && Model.Any())
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>STT</th>
                                <th>Nhân Viên</th>
                                <th>Email</th>
                                <th>Thời Gian Nộp</th>
                                <th>Trạng Thái</th>
                                <th>Điểm</th>
                                <th>Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var index = 1;
                            }
                            @foreach (var submission in Model.OrderBy(s => s.SubmittedAt))
                            {
                                <tr>
                                    <td>@index</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle fa-2x text-secondary me-2"></i>
                                            <div>
                                                <strong>@submission.EmployeeName</strong>
                                                <br>
                                                <small class="text-muted">@submission.EmployeeId</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>@submission.EmployeeEmail</small>
                                    </td>
                                    <td>
                                        <small>@submission.SubmittedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>
                                    <td>
                                        @if (submission.IsLate)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Nộp muộn
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Đúng hạn
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @if (submission.IsGraded)
                                        {
                                            <span class="badge bg-primary fs-6">
                                                <i class="fas fa-star me-1"></i>@submission.Score?.ToString("0.##")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-minus me-1"></i>Chưa chấm
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="@Url.Action("ChiTietBaiNop", "BaiTap", new { assignmentId, submissionId = submission.SubmissionId })"
                                               class="btn btn-outline-primary" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            @if (!submission.IsGraded)
                                            {
                                                <button type="button" class="btn btn-outline-success"
                                                        onclick="openGradeModal(@submission.SubmissionId, '@submission.EmployeeName')"
                                                        title="Chấm điểm">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                                index++;
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">Chưa có bài nộp nào</h4>
            <p class="text-muted">Học viên chưa nộp bài tập</p>
        </div>
    }
</div>

<!-- Grade Modal -->
<div class="modal fade" id="gradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-star me-2"></i>Chấm Điểm Bài Nộp
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="gradeForm">
                    <input type="hidden" id="submissionId" />
                    
                    <div class="mb-3">
                        <label class="form-label">Nhân Viên</label>
                        <p class="form-control-plaintext fw-bold" id="employeeName"></p>
                    </div>

                    <div class="mb-3">
                        <label for="score" class="form-label">
                            Điểm <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="score" 
                               min="0" max="10" step="0.1" required>
                        <div class="form-text">Nhập điểm từ 0 đến 10</div>
                    </div>

                    <div class="mb-3">
                        <label for="feedback" class="form-label">Nhận Xét</label>
                        <textarea class="form-control" id="feedback" rows="4"
                                  placeholder="Nhập nhận xét về bài làm của học viên..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="submitGrade()">
                    <i class="fas fa-save me-2"></i>Lưu Điểm
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/bai-tap.js" asp-append-version="true"></script>
    <script>
        var currentAssignmentId = @assignmentId;

        function openGradeModal(submissionId, employeeName) {
            $('#submissionId').val(submissionId);
            $('#employeeName').text(employeeName);
            $('#score').val('');
            $('#feedback').val('');
            $('#gradeModal').modal('show');
        }

        function submitGrade() {
            var submissionId = $('#submissionId').val();
            var score = $('#score').val();
            var feedback = $('#feedback').val();

            if (!score) {
                alert('Vui lòng nhập điểm!');
                return;
            }

            gradeSubmission(currentAssignmentId, submissionId, score, feedback);
        }
    </script>
}
