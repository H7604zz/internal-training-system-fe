@model int
@{
    ViewData["Title"] = "Chọn Lịch Học";
    var classId = Model;
}

@section Styles {
    <link rel="stylesheet" href="~/css/calendar-schedule.css" />
}

<div class="container-fluid calendar-schedule-container">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-calendar-alt me-2"></i>Chọn Lịch Học
                </h2>
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="history.back()">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </button>
                    <button type="button" class="btn btn-success" id="confirmScheduleBtn">
                        <i class="fas fa-check me-2"></i>Xác nhận lịch học
                    </button>
                </div>
            </div>

            <!-- Configuration Panel -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Cấu Hình Lịch Học
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="weeksCount" class="form-label">Số tuần học</label>
                            <input type="number" id="weeksCount" class="form-control" min="1" max="52" value="12" placeholder="Nhập số tuần...">
                        </div>
                        <div class="col-md-3">
                            <label for="daysPerWeek" class="form-label">Số ngày học/tuần</label>
                            <select id="daysPerWeek" class="form-select">
                                <option value="1">1 ngày/tuần</option>
                                <option value="2" selected>2 ngày/tuần</option>
                                <option value="3">3 ngày/tuần</option>
                                <option value="4">4 ngày/tuần</option>
                                <option value="5">5 ngày/tuần</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Ngày bắt đầu</label>
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" id="generateCalendarBtn">
                                <i class="fas fa-calendar-plus me-2"></i>Tạo lịch
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Template -->
            <div class="card mb-4" id="weeklyTemplateCard" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Mẫu Lịch Tuần
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Thiết lập lịch học mẫu sẽ được áp dụng cho tất cả các tuần
                    </p>
                    <div class="row" id="weeklyTemplate">
                        <!-- Weekly template will be generated here -->
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-primary" id="applyTemplateBtn">
                            <i class="fas fa-copy me-2"></i>Áp dụng cho tất cả các tuần
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="card" id="calendarCard" style="display: none;">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar me-2"></i>Lịch Học Chi Tiết
                    </h5>
                    <div class="calendar-navigation">
                        <button type="button" class="btn btn-outline-light btn-sm" id="prevWeek">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="mx-3" id="currentWeekDisplay">Tuần 1-4</span>
                        <button type="button" class="btn btn-outline-light btn-sm" id="nextWeek">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="calendar-wrapper">
                        <div class="calendar-grid" id="calendarGrid">
                            <!-- Calendar grid will be generated here -->
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="schedule-summary">
                                <h6>Tóm tắt lịch học:</h6>
                                <p class="mb-0" id="scheduleSummary">
                                    <span class="badge bg-primary me-2" id="totalSessions">0 buổi học</span>
                                    <span class="badge bg-success me-2" id="totalWeeks">0 tuần</span>
                                    <span class="badge bg-info" id="avgSessionsPerWeek">0 buổi/tuần</span>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="legend">
                                <small class="text-muted">
                                    <span class="legend-item">
                                        <span class="legend-color bg-success"></span>
                                        Đã chọn
                                    </span>
                                    <span class="legend-item ms-3">
                                        <span class="legend-color bg-light border"></span>
                                        Có thể chọn
                                    </span>
                                    <span class="legend-item ms-3">
                                        <span class="legend-color bg-secondary"></span>
                                        Nghỉ
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Detail Modal -->
<div class="modal fade" id="dayDetailModal" tabindex="-1" aria-labelledby="dayDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="dayDetailModalLabel">
                    <i class="fas fa-edit me-2"></i>Chi Tiết Buổi Học
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dayDetailForm">
                    <input type="hidden" id="modalWeek">
                    <input type="hidden" id="modalDay">
                    <input type="hidden" id="modalDate">
                    
                    <div class="mb-3">
                        <label class="form-label">Ngày học</label>
                        <input type="text" class="form-control" id="modalDateDisplay" readonly>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="modalStartTime" class="form-label">Giờ bắt đầu</label>
                                <input type="time" class="form-control" id="modalStartTime" value="08:00">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="modalEndTime" class="form-label">Giờ kết thúc</label>
                                <input type="time" class="form-control" id="modalEndTime" value="17:00">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalRoom" class="form-label">Phòng học</label>
                        <input type="text" class="form-control" id="modalRoom" placeholder="Nhập phòng học..." value="A101">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="modalIsActive" checked>
                        <label class="form-check-label" for="modalIsActive">
                            Có học trong ngày này
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveDayDetail">
                    <i class="fas fa-save me-2"></i>Lưu
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        const classId = @classId;
    </script>
    <script src="~/js/calendar-schedule.js"></script>
    <script>
        // Override confirmSchedule function to save to database
        const originalConfirmBtn = document.getElementById('confirmScheduleBtn');
        if (originalConfirmBtn) {
            originalConfirmBtn.addEventListener('click', async function() {
                // Get schedule data from calendar-schedule.js
                const scheduleData = getScheduleData();
                
                if (!scheduleData || scheduleData.length === 0) {
                    alert('Vui lòng tạo lịch học trước khi xác nhận!');
                    return;
                }

                if (!confirm(`Bạn có chắc chắn muốn lưu ${scheduleData.length} buổi học?`)) {
                    return;
                }

                const btn = this;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...';
                btn.disabled = true;

                try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    const response = await fetch('/lop-hoc/luu-lich-hoc', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({
                            classId: classId,
                            schedules: scheduleData
                        })
                    });

                    if (response.ok) {
                        alert('Lưu lịch học thành công!');
                        window.location.href = `/lop-hoc/chi-tiet/${classId}`;
                    } else {
                        const error = await response.text();
                        alert('Lỗi: ' + error);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                } catch (error) {
                    alert('Đã xảy ra lỗi: ' + error.message);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        }

        // Helper function to get schedule data
        function getScheduleData() {
            const scheduleDays = document.querySelectorAll('.calendar-day.selected');
            const schedules = [];

            scheduleDays.forEach(day => {
                const date = day.dataset.date;
                const startTime = day.dataset.startTime || '08:00';
                const endTime = day.dataset.endTime || '17:00';
                const room = day.dataset.room || 'A101';

                if (date) {
                    schedules.push({
                        classDate: date,
                        startTime: startTime,
                        endTime: endTime,
                        room: room
                    });
                }
            });

            return schedules;
        }
    </script>
}