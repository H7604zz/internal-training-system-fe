@model InternalTrainingSystem.WebApp.Models.DTOs.ChangePasswordRequestDto
@{
    ViewData["Title"] = "Đổi Mật Khẩu";
}

@section Styles {
    <link rel="stylesheet" href="~/css/change-password.css?v=@DateTime.Now.Ticks" />
}

<div class="change-password-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="password-card">
                    <div class="password-header">
                        <h4><i class="fas fa-shield-alt me-2"></i>Đổi Mật Khẩu</h4>
                    </div>
                    <div class="password-body">
                        <div class="password-help">
                            <h6><i class="fas fa-info-circle me-2"></i>Yêu cầu mật khẩu:</h6>
                            <ul class="mb-0 small">
                                <li>Tối thiểu 6 ký tự</li>
                                <li>Nên kết hợp chữ cái, số và ký tự đặc biệt</li>
                                <li>Không sử dụng thông tin cá nhân dễ đoán</li>
                            </ul>
                        </div>

                        <form asp-controller="Auth" asp-action="DoiMatKhau" method="post" class="needs-validation" novalidate>
                            <div asp-validation-summary="All" class="alert alert-danger d-none"></div>

                            <div class="form-floating">
                                <input asp-for="CurrentPassword" type="password" class="form-control" id="currentPassword" 
                                       placeholder="Mật khẩu hiện tại" required>
                                <label for="currentPassword">Mật khẩu hiện tại *</label>
                                <button type="button" class="password-toggle" onclick="togglePassword('currentPassword', this)">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                                <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                            </div>

                            <div class="form-floating">
                                <input asp-for="NewPassword" type="password" class="form-control" id="newPassword" 
                                       placeholder="Mật khẩu mới" required>
                                <label for="newPassword">Mật khẩu mới *</label>
                                <button type="button" class="password-toggle" onclick="togglePassword('newPassword', this)">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                                <span asp-validation-for="NewPassword" class="text-danger"></span>
                            </div>

                            <div class="form-floating">
                                <input asp-for="ConfirmPassword" type="password" class="form-control" id="confirmPassword" 
                                       placeholder="Xác nhận mật khẩu mới" required>
                                <label for="confirmPassword">Xác nhận mật khẩu mới *</label>
                                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                                <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-change-password" id="submitButton">
                                    <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true" id="submitSpinner"></span>
                                    <span id="submitText">
                                        <i class="fas fa-key me-2"></i>Đổi Mật Khẩu
                                    </span>
                                </button>
                                
                                <a href="@Url.Action("ThongTinCaNhan")" class="btn btn-back">
                                    <i class="fas fa-arrow-left me-2"></i>Quay Lại Profile
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Toggle password visibility function
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        }

        // Form submission with loading state
        document.querySelector('form').addEventListener('submit', function(e) {
            if (this.checkValidity()) {
                document.getElementById('submitSpinner').classList.remove('d-none');
                document.getElementById('submitText').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';
                document.getElementById('submitButton').disabled = true;
            }
        });

        // Password strength validation
        document.getElementById('newPassword').addEventListener('input', function() {
            const password = this.value;
            const confirmPassword = document.getElementById('confirmPassword');
            
            // Check if passwords match when confirm password has value
            if (confirmPassword.value && password !== confirmPassword.value) {
                confirmPassword.setCustomValidity('Mật khẩu xác nhận không khớp');
            } else {
                confirmPassword.setCustomValidity('');
            }
        });

        document.getElementById('confirmPassword').addEventListener('input', function() {
            const newPassword = document.getElementById('newPassword').value;
            
            if (this.value !== newPassword) {
                this.setCustomValidity('Mật khẩu xác nhận không khớp');
            } else {
                this.setCustomValidity('');
            }
        });
    </script>
}