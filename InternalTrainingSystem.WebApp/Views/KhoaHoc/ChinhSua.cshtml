@model InternalTrainingSystem.WebApp.Models.DTOs.CourseDto
@{
    ViewData["Title"] = "Ch·ªânh S·ª≠a Kh√≥a H·ªçc";
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
}

<div class="course-container">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="form-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="header-content">
                        <h1 class="form-title">
                            <i class="fas fa-edit me-3"></i>Ch·ªânh S·ª≠a Kh√≥a H·ªçc
                        </h1>
                        <p class="form-subtitle">
                            <i class="fas fa-info-circle me-2"></i>
                            C·∫≠p nh·∫≠t th√¥ng tin kh√≥a h·ªçc ƒë√†o t·∫°o n·ªôi b·ªô
                        </p>
                        <div class="course-meta-inline mt-3">
                            <span class="meta-item">
                                <i class="fas fa-code"></i>
                                <span>@Model.Code</span>
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-calendar-plus"></i>
                                <span>@(Model.CreatedDate.ToString("dd/MM/yyyy"))</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="action-buttons">
                        <a href="@Url.Action("ChiTiet", new { id = Model.CourseId })" class="btn btn-back">
                            <i class="fas fa-arrow-left me-2"></i>Quay L·∫°i
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <form method="post" asp-action="ChinhSua" class="course-edit-form">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="CourseId" />
            <input type="hidden" asp-for="CreatedDate" />

            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8 mb-4">
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-info-circle me-2"></i>Th√¥ng Tin C∆° B·∫£n
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="CourseName" class="form-label required">
                                    <i class="fas fa-graduation-cap me-1"></i>T√™n kh√≥a h·ªçc
                                </label>
                                <input asp-for="CourseName" class="form-control" 
                                       placeholder="Nh·∫≠p t√™n kh√≥a h·ªçc (VD: Kh√≥a h·ªçc l·∫≠p tr√¨nh C#)">
                                <span asp-validation-for="CourseName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Code" class="form-label required">
                                    <i class="fas fa-barcode me-1"></i>M√£ kh√≥a h·ªçc
                                </label>
                                <input asp-for="Code" class="form-control" 
                                       placeholder="VD: IT-001">
                                <span asp-validation-for="Code" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>M√¥ t·∫£ kh√≥a h·ªçc
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                                      placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ n·ªôi dung, m·ª•c ti√™u v√† l·ª£i √≠ch c·ªßa kh√≥a h·ªçc..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                M√¥ t·∫£ n√™n bao g·ªìm m·ª•c ti√™u h·ªçc t·∫≠p, n·ªôi dung ch√≠nh v√† ƒë·ªëi t∆∞·ª£ng h·ªçc vi√™n
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Category" class="form-label required">
                                    <i class="fas fa-folder me-1"></i>Danh m·ª•c
                                </label>
                                <select asp-for="Category" class="form-select">
                                    <option value="">-- Ch·ªçn danh m·ª•c kh√≥a h·ªçc --</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (dynamic category in ViewBag.Categories)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="Category" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Level" class="form-label required">
                                    <i class="fas fa-layer-group me-1"></i>C·∫•p ƒë·ªô
                                </label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">-- Ch·ªçn c·∫•p ƒë·ªô --</option>
                                    <option value="C∆° b·∫£n">üü¢ C∆° b·∫£n</option>
                                    <option value="Trung c·∫•p">üü° Trung c·∫•p</option>
                                    <option value="N√¢ng cao">üî¥ N√¢ng cao</option>
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Duration" class="form-label required">
                                    <i class="fas fa-stopwatch me-1"></i>Th·ªùi l∆∞·ª£ng (gi·ªù)
                                </label>
                                <input asp-for="Duration" type="number" class="form-control" min="1" max="500"
                                       placeholder="VD: 40">
                                <span asp-validation-for="Duration" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    T·ªïng th·ªùi gian h·ªçc bao g·ªìm l√Ω thuy·∫øt v√† th·ª±c h√†nh
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>Tr·∫°ng th√°i ho·∫°t ƒë·ªông
                                </label>
                                <div class="form-check form-switch mt-2">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch">
                                    <label asp-for="IsActive" class="form-check-label">
                                        <span class="fw-semibold">Kh√≥a h·ªçc ƒëang ho·∫°t ƒë·ªông</span>
                                        <br>
                                        <small class="text-muted">Cho ph√©p t·∫°o l·ªõp h·ªçc v√† ƒëƒÉng k√Ω m·ªõi</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Department Selection -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-building me-2"></i>Ph√≤ng Ban √Åp D·ª•ng
                        </h3>
                        <div class="form-help-text">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch·ªçn c√°c ph√≤ng ban m√† kh√≥a h·ªçc n√†y s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng. Nh√¢n vi√™n thu·ªôc c√°c ph√≤ng ban ƒë∆∞·ª£c ch·ªçn s·∫Ω c√≥ th·ªÉ ƒëƒÉng k√Ω tham gia kh√≥a h·ªçc.
                        </div>
                        
                        <div class="departments-selection">
                            @if (ViewBag.Departments != null)
                            {
                                @foreach (var dept in ViewBag.Departments)
                                {
                                    <div class="form-check department-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="SelectedDepartmentIds" value="@dept.Id" 
                                               id="dept_@dept.Id"
                                               checked="@(Model.Departments?.Any(d => d.Id == dept.Id) == true)">
                                        <label class="form-check-label" for="dept_@dept.Id">
                                            <i class="fas fa-building me-2"></i>
                                            <span class="fw-semibold">@dept.Name</span>
                                            <br>
                                            <small class="text-muted">Ph√≤ng ban trong t·ªï ch·ª©c</small>
                                        </label>
                                    </div>
                                }
                                
                                <div class="departments-help text-info small mt-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span class="department-counter">@(Model.Departments?.Count ?? 0) ph√≤ng ban ƒë∆∞·ª£c ch·ªçn</span>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Kh√¥ng c√≥ d·ªØ li·ªáu ph√≤ng ban. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Side Panel -->
                <div class="col-lg-4 mb-4">
                    <!-- Form Actions -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi
                        </h3>
                        
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi
                            </button>
                            <a href="@Url.Action("ChiTiet", new { id = Model.CourseId })" 
                               class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>H·ªßy B·ªè
                            </a>
                        </div>
                        
                        <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>L∆∞u √Ω:</strong> C√°c thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c v√† c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c l·ªõp h·ªçc ƒëang di·ªÖn ra.
                            </small>
                        </div>
                    </div>

                    <!-- Course Status -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-chart-pie me-2"></i>Tr·∫°ng Th√°i Kh√≥a H·ªçc
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-check-circle text-success"></i>
                                <span>
                                    <strong>ƒê√£ t·∫°o:</strong><br>
                                    <small class="text-muted">@(Model.CreatedDate.ToString("dd/MM/yyyy HH:mm"))</small>
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-@(Model.IsActive ? "play-circle text-success" : "pause-circle text-warning")"></i>
                                <span>
                                    <strong>Tr·∫°ng th√°i:</strong><br>
                                    <small class="text-muted">@(Model.IsActive ? "ƒêang ho·∫°t ƒë·ªông" : "T·∫°m d·ª´ng")</small>
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-users text-info"></i>
                                <span>
                                    <strong>Ph√≤ng ban:</strong><br>
                                    <small class="text-muted">@(Model.Departments?.Count ?? 0) ph√≤ng ban ƒë∆∞·ª£c ch·ªçn</small>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Form Help -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-question-circle me-2"></i>H∆∞·ªõng D·∫´n Ch·ªânh S·ª≠a
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>T√™n kh√≥a h·ªçc:</strong> N√™n ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu v√† ph·∫£n √°nh ƒë√∫ng n·ªôi dung
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>M√£ kh√≥a h·ªçc:</strong> Theo ƒë·ªãnh d·∫°ng chu·∫©n: ABC-123 (kh√¥ng ƒë∆∞·ª£c tr√πng)
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>C·∫•p ƒë·ªô:</strong> Ch·ªçn ph√π h·ª£p v·ªõi ƒë·ªô kh√≥ v√† ki·∫øn th·ª©c y√™u c·∫ßu
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Th·ªùi l∆∞·ª£ng:</strong> T√≠nh theo gi·ªù h·ªçc th·ª±c t·∫ø (bao g·ªìm l√Ω thuy·∫øt + th·ª±c h√†nh)
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Ph√≤ng ban:</strong> Ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban ƒë·ªÉ nh√¢n vi√™n c√≥ th·ªÉ ƒëƒÉng k√Ω
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Form validation and interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-generate course code from name
            const courseNameInput = document.querySelector('#CourseName');
            const courseCodeInput = document.querySelector('#Code');
            
            if (courseNameInput && courseCodeInput && !courseCodeInput.value) {
                courseNameInput.addEventListener('blur', function() {
                    if (!courseCodeInput.value && this.value) {
                        // Generate simple code from name
                        const words = this.value.split(' ').slice(0, 2);
                        const code = words.map(word => word.charAt(0).toUpperCase()).join('') + 
                                   '-' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0');
                        courseCodeInput.value = code;
                        
                        // Add visual feedback
                        courseCodeInput.style.background = '#e8f5e8';
                        setTimeout(() => {
                            courseCodeInput.style.background = '';
                        }, 1000);
                    }
                });
            }

            // Department selection counter and feedback
            const departmentCheckboxes = document.querySelectorAll('input[name="SelectedDepartmentIds"]');
            const updateDepartmentCounter = () => {
                const selected = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked').length;
                const counterElement = document.querySelector('.department-counter');
                if (counterElement) {
                    counterElement.textContent = `${selected} ph√≤ng ban ƒë∆∞·ª£c ch·ªçn`;
                }
                
                // Update help text
                const helpText = document.querySelector('.departments-help');
                if (helpText) {
                    if (selected === 0) {
                        helpText.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban';
                        helpText.className = 'text-warning small mt-2 departments-help';
                    } else {
                        helpText.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>ƒê√£ ch·ªçn ${selected} ph√≤ng ban`;
                        helpText.className = 'text-success small mt-2 departments-help';
                    }
                }
            };
            
            departmentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDepartmentCounter();
                    
                    // Add visual feedback to the department card
                    const card = this.closest('.department-check');
                    if (this.checked) {
                        card.style.background = 'linear-gradient(135deg, #e8f5e8, #f0f8f0)';
                        card.style.borderColor = '#28a745';
                        card.style.transform = 'translateY(-2px)';
                    } else {
                        card.style.background = '';
                        card.style.borderColor = '';
                        card.style.transform = '';
                    }
                });
            });
            updateDepartmentCounter();

            // Form submission enhancement
            const form = document.querySelector('.course-edit-form');
            const submitBtn = document.querySelector('.btn-save');
            
            if (form && submitBtn) {
                form.addEventListener('submit', function(e) {
                    // Show loading state
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang l∆∞u...';
                    submitBtn.disabled = true;
                    
                    // Validate department selection
                    const selectedDepts = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked').length;
                    if (selectedDepts === 0) {
                        e.preventDefault();
                        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban ƒë·ªÉ √°p d·ª•ng kh√≥a h·ªçc!');
                        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi';
                        submitBtn.disabled = false;
                        return false;
                    }
                    
                    // Add a small delay to show the loading state
                    setTimeout(() => {
                        // Form will be submitted
                    }, 500);
                });
            }

            // Enhanced form validation feedback
            const inputs = document.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    }
                });

                input.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
            });

            // Level selection with visual feedback
            const levelSelect = document.querySelector('#Level');
            if (levelSelect) {
                levelSelect.addEventListener('change', function() {
                    const value = this.value.toLowerCase();
                    let color = '#6c757d';
                    
                    switch(value) {
                        case 'c∆° b·∫£n':
                            color = '#28a745';
                            break;
                        case 'trung c·∫•p':
                            color = '#ffc107';
                            break;
                        case 'n√¢ng cao':
                            color = '#dc3545';
                            break;
                    }
                    
                    this.style.borderColor = color;
                    this.style.boxShadow = `0 0 0 0.2rem ${color}25`;
                    
                    setTimeout(() => {
                        this.style.borderColor = '';
                        this.style.boxShadow = '';
                    }, 2000);
                });
            }

            // Status toggle enhancement
            const statusToggle = document.querySelector('#IsActive');
            if (statusToggle) {
                statusToggle.addEventListener('change', function() {
                    const label = this.nextElementSibling.querySelector('span');
                    if (this.checked) {
                        label.textContent = 'Kh√≥a h·ªçc ƒëang ho·∫°t ƒë·ªông';
                        label.className = 'fw-semibold text-success';
                    } else {
                        label.textContent = 'Kh√≥a h·ªçc t·∫°m d·ª´ng';
                        label.className = 'fw-semibold text-warning';
                    }
                });
            }
        });
    </script>
}