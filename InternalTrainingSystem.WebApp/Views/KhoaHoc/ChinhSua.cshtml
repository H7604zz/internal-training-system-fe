@model InternalTrainingSystem.WebApp.Models.DTOs.CourseDto
@{
    ViewData["Title"] = "Ch·ªânh S·ª≠a Kh√≥a H·ªçc";
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
}

<div class="course-container">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="form-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="header-content">
                        <h1 class="form-title">
                            <i class="fas fa-edit me-3"></i>Ch·ªânh S·ª≠a Kh√≥a H·ªçc
                        </h1>
                        <p class="form-subtitle">
                            <i class="fas fa-info-circle me-2"></i>
                            C·∫≠p nh·∫≠t th√¥ng tin kh√≥a h·ªçc ƒë√†o t·∫°o n·ªôi b·ªô
                        </p>
                        <div class="course-meta-inline mt-3">
                            <span class="meta-item">
                                <i class="fas fa-code"></i>
                                <span>@Model.Code</span>
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-calendar-plus"></i>
                                <span>@(Model.CreatedDate.ToString("dd/MM/yyyy"))</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="action-buttons">
                        <a href="@Url.Action("ChiTiet", new { id = Model.CourseId })" class="btn btn-back">
                            <i class="fas fa-arrow-left me-2"></i>Quay L·∫°i
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <form method="post" asp-action="ChinhSua" class="course-edit-form">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="CourseId" />
            <input type="hidden" asp-for="CreatedDate" />

            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8 mb-4">
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-info-circle me-2"></i>Th√¥ng Tin C∆° B·∫£n
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="CourseName" class="form-label required">
                                    <i class="fas fa-graduation-cap me-1"></i>T√™n kh√≥a h·ªçc
                                </label>
                                <input asp-for="CourseName" class="form-control" 
                                       placeholder="Nh·∫≠p t√™n kh√≥a h·ªçc (VD: Kh√≥a h·ªçc l·∫≠p tr√¨nh C#)">
                                <span asp-validation-for="CourseName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Code" class="form-label required">
                                    <i class="fas fa-barcode me-1"></i>M√£ kh√≥a h·ªçc
                                </label>
                                <input asp-for="Code" class="form-control" 
                                       placeholder="VD: IT-001">
                                <span asp-validation-for="Code" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>M√¥ t·∫£ kh√≥a h·ªçc
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                                      placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ n·ªôi dung, m·ª•c ti√™u v√† l·ª£i √≠ch c·ªßa kh√≥a h·ªçc..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                M√¥ t·∫£ n√™n bao g·ªìm m·ª•c ti√™u h·ªçc t·∫≠p, n·ªôi dung ch√≠nh v√† ƒë·ªëi t∆∞·ª£ng h·ªçc vi√™n
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Category" class="form-label required">
                                    <i class="fas fa-folder me-1"></i>Danh m·ª•c
                                </label>
                                <select asp-for="Category" class="form-select">
                                    <option value="">-- Ch·ªçn danh m·ª•c kh√≥a h·ªçc --</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (dynamic category in ViewBag.Categories)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="Category" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Level" class="form-label required">
                                    <i class="fas fa-layer-group me-1"></i>C·∫•p ƒë·ªô
                                </label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">-- Ch·ªçn c·∫•p ƒë·ªô --</option>
                                    <option value="C∆° b·∫£n">üü¢ C∆° b·∫£n</option>
                                    <option value="Trung c·∫•p">üü° Trung c·∫•p</option>
                                    <option value="N√¢ng cao">üî¥ N√¢ng cao</option>
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Duration" class="form-label required">
                                    <i class="fas fa-stopwatch me-1"></i>Th·ªùi l∆∞·ª£ng (gi·ªù)
                                </label>
                                <input asp-for="Duration" type="number" class="form-control" min="1" max="500"
                                       placeholder="VD: 40">
                                <span asp-validation-for="Duration" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    T·ªïng th·ªùi gian h·ªçc bao g·ªìm l√Ω thuy·∫øt v√† th·ª±c h√†nh
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>Tr·∫°ng th√°i ho·∫°t ƒë·ªông
                                </label>
                                <div class="form-check form-switch mt-2">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" role="switch">
                                    <label asp-for="IsActive" class="form-check-label">
                                        <span class="fw-semibold">Kh√≥a h·ªçc ƒëang ho·∫°t ƒë·ªông</span>
                                        <br>
                                        <small class="text-muted">Cho ph√©p t·∫°o l·ªõp h·ªçc v√† ƒëƒÉng k√Ω m·ªõi</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Department Selection -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-building me-2"></i>Ph√≤ng Ban √Åp D·ª•ng
                        </h3>
                        <div class="form-help-text">
                            <i class="fas fa-info-circle me-2"></i>
                            Ch·ªçn c√°c ph√≤ng ban m√† kh√≥a h·ªçc n√†y s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng. Nh√¢n vi√™n thu·ªôc c√°c ph√≤ng ban ƒë∆∞·ª£c ch·ªçn s·∫Ω c√≥ th·ªÉ ƒëƒÉng k√Ω tham gia kh√≥a h·ªçc.
                        </div>
                        
                        <div class="departments-selection">
                            @if (ViewBag.Departments != null)
                            {
                                @foreach (var dept in ViewBag.Departments)
                                {
                                    <div class="form-check department-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="SelectedDepartmentIds" value="@dept.Id" 
                                               id="dept_@dept.Id"
                                               checked="@(Model.Departments?.Any(d => d.Id == dept.Id) == true)">
                                        <label class="form-check-label" for="dept_@dept.Id">
                                            <i class="fas fa-building me-2"></i>
                                            <span class="fw-semibold">@dept.Name</span>
                                            <br>
                                            <small class="text-muted">Ph√≤ng ban trong t·ªï ch·ª©c</small>
                                        </label>
                                    </div>
                                }
                                
                                <div class="departments-help text-info small mt-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span class="department-counter">@(Model.Departments?.Count ?? 0) ph√≤ng ban ƒë∆∞·ª£c ch·ªçn</span>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Kh√¥ng c√≥ d·ªØ li·ªáu ph√≤ng ban. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n.
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Course Content Section -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-book me-2"></i>N·ªôi Dung Kh√≥a H·ªçc
                        </h3>
                        <p class="form-help-text">Qu·∫£n l√Ω c√°c module v√† b√†i h·ªçc cho kh√≥a h·ªçc</p>

                        <!-- Existing Modules Container -->
                        <div id="existing-modules-container">
                            <!-- Module 1 - Existing with sample data -->
                            <div class="module-item mb-4" data-module-index="0">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-folder me-2"></i>Module <span class="module-number">1</span>
                                        </h5>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary move-up-module" title="Di chuy·ªÉn l√™n">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary move-down-module" title="Di chuy·ªÉn xu·ªëng">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-module" title="X√≥a module">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label required">T√™n Module</label>
                                                <input type="text" name="Modules[0].ModuleName" class="form-control" 
                                                       value="Gi·ªõi thi·ªáu v·ªÅ L·∫≠p tr√¨nh Web" placeholder="Nh·∫≠p t√™n module">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label required">Th·ª© t·ª±</label>
                                                <input type="number" name="Modules[0].Order" class="form-control module-order" min="1" value="1" readonly>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">M√¥ t·∫£ Module</label>
                                            <textarea name="Modules[0].Description" class="form-control" rows="2" 
                                                      placeholder="Nh·∫≠p m√¥ t·∫£ module...">T√¨m hi·ªÉu c√°c kh√°i ni·ªám c∆° b·∫£n v·ªÅ ph√°t tri·ªÉn web, HTML, CSS v√† JavaScript</textarea>
                                        </div>

                                        <!-- Lessons Section -->
                                        <div class="lessons-section">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6><i class="fas fa-play-circle me-2"></i>B√†i H·ªçc</h6>
                                                <button type="button" class="btn btn-sm btn-outline-primary add-lesson-btn">
                                                    <i class="fas fa-plus me-1"></i>Th√™m B√†i H·ªçc
                                                </button>
                                            </div>
                                            <div class="lessons-container">
                                                <!-- Existing Lesson 1 -->
                                                <div class="lesson-item mb-3" data-lesson-index="0">
                                                    <div class="card border-start border-primary border-3">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                                <h6 class="card-title mb-0">
                                                                    <i class="fas fa-play me-2"></i>B√†i h·ªçc <span class="lesson-number">1</span>
                                                                </h6>
                                                                <div>
                                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-up-lesson" title="Di chuy·ªÉn l√™n">
                                                                        <i class="fas fa-arrow-up"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-down-lesson" title="Di chuy·ªÉn xu·ªëng">
                                                                        <i class="fas fa-arrow-down"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-lesson" title="X√≥a b√†i h·ªçc">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-8">
                                                                    <label class="form-label required">T√™n B√†i H·ªçc</label>
                                                                    <input type="text" name="Modules[0].Lessons[0].LessonName" class="form-control" 
                                                                           value="HTML c∆° b·∫£n" placeholder="Nh·∫≠p t√™n b√†i h·ªçc">
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="form-label required">Th·ª© t·ª±</label>
                                                                    <input type="number" name="Modules[0].Lessons[0].Order" class="form-control lesson-order" min="1" value="1" readonly>
                                                                </div>
                                                            </div>

                                                            <div class="mb-3">
                                                                <label class="form-label">N·ªôi dung h·ªçc hi·ªán t·∫°i</label>
                                                                <div class="current-content-info">
                                                                    <div class="alert alert-info">
                                                                        <i class="fas fa-video me-2"></i>
                                                                        <strong>video_html_basics.mp4</strong> (45 ph√∫t)
                                                                        <a href="#" class="btn btn-sm btn-outline-primary ms-2">
                                                                            <i class="fas fa-eye me-1"></i>Xem
                                                                        </a>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2">
                                                                            <i class="fas fa-trash me-1"></i>X√≥a
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                
                                                                <label class="form-label mt-3">Thay ƒë·ªïi n·ªôi dung</label>
                                                                <div class="content-upload-area">
                                                                    <div class="upload-tabs mb-3">
                                                                        <div class="btn-group" role="group">
                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-0" id="video-0-0" value="video">
                                                                            <label class="btn btn-outline-primary" for="video-0-0">
                                                                                <i class="fas fa-video me-1"></i>Video
                                                                            </label>

                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-0" id="pdf-0-0" value="pdf">
                                                                            <label class="btn btn-outline-primary" for="pdf-0-0">
                                                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                                                            </label>

                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-0" id="image-0-0" value="image">
                                                                            <label class="btn btn-outline-primary" for="image-0-0">
                                                                                <i class="fas fa-image me-1"></i>H√¨nh ·∫£nh
                                                                            </label>

                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-0" id="document-0-0" value="document">
                                                                            <label class="btn btn-outline-primary" for="document-0-0">
                                                                                <i class="fas fa-file-alt me-1"></i>T√†i li·ªáu
                                                                            </label>
                                                                        </div>
                                                                    </div>

                                                                    <div class="file-upload-container">
                                                                        <div class="file-upload-area">
                                                                            <input type="file" name="Modules[0].Lessons[0].ContentFile" class="form-control content-file-input" accept="">
                                                                            <div class="upload-placeholder text-center p-4">
                                                                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                                                                <p class="text-muted mb-0">Ch·ªçn lo·∫°i n·ªôi dung v√† t·∫£i l√™n t·ªáp m·ªõi</p>
                                                                                <small class="text-muted">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Existing Lesson 2 -->
                                                <div class="lesson-item mb-3" data-lesson-index="1">
                                                    <div class="card border-start border-primary border-3">
                                                        <div class="card-body">
                                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                                <h6 class="card-title mb-0">
                                                                    <i class="fas fa-play me-2"></i>B√†i h·ªçc <span class="lesson-number">2</span>
                                                                </h6>
                                                                <div>
                                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-up-lesson" title="Di chuy·ªÉn l√™n">
                                                                        <i class="fas fa-arrow-up"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-down-lesson" title="Di chuy·ªÉn xu·ªëng">
                                                                        <i class="fas fa-arrow-down"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-lesson" title="X√≥a b√†i h·ªçc">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-8">
                                                                    <label class="form-label required">T√™n B√†i H·ªçc</label>
                                                                    <input type="text" name="Modules[0].Lessons[1].LessonName" class="form-control" 
                                                                           value="CSS Styling" placeholder="Nh·∫≠p t√™n b√†i h·ªçc">
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="form-label required">Th·ª© t·ª±</label>
                                                                    <input type="number" name="Modules[0].Lessons[1].Order" class="form-control lesson-order" min="1" value="2" readonly>
                                                                </div>
                                                            </div>

                                                            <div class="mb-3">
                                                                <label class="form-label">N·ªôi dung h·ªçc hi·ªán t·∫°i</label>
                                                                <div class="current-content-info">
                                                                    <div class="alert alert-warning">
                                                                        <i class="fas fa-file-pdf me-2"></i>
                                                                        <strong>css_styling_guide.pdf</strong> (20 trang)
                                                                        <a href="#" class="btn btn-sm btn-outline-primary ms-2">
                                                                            <i class="fas fa-eye me-1"></i>Xem
                                                                        </a>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2">
                                                                            <i class="fas fa-trash me-1"></i>X√≥a
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                
                                                                <label class="form-label mt-3">Thay ƒë·ªïi n·ªôi dung</label>
                                                                <div class="content-upload-area">
                                                                    <div class="upload-tabs mb-3">
                                                                        <div class="btn-group" role="group">
                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-1" id="video-0-1" value="video">
                                                                            <label class="btn btn-outline-primary" for="video-0-1">
                                                                                <i class="fas fa-video me-1"></i>Video
                                                                            </label>

                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-1" id="pdf-0-1" value="pdf">
                                                                            <label class="btn btn-outline-primary" for="pdf-0-1">
                                                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                                                            </label>

                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-1" id="image-0-1" value="image">
                                                                            <label class="btn btn-outline-primary" for="image-0-1">
                                                                                <i class="fas fa-image me-1"></i>H√¨nh ·∫£nh
                                                                            </label>

                                                                            <input type="radio" class="btn-check content-type" name="content-type-0-1" id="document-0-1" value="document">
                                                                            <label class="btn btn-outline-primary" for="document-0-1">
                                                                                <i class="fas fa-file-alt me-1"></i>T√†i li·ªáu
                                                                            </label>
                                                                        </div>
                                                                    </div>

                                                                    <div class="file-upload-container">
                                                                        <div class="file-upload-area">
                                                                            <input type="file" name="Modules[0].Lessons[1].ContentFile" class="form-control content-file-input" accept="">
                                                                            <div class="upload-placeholder text-center p-4">
                                                                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                                                                <p class="text-muted mb-0">Ch·ªçn lo·∫°i n·ªôi dung v√† t·∫£i l√™n t·ªáp m·ªõi</p>
                                                                                <small class="text-muted">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi</small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- New Modules Container -->
                        <div id="modules-container">
                            <!-- New modules will be added here -->
                        </div>

                        <button type="button" class="btn btn-outline-primary mt-3" id="add-module-btn">
                            <i class="fas fa-plus me-2"></i>Th√™m Module M·ªõi
                        </button>
                    </div>
                </div>

                <!-- Side Panel -->
                <div class="col-lg-4 mb-4">
                    <!-- Form Actions -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi
                        </h3>
                        
                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi
                            </button>
                            <a href="@Url.Action("ChiTiet", new { id = Model.CourseId })" 
                               class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>H·ªßy B·ªè
                            </a>
                        </div>
                        
                        <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>L∆∞u √Ω:</strong> C√°c thay ƒë·ªïi s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng ngay l·∫≠p t·ª©c v√† c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c l·ªõp h·ªçc ƒëang di·ªÖn ra.
                            </small>
                        </div>
                    </div>

                    <!-- Course Status -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-chart-pie me-2"></i>Tr·∫°ng Th√°i Kh√≥a H·ªçc
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-check-circle text-success"></i>
                                <span>
                                    <strong>ƒê√£ t·∫°o:</strong><br>
                                    <small class="text-muted">@(Model.CreatedDate.ToString("dd/MM/yyyy HH:mm"))</small>
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-@(Model.IsActive ? "play-circle text-success" : "pause-circle text-warning")"></i>
                                <span>
                                    <strong>Tr·∫°ng th√°i:</strong><br>
                                    <small class="text-muted">@(Model.IsActive ? "ƒêang ho·∫°t ƒë·ªông" : "T·∫°m d·ª´ng")</small>
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-users text-info"></i>
                                <span>
                                    <strong>Ph√≤ng ban:</strong><br>
                                    <small class="text-muted">@(Model.Departments?.Count ?? 0) ph√≤ng ban ƒë∆∞·ª£c ch·ªçn</small>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Form Help -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-question-circle me-2"></i>H∆∞·ªõng D·∫´n Ch·ªânh S·ª≠a
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>T√™n kh√≥a h·ªçc:</strong> N√™n ng·∫Øn g·ªçn, d·ªÖ hi·ªÉu v√† ph·∫£n √°nh ƒë√∫ng n·ªôi dung
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>M√£ kh√≥a h·ªçc:</strong> Theo ƒë·ªãnh d·∫°ng chu·∫©n: ABC-123 (kh√¥ng ƒë∆∞·ª£c tr√πng)
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>C·∫•p ƒë·ªô:</strong> Ch·ªçn ph√π h·ª£p v·ªõi ƒë·ªô kh√≥ v√† ki·∫øn th·ª©c y√™u c·∫ßu
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Th·ªùi l∆∞·ª£ng:</strong> T√≠nh theo gi·ªù h·ªçc th·ª±c t·∫ø (bao g·ªìm l√Ω thuy·∫øt + th·ª±c h√†nh)
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Ph√≤ng ban:</strong> Ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban ƒë·ªÉ nh√¢n vi√™n c√≥ th·ªÉ ƒëƒÉng k√Ω
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Hidden Templates -->
        <div id="module-template" style="display: none;">
            <div class="module-item mb-4" data-module-index="">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-folder me-2"></i>Module <span class="module-number"></span>
                        </h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-secondary move-up-module" title="Di chuy·ªÉn l√™n">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary move-down-module" title="Di chuy·ªÉn xu·ªëng">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-module" title="X√≥a module">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label required">T√™n Module</label>
                                <input type="text" name="Modules[].ModuleName" class="form-control" placeholder="Nh·∫≠p t√™n module">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">Th·ª© t·ª±</label>
                                <input type="number" name="Modules[].Order" class="form-control module-order" min="1" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√¥ t·∫£ Module</label>
                            <textarea name="Modules[].Description" class="form-control" rows="2" placeholder="Nh·∫≠p m√¥ t·∫£ module..."></textarea>
                        </div>

                        <!-- Lessons Section -->
                        <div class="lessons-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6><i class="fas fa-play-circle me-2"></i>B√†i H·ªçc</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary add-lesson-btn">
                                    <i class="fas fa-plus me-1"></i>Th√™m B√†i H·ªçc
                                </button>
                            </div>
                            <div class="lessons-container">
                                <!-- Lessons will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="lesson-template" style="display: none;">
            <div class="lesson-item mb-3" data-lesson-index="">
                <div class="card border-start border-primary border-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-play me-2"></i>B√†i h·ªçc <span class="lesson-number"></span>
                            </h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary move-up-lesson" title="Di chuy·ªÉn l√™n">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary move-down-lesson" title="Di chuy·ªÉn xu·ªëng">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-lesson" title="X√≥a b√†i h·ªçc">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label required">T√™n B√†i H·ªçc</label>
                                <input type="text" name="Modules[].Lessons[].LessonName" class="form-control" placeholder="Nh·∫≠p t√™n b√†i h·ªçc">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">Th·ª© t·ª±</label>
                                <input type="number" name="Modules[].Lessons[].Order" class="form-control lesson-order" min="1" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">N·ªôi dung h·ªçc</label>
                            <div class="content-upload-area">
                                <div class="upload-tabs mb-3">
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check content-type" name="content-type-" id="video-" value="video">
                                        <label class="btn btn-outline-primary" for="video-">
                                            <i class="fas fa-video me-1"></i>Video
                                        </label>

                                        <input type="radio" class="btn-check content-type" name="content-type-" id="pdf-" value="pdf">
                                        <label class="btn btn-outline-primary" for="pdf-">
                                            <i class="fas fa-file-pdf me-1"></i>PDF
                                        </label>

                                        <input type="radio" class="btn-check content-type" name="content-type-" id="image-" value="image">
                                        <label class="btn btn-outline-primary" for="image-">
                                            <i class="fas fa-image me-1"></i>H√¨nh ·∫£nh
                                        </label>

                                        <input type="radio" class="btn-check content-type" name="content-type-" id="document-" value="document">
                                        <label class="btn btn-outline-primary" for="document-">
                                            <i class="fas fa-file-alt me-1"></i>T√†i li·ªáu
                                        </label>
                                    </div>
                                </div>

                                <div class="file-upload-container">
                                    <div class="file-upload-area">
                                        <input type="file" name="Modules[].Lessons[].ContentFile" class="form-control content-file-input" accept="">
                                        <div class="upload-placeholder text-center p-4">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Ch·ªçn lo·∫°i n·ªôi dung v√† t·∫£i l√™n t·ªáp</p>
                                            <small class="text-muted">H·ªó tr·ª£: Video (MP4), PDF, H√¨nh ·∫£nh (JPG, PNG), T√†i li·ªáu (DOCX, PPTX)</small>
                                        </div>
                                    </div>
                                    <div class="file-info mt-2" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-file me-2"></i>
                                            <span class="file-name"></span>
                                            <span class="file-size text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Form validation and interactions
        document.addEventListener('DOMContentLoaded', function() {
            let moduleIndex = 1; // Start from 1 since we have existing module at index 0

            // Auto-generate course code from name
            const courseNameInput = document.querySelector('#CourseName');
            const courseCodeInput = document.querySelector('#Code');
            
            if (courseNameInput && courseCodeInput && !courseCodeInput.value) {
                courseNameInput.addEventListener('blur', function() {
                    if (!courseCodeInput.value && this.value) {
                        // Generate simple code from name
                        const words = this.value.split(' ').slice(0, 2);
                        const code = words.map(word => word.charAt(0).toUpperCase()).join('') + 
                                   '-' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0');
                        courseCodeInput.value = code;
                        
                        // Add visual feedback
                        courseCodeInput.style.background = '#e8f5e8';
                        setTimeout(() => {
                            courseCodeInput.style.background = '';
                        }, 1000);
                    }
                });
            }

            // Module and Lesson Management
            const modulesContainer = document.getElementById('modules-container');
            const addModuleBtn = document.getElementById('add-module-btn');
            const moduleTemplate = document.getElementById('module-template');
            const lessonTemplate = document.getElementById('lesson-template');

            // Add event listeners to existing lessons
            initializeExistingContent();

            // Add Module
            addModuleBtn.addEventListener('click', function() {
                addModule();
            });

            function initializeExistingContent() {
                // Add event listeners to existing modules and lessons
                const existingModules = document.querySelectorAll('#existing-modules-container .module-item');
                existingModules.forEach(moduleItem => {
                    addModuleEventListeners(moduleItem);
                });
            }

            function addModule() {
                const moduleHtml = moduleTemplate.innerHTML;
                const moduleDiv = document.createElement('div');
                moduleDiv.innerHTML = moduleHtml;
                const moduleItem = moduleDiv.firstElementChild;
                
                moduleIndex++;
                moduleItem.setAttribute('data-module-index', moduleIndex - 1);
                
                // Update module number and form names
                updateModuleIndexes(moduleItem, moduleIndex - 1);
                
                modulesContainer.appendChild(moduleItem);
                
                // Add event listeners
                addModuleEventListeners(moduleItem);
                
                // Update all module orders
                updateAllModuleOrders();
            }

            function addModuleEventListeners(moduleItem) {
                // Remove module
                const removeBtn = moduleItem.querySelector('.remove-module');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a module n√†y v√† t·∫•t c·∫£ b√†i h·ªçc trong ƒë√≥?')) {
                            moduleItem.remove();
                            updateAllModuleOrders();
                        }
                    });
                }

                // Move module up/down
                const moveUpBtn = moduleItem.querySelector('.move-up-module');
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', function() {
                        const prev = moduleItem.previousElementSibling;
                        if (prev) {
                            moduleItem.parentNode.insertBefore(moduleItem, prev);
                            updateAllModuleOrders();
                        }
                    });
                }

                const moveDownBtn = moduleItem.querySelector('.move-down-module');
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', function() {
                        const next = moduleItem.nextElementSibling;
                        if (next) {
                            moduleItem.parentNode.insertBefore(next, moduleItem);
                            updateAllModuleOrders();
                        }
                    });
                }

                // Add lesson
                const addLessonBtn = moduleItem.querySelector('.add-lesson-btn');
                if (addLessonBtn) {
                    addLessonBtn.addEventListener('click', function() {
                        addLesson(moduleItem);
                    });
                }

                // Add event listeners to existing lessons in this module
                const existingLessons = moduleItem.querySelectorAll('.lesson-item');
                existingLessons.forEach(lessonItem => {
                    addLessonEventListeners(lessonItem, moduleItem);
                });
            }

            function addLesson(moduleItem) {
                const lessonHtml = lessonTemplate.innerHTML;
                const lessonDiv = document.createElement('div');
                lessonDiv.innerHTML = lessonHtml;
                const lessonItem = lessonDiv.firstElementChild;
                
                const lessonsContainer = moduleItem.querySelector('.lessons-container');
                const moduleIndex = moduleItem.getAttribute('data-module-index');
                const lessonIndex = lessonsContainer.children.length;
                
                lessonItem.setAttribute('data-lesson-index', lessonIndex);
                
                // Update lesson form names and IDs
                updateLessonIndexes(lessonItem, moduleIndex, lessonIndex);
                
                lessonsContainer.appendChild(lessonItem);
                
                // Add event listeners
                addLessonEventListeners(lessonItem, moduleItem);
                
                // Update lesson orders in this module
                updateLessonOrders(moduleItem);
            }

            function addLessonEventListeners(lessonItem, moduleItem) {
                const lessonsContainer = moduleItem.querySelector('.lessons-container');

                // Remove lesson
                const removeBtn = lessonItem.querySelector('.remove-lesson');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc n√†y?')) {
                            lessonItem.remove();
                            updateLessonOrders(moduleItem);
                        }
                    });
                }

                // Move lesson up/down
                const moveUpBtn = lessonItem.querySelector('.move-up-lesson');
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', function() {
                        const prev = lessonItem.previousElementSibling;
                        if (prev) {
                            lessonsContainer.insertBefore(lessonItem, prev);
                            updateLessonOrders(moduleItem);
                        }
                    });
                }

                const moveDownBtn = lessonItem.querySelector('.move-down-lesson');
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', function() {
                        const next = lessonItem.nextElementSibling;
                        if (next) {
                            lessonsContainer.insertBefore(next, lessonItem);
                            updateLessonOrders(moduleItem);
                        }
                    });
                }

                // Content type change
                const contentTypeInputs = lessonItem.querySelectorAll('.content-type');
                const fileInput = lessonItem.querySelector('.content-file-input');
                
                contentTypeInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        updateFileInputAccept(lessonItem, this.value);
                    });
                });

                // File upload
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        handleFileUpload(lessonItem, this);
                    });
                }
            }

            function updateModuleIndexes(moduleItem, index) {
                // Update module number display
                const moduleNumber = moduleItem.querySelector('.module-number');
                if (moduleNumber) moduleNumber.textContent = index + 1;
                
                // Update form field names
                const inputs = moduleItem.querySelectorAll('input[name^="Modules["], textarea[name^="Modules["]');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name.replace(/Modules\[\d*\]/, `Modules[${index}]`);
                        input.setAttribute('name', newName);
                    }
                });

                // Update module order value
                const orderInput = moduleItem.querySelector('.module-order');
                if (orderInput) orderInput.value = index + 1;
            }

            function updateLessonIndexes(lessonItem, moduleIndex, lessonIndex) {
                // Update lesson number display
                const lessonNumber = lessonItem.querySelector('.lesson-number');
                if (lessonNumber) lessonNumber.textContent = lessonIndex + 1;
                
                // Update form field names and IDs
                const inputs = lessonItem.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes('Modules[].Lessons[]')) {
                        const newName = name.replace('Modules[].Lessons[]', `Modules[${moduleIndex}].Lessons[${lessonIndex}]`);
                        input.setAttribute('name', newName);
                    }

                    const id = input.getAttribute('id');
                    if (id && (id.includes('-') && id.endsWith('-'))) {
                        const newId = id.replace('-', `-${moduleIndex}-${lessonIndex}-`);
                        input.setAttribute('id', newId);
                        
                        // Update corresponding label
                        const label = lessonItem.querySelector(`label[for="${id}"]`);
                        if (label) {
                            label.setAttribute('for', newId);
                        }
                    }

                    const radioName = input.getAttribute('name');
                    if (radioName && radioName.includes('content-type-')) {
                        const newRadioName = `content-type-${moduleIndex}-${lessonIndex}`;
                        input.setAttribute('name', newRadioName);
                    }
                });

                // Update lesson order value
                const orderInput = lessonItem.querySelector('.lesson-order');
                if (orderInput) orderInput.value = lessonIndex + 1;
            }

            function updateAllModuleOrders() {
                // Update existing modules
                const existingModules = document.querySelectorAll('#existing-modules-container .module-item');
                existingModules.forEach((moduleItem, index) => {
                    moduleItem.setAttribute('data-module-index', index);
                    updateModuleIndexes(moduleItem, index);
                    
                    // Update all lessons in this module
                    const lessonItems = moduleItem.querySelectorAll('.lesson-item');
                    lessonItems.forEach((lessonItem, lessonIndex) => {
                        updateLessonIndexes(lessonItem, index, lessonIndex);
                    });
                });

                // Update new modules
                const newModules = modulesContainer.querySelectorAll('.module-item');
                newModules.forEach((moduleItem, index) => {
                    const actualIndex = existingModules.length + index;
                    moduleItem.setAttribute('data-module-index', actualIndex);
                    updateModuleIndexes(moduleItem, actualIndex);
                    
                    // Update all lessons in this module
                    const lessonItems = moduleItem.querySelectorAll('.lesson-item');
                    lessonItems.forEach((lessonItem, lessonIndex) => {
                        updateLessonIndexes(lessonItem, actualIndex, lessonIndex);
                    });
                });
            }

            function updateLessonOrders(moduleItem) {
                const lessonItems = moduleItem.querySelectorAll('.lesson-item');
                const moduleIndex = moduleItem.getAttribute('data-module-index');
                
                lessonItems.forEach((lessonItem, index) => {
                    lessonItem.setAttribute('data-lesson-index', index);
                    updateLessonIndexes(lessonItem, moduleIndex, index);
                });
            }

            function updateFileInputAccept(lessonItem, contentType) {
                const fileInput = lessonItem.querySelector('.content-file-input');
                const acceptTypes = {
                    'video': '.mp4,.avi,.mov,.wmv',
                    'pdf': '.pdf',
                    'image': '.jpg,.jpeg,.png,.gif,.bmp',
                    'document': '.doc,.docx,.ppt,.pptx,.txt'
                };
                
                if (fileInput) {
                    fileInput.setAttribute('accept', acceptTypes[contentType] || '');
                }
            }

            function handleFileUpload(lessonItem, fileInput) {
                const fileInfo = lessonItem.querySelector('.file-info');
                const fileName = lessonItem.querySelector('.file-name');
                const fileSize = lessonItem.querySelector('.file-size');
                
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    if (fileName) fileName.textContent = file.name;
                    if (fileSize) fileSize.textContent = `(${formatFileSize(file.size)})`;
                    if (fileInfo) fileInfo.style.display = 'block';
                } else {
                    if (fileInfo) fileInfo.style.display = 'none';
                }
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Department selection counter and feedback
            const departmentCheckboxes = document.querySelectorAll('input[name="SelectedDepartmentIds"]');
            const updateDepartmentCounter = () => {
                const selected = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked').length;
                const counterElement = document.querySelector('.department-counter');
                if (counterElement) {
                    counterElement.textContent = `${selected} ph√≤ng ban ƒë∆∞·ª£c ch·ªçn`;
                }
                
                // Update help text
                const helpText = document.querySelector('.departments-help');
                if (helpText) {
                    if (selected === 0) {
                        helpText.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban';
                        helpText.className = 'text-warning small mt-2 departments-help';
                    } else {
                        helpText.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>ƒê√£ ch·ªçn ${selected} ph√≤ng ban`;
                        helpText.className = 'text-success small mt-2 departments-help';
                    }
                }
            };
            
            departmentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDepartmentCounter();
                    
                    // Add visual feedback to the department card
                    const card = this.closest('.department-check');
                    if (this.checked) {
                        card.style.background = 'linear-gradient(135deg, #e8f5e8, #f0f8f0)';
                        card.style.borderColor = '#28a745';
                        card.style.transform = 'translateY(-2px)';
                    } else {
                        card.style.background = '';
                        card.style.borderColor = '';
                        card.style.transform = '';
                    }
                });
            });
            updateDepartmentCounter();

            // Form submission enhancement
            const form = document.querySelector('.course-edit-form');
            const submitBtn = document.querySelector('.btn-save');
            
            if (form && submitBtn) {
                form.addEventListener('submit', function(e) {
                    // Show loading state
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang l∆∞u...';
                    submitBtn.disabled = true;
                    
                    // Validate department selection
                    const selectedDepts = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked').length;
                    if (selectedDepts === 0) {
                        e.preventDefault();
                        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ph√≤ng ban ƒë·ªÉ √°p d·ª•ng kh√≥a h·ªçc!');
                        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>L∆∞u Thay ƒê·ªïi';
                        submitBtn.disabled = false;
                        return false;
                    }
                    
                    // Add a small delay to show the loading state
                    setTimeout(() => {
                        // Form will be submitted
                    }, 500);
                });
            }

            // Enhanced form validation feedback
            const inputs = document.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    }
                });

                input.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
            });

            // Level selection with visual feedback
            const levelSelect = document.querySelector('#Level');
            if (levelSelect) {
                levelSelect.addEventListener('change', function() {
                    const value = this.value.toLowerCase();
                    let color = '#6c757d';
                    
                    switch(value) {
                        case 'c∆° b·∫£n':
                            color = '#28a745';
                            break;
                        case 'trung c·∫•p':
                            color = '#ffc107';
                            break;
                        case 'n√¢ng cao':
                            color = '#dc3545';
                            break;
                    }
                    
                    this.style.borderColor = color;
                    this.style.boxShadow = `0 0 0 0.2rem ${color}25`;
                    
                    setTimeout(() => {
                        this.style.borderColor = '';
                        this.style.boxShadow = '';
                    }, 2000);
                });
            }

            // Status toggle enhancement
            const statusToggle = document.querySelector('#IsActive');
            if (statusToggle) {
                statusToggle.addEventListener('change', function() {
                    const label = this.nextElementSibling.querySelector('span');
                    if (this.checked) {
                        label.textContent = 'Kh√≥a h·ªçc ƒëang ho·∫°t ƒë·ªông';
                        label.className = 'fw-semibold text-success';
                    } else {
                        label.textContent = 'Kh√≥a h·ªçc t·∫°m d·ª´ng';
                        label.className = 'fw-semibold text-warning';
                    }
                });
            }
        });
    </script>
}