@model InternalTrainingSystem.WebApp.Models.DTOs.CourseDto
@using InternalTrainingSystem.WebApp.Constants
@using InternalTrainingSystem.WebApp.Extensions
@using InternalTrainingSystem.WebApp.Models.DTOs
@{
    ViewData["Title"] = "Chỉnh Sửa Khóa Học";
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tao-moi-khoa-hoc.css" asp-append-version="true" />
}

<div class="course-container">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="form-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="header-content">
                        <h1 class="form-title">
                            <i class="fas fa-edit me-3"></i>Chỉnh Sửa Khóa Học
                        </h1>
                        <p class="form-subtitle">
                            <i class="fas fa-info-circle me-2"></i>
                            Cập nhật thông tin khóa học đào tạo nội bộ
                        </p>
                        <div class="course-meta-inline mt-3">
                            <span class="meta-item">
                                <i class="fas fa-code"></i>
                                <span>@Model.Code</span>
                            </span>
                            <span class="meta-item">
                                <i class="fas fa-calendar-plus"></i>
                                <span>@(Model.CreatedDate.ToString("dd/MM/yyyy"))</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end mt-3 mt-md-0">
                    <div class="action-buttons">
                        <a href="@Url.Action("ChiTiet", new { id = Model.CourseId })" class="btn btn-back">
                            <i class="fas fa-arrow-left me-2"></i>Quay Lại
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Form -->
        <form method="post" asp-action="ChinhSua" asp-route-id="@Model.CourseId" enctype="multipart/form-data" class="course-edit-form">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="CourseId" />
            <input type="hidden" asp-for="CreatedDate" />
            <input type="hidden" name="metadata" id="metadata-input" />

            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8 mb-4">
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-info-circle me-2"></i>Thông Tin Cơ Bản
                        </h3>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="CourseName" class="form-label required">
                                    <i class="fas fa-graduation-cap me-1"></i>Tên khóa học
                                </label>
                                <input asp-for="CourseName" class="form-control" 
                                placeholder="Nhập tên khóa học (VD: Khóa học lập trình C#)">
                                <span asp-validation-for="CourseName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="Code" class="form-label required">
                                    <i class="fas fa-barcode me-1"></i>Mã khóa học
                                </label>
                                <input asp-for="Code" class="form-control" 
                                placeholder="VD: IT-001">
                                <span asp-validation-for="Code" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">
                                <i class="fas fa-align-left me-1"></i>Mô tả khóa học
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                            placeholder="Nhập mô tả chi tiết về nội dung, mục tiêu và lợi ích của khóa học..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                Mô tả nên bao gồm mục tiêu học tập, nội dung chính và đối tượng học viên
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Category" class="form-label required">
                                    <i class="fas fa-folder me-1"></i>Danh mục
                                </label>
                                <select asp-for="Category" class="form-select" id="Category">
                                    <option value="">-- Chọn danh mục khóa học --</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (dynamic category in ViewBag.Categories)
                                        {
                                            var isSelected = Model.CategoryName == category.CategoryName;
                                            <option value="@category.CourseCategoryId" selected="@isSelected">@category.CategoryName</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="Category" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Level" class="form-label required">
                                    <i class="fas fa-layer-group me-1"></i>Cấp độ
                                </label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">-- Chọn cấp độ --</option>
                                    @foreach (var level in CourseConstants.Levels.GetAllLevels())
                                    {
                                        <option value="@level.Key" selected="@(Model.Level == level.Key || Model.Level == level.Value)">
                                            @level.Value
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Duration" class="form-label required">
                                    <i class="fas fa-stopwatch me-1"></i>Thời lượng (giờ)
                                </label>
                                <input asp-for="Duration" type="number" class="form-control" min="1" max="500"
                                       placeholder="VD: 40">
                                <span asp-validation-for="Duration" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Tổng thời gian học bao gồm lý thuyết và thực hành
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-cog me-1"></i>Tùy chọn khóa học
                                </label>
                                <div class="d-flex flex-column gap-2 mt-2">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsOnline" class="form-check-input" type="checkbox" role="switch">
                                        <label asp-for="IsOnline" class="form-check-label">
                                            <span class="fw-semibold">Khóa học trực tuyến</span>
                                            <br>
                                            <small class="text-muted">Học viên có thể tham gia từ xa</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input asp-for="IsMandatory" class="form-check-input" type="checkbox" role="switch">
                                        <label asp-for="IsMandatory" class="form-check-label">
                                            <span class="fw-semibold">Khóa học bắt buộc</span>
                                            <br>
                                            <small class="text-muted">Nhân viên bắt buộc phải tham gia</small>
                                        </label>
                                    </div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Department Selection -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-building me-2"></i>Phòng Ban Áp Dụng
                        </h3>
                        <div class="form-help-text">
                            <i class="fas fa-info-circle me-2"></i>
                            Chọn các phòng ban mà khóa học này sẽ được áp dụng. Nhân viên thuộc các phòng ban được chọn sẽ có thể đăng ký tham gia khóa học.
                        </div>
                        
                        <div class="departments-selection">
                            @if (ViewBag.Departments != null)
                            {
                                @foreach (var dept in ViewBag.Departments)
                                {
                                    <div class="form-check department-check">
                                        <input class="form-check-input" type="checkbox"
                                               name="SelectedDepartmentIds" value="@dept.DepartmentId"
                                               id="dept_@dept.DepartmentId"
                                               checked="@(Model.Departments?.Any(d => d.DepartmentId == dept.DepartmentId) == true)">
                                        <label class="form-check-label" for="dept_@dept.DepartmentId">
                                            <i class="fas fa-building me-2"></i>
                                            <span class="fw-semibold">@dept.DepartmentName</span>
                                            <br>
                                            <small class="text-muted">Phòng ban trong tổ chức</small>
                                        </label>
                                    </div>
                                }
                                
                                <div class="departments-help text-info small mt-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span class="department-counter">@(Model.Departments?.Count ?? 0) phòng ban được chọn</span>
                                </div>
                            }
                            else
                            {
                                <div class="card border-warning bg-light">
                                    <div class="card-body py-2">
                                        <i class="fas fa-info-circle me-2 text-warning"></i>
                                        Không có dữ liệu phòng ban. Vui lòng liên hệ quản trị viên.
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Course Content Section -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-book me-2"></i>Nội Dung Khóa Học
                        </h3>
                        <p class="form-help-text">Quản lý các module và bài học cho khóa học</p>

                        <!-- Existing Modules Container -->
                        <div id="existing-modules-container">
                            @if (Model.Modules != null && Model.Modules.Any())
                            {
                                @for (int moduleIdx = 0; moduleIdx < Model.Modules.Count; moduleIdx++)
                                {
                                    var module = Model.Modules[moduleIdx];
                                    <div class="module-item mb-4" data-module-index="@moduleIdx" data-module-id="@module.Id">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">
                                                    <i class="fas fa-folder me-2"></i>Module <span class="module-number">@(moduleIdx + 1)</span>
                                                </h5>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-up-module" title="Di chuyển lên">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-down-module" title="Di chuyển xuống">
                                                        <i class="fas fa-arrow-down"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-module" title="Xóa module">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <input type="hidden" name="Modules[@moduleIdx].ModuleId" value="@module.Id" class="module-id" />
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label required">Tên Module</label>
                                                        <input type="text" name="Modules[@moduleIdx].Title" class="form-control module-title" 
                                                               value="@module.Title" placeholder="Nhập tên module" required>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label required">Thứ tự</label>
                                                        <input type="number" name="Modules[@moduleIdx].OrderIndex" class="form-control module-order" min="1" value="@(moduleIdx + 1)" readonly>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Mô tả Module</label>
                                                    <textarea name="Modules[@moduleIdx].Description" class="form-control module-description" rows="2" 
                                                              placeholder="Nhập mô tả module...">@module.Description</textarea>
                                                </div>

                                                <!-- Lessons Section -->
                                                <div class="lessons-section">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <h6><i class="fas fa-play-circle me-2"></i>Bài Học</h6>
                                                        <button type="button" class="btn btn-sm btn-outline-primary add-lesson-btn">
                                                            <i class="fas fa-plus me-1"></i>Thêm Bài Học
                                                        </button>
                                                    </div>
                                                    <div class="lessons-container">
                                                        @if (module.Lessons != null && module.Lessons.Any())
                                                        {
                                                            @for (int lessonIdx = 0; lessonIdx < module.Lessons.Count; lessonIdx++)
                                                            {
                                                                var lesson = module.Lessons[lessonIdx];
                                                                var lessonContentUrl = string.IsNullOrEmpty(lesson.ContentUrl) ? "" : lesson.ContentUrl;
                                                                <div class="lesson-item mb-3" data-lesson-index="@lessonIdx" data-lesson-id="@lesson.Id" data-content-url="@lessonContentUrl" data-lesson-type="@((int)lesson.Type)" data-quiz-id="@(lesson.QuizId?.ToString() ?? string.Empty)">
                                                                    <div class="card border-start border-primary border-3">
                                                                        <div class="card-body">
                                                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                                                <h6 class="card-title mb-0">
                                                                                    <i class="fas fa-play me-2"></i>Bài học <span class="lesson-number">@(lessonIdx + 1)</span>
                                                                                </h6>
                                                                                <div>
                                                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-up-lesson" title="Di chuyển lên">
                                                                                        <i class="fas fa-arrow-up"></i>
                                                                                    </button>
                                                                                    <button type="button" class="btn btn-sm btn-outline-secondary move-down-lesson" title="Di chuyển xuống">
                                                                                        <i class="fas fa-arrow-down"></i>
                                                                                    </button>
                                                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-lesson" title="Xóa bài học">
                                                                                        <i class="fas fa-trash"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <input type="hidden" name="Modules[@moduleIdx].Lessons[@lessonIdx].LessonId" value="@lesson.Id" class="lesson-id" />
                                                                            <div class="row mb-3">
                                                                                <div class="col-md-8">
                                                                                    <label class="form-label required">Tên Bài Học</label>
                                                                                    <input type="text" name="Modules[@moduleIdx].Lessons[@lessonIdx].Title" class="form-control lesson-title" 
                                                                                           value="@lesson.Title" placeholder="Nhập tên bài học" required>
                                                                                </div>
                                                                                <div class="col-md-4">
                                                                                    <label class="form-label required">Thứ tự</label>
                                                                                    <input type="number" name="Modules[@moduleIdx].Lessons[@lessonIdx].OrderIndex" class="form-control lesson-order" min="1" value="@(lessonIdx + 1)" readonly>
                                                                                </div>
                                                                            </div>

                                                                            @if (!string.IsNullOrEmpty(lesson.ContentUrl))
                                                                            {
                                                                                <div class="mb-3">
                                                                                    <label class="form-label">Nội dung học hiện tại</label>
                                                                                    <div class="card border-info bg-light">
                                                                                        <div class="card-body py-3 d-flex align-items-center justify-content-between">
                                                                                            <div>
                                                                                                <i class="fas @lesson.TypeIcon me-2 text-info"></i>
                                                                                                <strong>@lesson.TypeDisplay</strong>
                                                                                            </div>
                                                                                            <a href="@lesson.ContentUrl" target="_blank" class="btn-primary px-3 py-2">
                                                                                                <i class="fas fa-eye me-1"></i>Xem
                                                                                            </a>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            }

                                                                            @if (lesson.Type == LessonType.Quiz && lesson.QuizId.HasValue)
                                                                            {
                                                                                <div class="mb-3 quiz-current-wrapper" data-quiz-id="@lesson.QuizId">
                                                                                    <label class="form-label">Quiz hiện tại</label>
                                                                                    <div class="card border-warning bg-light">
                                                                                        <div class="card-body">
                                                                                            <div class="d-flex justify-content-between align-items-center">
                                                                                                <div>
                                                                                                    <i class="fas fa-clipboard-list me-2 text-warning"></i>
                                                                                                    <strong class="quiz-title-display">@lesson.Title</strong>
                                                                                                </div>
                                                                                                <button type="button" class="btn-outline-primary view-quiz-detail" data-quiz-id="@lesson.QuizId">
                                                                                                    <i class="fas fa-eye me-1"></i>Xem chi tiết
                                                                                                </button>
                                                                                            </div>
                                                                                            <div class="quiz-summary mt-3">
                                                                                                <div class="quiz-summary-loading text-muted small">
                                                                                                    <i class="fas fa-spinner fa-spin me-1"></i>Đang tải thông tin quiz...
                                                                                                </div>
                                                                                                <div class="quiz-summary-content d-none small text-muted">
                                                                                                    <div>
                                                                                                        <i class="fas fa-clock me-1"></i><span class="quiz-time-limit">--</span> phút
                                                                                                        <span class="ms-3"><i class="fas fa-redo me-1"></i><span class="quiz-max-attempts">--</span> lần</span>
                                                                                                        <span class="ms-3"><i class="fas fa-check-circle me-1"></i>Đạt <span class="quiz-passing-score">--</span>%</span>
                                                                                                    </div>
                                                                                                    <div class="mt-2">
                                                                                                        <i class="fas fa-question-circle me-1"></i><span class="quiz-question-count">0</span> câu hỏi
                                                                                                    </div>
                                                                                                    <p class="quiz-description mt-2 mb-0 d-none"></p>
                                                                                                </div>
                                                                                                    <div class="alert alert-warning quiz-replace-notice mt-3 mb-0 d-none">
                                                                                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                                                                                        Quiz hiện tại sẽ được thay thế sau khi tải lên file Excel mới.
                                                                                                    </div>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            }

                                                                            <div class="mb-3">
                                                                                <label class="form-label">Loại Nội Dung</label>
                                                                                <div class="content-type-selector mb-3">
                                                                                    <div class="btn-group" role="group">
                                                                                        <input type="radio" class="btn-check lesson-type-radio" name="lesson-type-@moduleIdx-@lessonIdx" id="type-video-@moduleIdx-@lessonIdx" value="1">
                                                                                        <label class="btn btn-outline-primary" for="type-video-@moduleIdx-@lessonIdx">
                                                                                            <i class="fas fa-video me-1"></i>Video
                                                                                        </label>

                                                                                        <input type="radio" class="btn-check lesson-type-radio" name="lesson-type-@moduleIdx-@lessonIdx" id="type-docs-@moduleIdx-@lessonIdx" value="2">
                                                                                        <label class="btn btn-outline-success" for="type-docs-@moduleIdx-@lessonIdx">
                                                                                            <i class="fas fa-file-alt me-1"></i>Tài liệu
                                                                                        </label>

                                                                                        <input type="radio" class="btn-check lesson-type-radio" name="lesson-type-@moduleIdx-@lessonIdx" id="type-quiz-@moduleIdx-@lessonIdx" value="3">
                                                                                        <label class="btn btn-outline-warning" for="type-quiz-@moduleIdx-@lessonIdx">
                                                                                            <i class="fas fa-question-circle me-1"></i>Quiz
                                                                                        </label>
                                                                                    </div>
                                                                                </div>

                                                                                <!-- Video URL Input -->
                                                                                <div class="video-input-area" style="display: none;">
                                                                                    <label class="form-label">URL Video</label>
                                                                                    <input type="text" class="form-control lesson-video-url" placeholder="Nhập URL video (YouTube, Vimeo, hoặc link trực tiếp...)">
                                                                                    <div class="form-text">
                                                                                        <i class="fas fa-info-circle me-1"></i>
                                                                                        Hỗ trợ: YouTube, Vimeo, hoặc link video trực tiếp (.mp4)
                                                                                    </div>
                                                                                </div>

                                                                                <!-- Docs/Quiz Upload -->
                                                                                <div class="file-upload-area" style="display: none;">
                                                                                    <label class="form-label">Tải lên tệp mới (để trống nếu giữ nguyên)</label>
                                                                                    <input type="file" name="LessonFiles" class="form-control content-file-input" accept="">
                                                                                    <div class="form-text file-upload-hint">
                                                                                        <i class="fas fa-cloud-upload-alt me-1"></i>
                                                                                        <span class="upload-type-text"></span>
                                                                                    </div>
                                                                                    <div class="file-info mt-2" style="display: none;">
                                                                                        <div class="card border-success bg-light">
                                                                                            <div class="card-body py-2">
                                                                                                <i class="fas fa-file me-2 text-success"></i>
                                                                                                <span class="file-name fw-semibold"></span>
                                                                                                <span class="file-size text-muted ms-2"></span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                                <!-- Quiz Settings -->
                                                                                <div class="quiz-settings-area" style="display: none;">
                                                                                    <hr class="my-3">
                                                                                    <h6 class="mb-3">
                                                                                        <i class="fas fa-cog me-2 text-warning"></i>Cấu hình Quiz
                                                                                    </h6>
                                                                                    <div class="row">
                                                                                        <div class="col-md-4 mb-3">
                                                                                            <label class="form-label required">Số lần làm tối đa</label>
                                                                                            <input type="number" name="Modules[@moduleIdx].Lessons[@lessonIdx].QuizMaxAttempts" class="form-control quiz-max-attempts" 
                                                                                                   min="1" max="10" value="@(lesson.QuizMaxAttempts ?? 3)" placeholder="VD: 3">
                                                                                            <small class="form-text text-muted">Từ 1 đến 10 lần</small>
                                                                                        </div>
                                                                                        <div class="col-md-4 mb-3">
                                                                                            <label class="form-label required">Điểm Pass (%)</label>
                                                                                            <input type="number" name="Modules[@moduleIdx].Lessons[@lessonIdx].QuizPassingScore" class="form-control quiz-passing-score" 
                                                                                                   min="0" max="100" value="@(lesson.QuizPassingScore ?? 70)" placeholder="VD: 70">
                                                                                            <small class="form-text text-muted">Từ 0% đến 100%</small>
                                                                                        </div>
                                                                                        <div class="col-md-4 mb-3">
                                                                                            <label class="form-label required">Thời gian (phút)</label>
                                                                                            <input type="number" name="Modules[@moduleIdx].Lessons[@lessonIdx].QuizTimeLimit" class="form-control quiz-time-limit" 
                                                                                                   min="1" max="180" value="@(lesson.QuizTimeLimit ?? 30)" placeholder="VD: 30">
                                                                                            <small class="form-text text-muted">Từ 1 đến 180 phút</small>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <!-- New Modules Container -->
                        <div id="modules-container">
                            <!-- New modules will be added here -->
                        </div>

                        <button type="button" class="btn btn-outline-primary mt-3" id="add-module-btn">
                            <i class="fas fa-plus me-2"></i>Thêm Module Mới
                        </button>
                    </div>
                </div>

                <!-- Side Panel -->
                <div class="col-lg-4 mb-4">
                    <!-- Form Help -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-question-circle me-2"></i>Hướng Dẫn Chỉnh Sửa
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Tên khóa học:</strong> Nên ngắn gọn, dễ hiểu và phản ánh đúng nội dung
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Mã khóa học:</strong> Theo định dạng chuẩn: AB-123 (không được trùng)
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Cấp độ:</strong> Chọn phù hợp với độ khó và kiến thức yêu cầu
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Thời lượng:</strong> Tính theo giờ học thực tế (bao gồm lý thuyết + thực hành)
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Trực tuyến:</strong> Bật nếu khóa học có thể tham gia từ xa
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Bắt buộc:</strong> Bật nếu nhân viên bắt buộc phải tham gia khóa học
                                </span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>
                                    <strong>Phòng ban:</strong> Chọn ít nhất 1 phòng ban để nhân viên có thể đăng ký
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-card" style="position: sticky; top: 20px;">
                        <h3 class="form-section-title">
                            <i class="fas fa-save me-2"></i>Lưu Thay Đổi
                        </h3>

                        <div class="d-grid gap-3">
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-save me-2"></i>Lưu Thay Đổi
                            </button>
                            <a href="@Url.Action("ChiTiet", new { id = Model.CourseId })"
                               class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>Hủy Bỏ
                            </a>
                        </div>

                        <div class="mt-3 p-3" style="background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Lưu ý:</strong> Các thay đổi sẽ được áp dụng ngay lập tức và có thể ảnh hưởng đến các lớp học đang diễn ra.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Hidden Templates -->
        <div id="module-template" style="display: none;">
            <div class="module-item mb-4" data-module-index="">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-folder me-2"></i>Module <span class="module-number"></span>
                        </h5>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary move-up-module" title="Di chuyển lên">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary move-down-module" title="Di chuyển xuống">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-module" title="Xóa module">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label required">Tên Module</label>
                                <input type="text" name="Modules[].ModuleName" class="form-control module-title" placeholder="Nhập tên module" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required">Thứ tự</label>
                                <input type="number" name="Modules[].Order" class="form-control module-order" min="1" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả Module</label>
                            <textarea name="Modules[].Description" class="form-control module-description" rows="2" placeholder="Nhập mô tả module..."></textarea>
                        </div>

                        <!-- Lessons Section -->
                        <div class="lessons-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6><i class="fas fa-play-circle me-2"></i>Bài Học</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary add-lesson-btn">
                                    <i class="fas fa-plus me-1"></i>Thêm Bài Học
                                </button>
                            </div>
                            <div class="lessons-container">
                                <!-- Lessons will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="lesson-template" style="display: none;">
            <div class="lesson-item mb-3" data-lesson-index="">
                <div class="card border-start border-primary border-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-play me-2"></i>Bài học <span class="lesson-number"></span>
                            </h6>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-secondary move-up-lesson" title="Di chuyển lên">
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary move-down-lesson" title="Di chuyển xuống">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-lesson" title="Xóa bài học">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label required">Tên Bài Học</label>
                                <input type="text" name="Modules[].Lessons[].LessonName" class="form-control lesson-title" placeholder="Nhập tên bài học" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label required">Thứ tự</label>
                                <input type="number" name="Modules[].Lessons[].Order" class="form-control lesson-order" min="1" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Loại Nội Dung</label>
                            <div class="content-type-selector mb-3">
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check lesson-type-radio" name="lesson-type-" id="type-video-" value="1">
                                    <label class="btn btn-outline-primary" for="type-video-">
                                        <i class="fas fa-video me-1"></i>Video
                                    </label>

                                    <input type="radio" class="btn-check lesson-type-radio" name="lesson-type-" id="type-docs-" value="2">
                                    <label class="btn btn-outline-success" for="type-docs-">
                                        <i class="fas fa-file-alt me-1"></i>Tài liệu
                                    </label>

                                    <input type="radio" class="btn-check lesson-type-radio" name="lesson-type-" id="type-quiz-" value="3">
                                    <label class="btn btn-outline-warning" for="type-quiz-">
                                        <i class="fas fa-question-circle me-1"></i>Quiz
                                    </label>
                                </div>
                            </div>

                            <!-- Video URL Input -->
                            <div class="video-input-area" style="display: none;">
                                <label class="form-label">URL Video</label>
                                <input type="text" class="form-control lesson-video-url" placeholder="Nhập URL video (YouTube, Vimeo, hoặc link trực tiếp...)">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Hỗ trợ: YouTube, Vimeo, hoặc link video trực tiếp (.mp4)
                                </div>
                            </div>

                            <!-- Docs/Quiz Upload -->
                            <div class="file-upload-area" style="display: none;">
                                <label class="form-label">Tải lên tệp</label>
                                <input type="file" name="LessonFiles" class="form-control content-file-input" accept="">
                                <div class="form-text file-upload-hint">
                                    <i class="fas fa-cloud-upload-alt me-1"></i>
                                    <span class="upload-type-text"></span>
                                </div>
                                <div class="file-info mt-2" style="display: none;">
                                    <div class="card border-success bg-light">
                                        <div class="card-body py-2">
                                            <i class="fas fa-file me-2 text-success"></i>
                                            <span class="file-name fw-semibold"></span>
                                            <span class="file-size text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quiz Settings -->
                            <div class="quiz-settings-area" style="display: none;">
                                <hr class="my-3">
                                <h6 class="mb-3">
                                    <i class="fas fa-cog me-2 text-warning"></i>Cấu hình Quiz
                                </h6>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label required">Số lần làm tối đa</label>
                                        <input type="number" name="Modules[].Lessons[].QuizMaxAttempts" class="form-control quiz-max-attempts" 
                                               min="1" max="10" value="3" placeholder="VD: 3">
                                        <small class="form-text text-muted">Từ 1 đến 10 lần</small>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label required">Điểm Pass (%)</label>
                                        <input type="number" name="Modules[].Lessons[].QuizPassingScore" class="form-control quiz-passing-score" 
                                               min="0" max="100" value="70" placeholder="VD: 70">
                                        <small class="form-text text-muted">Từ 0% đến 100%</small>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label required">Thời gian (phút)</label>
                                        <input type="number" name="Modules[].Lessons[].QuizTimeLimit" class="form-control quiz-time-limit" 
                                               min="1" max="180" value="30" placeholder="VD: 30">
                                        <small class="form-text text-muted">Từ 1 đến 180 phút</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Form validation and interactions
        document.addEventListener('DOMContentLoaded', function() {
            let moduleIndex = 1; // Start from 1 since we have existing module at index 0

            // Auto-generate course code from name
            const courseNameInput = document.querySelector('#CourseName');
            const courseCodeInput = document.querySelector('#Code');
            
            if (courseNameInput && courseCodeInput && !courseCodeInput.value) {
                courseNameInput.addEventListener('blur', function() {
                    if (!courseCodeInput.value && this.value) {
                        // Generate simple code from name
                        const words = this.value.split(' ').slice(0, 2);
                        const code = words.map(word => word.charAt(0).toUpperCase()).join('') + 
                                   '-' + String(Math.floor(Math.random() * 100) + 1).padStart(3, '0');
                        courseCodeInput.value = code;
                        
                        // Add visual feedback
                        courseCodeInput.style.background = '#e8f5e8';
                        setTimeout(() => {
                            courseCodeInput.style.background = '';
                        }, 1000);
                    }
                });
            }

            // Module and Lesson Management
            const modulesContainer = document.getElementById('modules-container');
            const addModuleBtn = document.getElementById('add-module-btn');
            const moduleTemplate = document.getElementById('module-template');
            const lessonTemplate = document.getElementById('lesson-template');

            const quizDetailCache = new Map();

            function ensureQuizModal() {
                if (document.getElementById('quizModal')) {
                    return;
                }

                const modalHtml = `
<div class="modal fade modal-quiz" id="quizModal" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="quizModalLabel">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span id="quizTitle"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="quizLoadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
                <div id="quizContent" style="display: none;">
                    <div class="quiz-info mb-4 p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <strong><i class="fas fa-clock me-2"></i>Thời gian:</strong>
                                <span id="quizTimeLimit"></span> phút
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong><i class="fas fa-redo me-2"></i>Số lần làm tối đa:</strong>
                                <span id="quizMaxAttempts"></span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong><i class="fas fa-check-circle me-2"></i>Điểm đạt:</strong>
                                <span id="quizPassingScore"></span>%
                            </div>
                        </div>
                        <div class="mt-2" id="quizDescriptionContainer">
                            <strong><i class="fas fa-info-circle me-2"></i>Mô tả:</strong>
                            <p class="mb-0 mt-1" id="quizDescription"></p>
                        </div>
                    </div>
                    <h6 class="mb-3"><i class="fas fa-question-circle me-2"></i>Danh sách câu hỏi (<span id="questionCount"></span> câu)</h6>
                    <div id="questionsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Đóng
                </button>
            </div>
        </div>
    </div>
</div>`;

                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }

            async function fetchQuizDetail(quizId) {
                if (!quizId) {
                    throw new Error('QuizId không hợp lệ.');
                }

                if (quizDetailCache.has(quizId)) {
                    return quizDetailCache.get(quizId);
                }

                const response = await fetch(`/bai-thi/get-quiz-detail/${quizId}`);

                if (!response.ok) {
                    let errorMessage = 'Không thể tải thông tin quiz';
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (err) {
                        if (response.status === 404) {
                            errorMessage = `Quiz với ID ${quizId} không tồn tại`;
                        } else if (response.status === 401) {
                            errorMessage = 'Bạn cần đăng nhập để xem quiz này';
                        } else if (response.status === 403) {
                            errorMessage = 'Bạn không có quyền xem quiz này';
                        } else {
                            errorMessage = `Không thể tải thông tin quiz (Status: ${response.status})`;
                        }
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                quizDetailCache.set(quizId, data);
                return data;
            }

            async function populateQuizSummary(lessonItem, quizId) {
                if (!lessonItem || !quizId) {
                    return;
                }

                const wrapper = lessonItem.querySelector('.quiz-current-wrapper');
                if (!wrapper || wrapper.getAttribute('data-summary-loaded') === 'true') {
                    return;
                }

                const loadingEl = wrapper.querySelector('.quiz-summary-loading');

                try {
                    const quiz = await fetchQuizDetail(quizId);
                    renderQuizSummary(lessonItem, quiz);
                    wrapper.setAttribute('data-summary-loaded', 'true');
                    const quizTitle = quiz.title || lessonItem.querySelector('.quiz-title-display')?.textContent || '';
                    lessonItem.setAttribute('data-quiz-title', quizTitle);
                } catch (error) {
                    if (loadingEl) {
                        loadingEl.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>${error.message}</span>`;
                    }
                }
            }

            function renderQuizSummary(lessonItem, quiz) {
                const wrapper = lessonItem.querySelector('.quiz-current-wrapper');
                if (!wrapper) {
                    return;
                }

                const loadingEl = wrapper.querySelector('.quiz-summary-loading');
                const contentEl = wrapper.querySelector('.quiz-summary-content');
                const timeLimitEl = wrapper.querySelector('.quiz-time-limit');
                const maxAttemptsEl = wrapper.querySelector('.quiz-max-attempts');
                const passingScoreEl = wrapper.querySelector('.quiz-passing-score');
                const questionCountEl = wrapper.querySelector('.quiz-question-count');
                const descriptionEl = wrapper.querySelector('.quiz-description');
                const titleDisplayEl = lessonItem.querySelector('.quiz-title-display');

                if (loadingEl) {
                    loadingEl.classList.add('d-none');
                }
                if (contentEl) {
                    contentEl.classList.remove('d-none');
                }
                if (titleDisplayEl && quiz?.title) {
                    titleDisplayEl.textContent = quiz.title;
                }
                if (timeLimitEl) {
                    timeLimitEl.textContent = quiz?.timeLimit ?? 0;
                }
                if (maxAttemptsEl) {
                    maxAttemptsEl.textContent = quiz?.maxAttempts ?? 0;
                }
                if (passingScoreEl) {
                    passingScoreEl.textContent = quiz?.passingScore ?? 0;
                }
                if (questionCountEl) {
                    const questions = Array.isArray(quiz?.questions) ? quiz.questions : [];
                    questionCountEl.textContent = questions.length;
                }
                if (descriptionEl) {
                    if (quiz?.description) {
                        descriptionEl.textContent = quiz.description;
                        descriptionEl.classList.remove('d-none');
                    } else {
                        descriptionEl.textContent = '';
                        descriptionEl.classList.add('d-none');
                    }
                }
            }

            function attachQuizDetailHandlers(lessonItem) {
                if (!lessonItem) {
                    return;
                }

                const viewBtn = lessonItem.querySelector('.view-quiz-detail');
                if (viewBtn && !viewBtn.dataset.bound) {
                    viewBtn.dataset.bound = 'true';
                    viewBtn.addEventListener('click', async function() {
                        const clickedQuizId = this.getAttribute('data-quiz-id') || lessonItem.getAttribute('data-quiz-id');
                        if (!clickedQuizId) {
                            return;
                        }

                        const title = lessonItem.getAttribute('data-quiz-title') || lessonItem.querySelector('.quiz-title-display')?.textContent || 'Quiz';
                        await showQuizDetailModal(clickedQuizId, title);
                    });
                }
            }

            async function showQuizDetailModal(quizId, title) {
                ensureQuizModal();

                const modalEl = document.getElementById('quizModal');
                if (typeof bootstrap === 'undefined' || !modalEl) {
                    console.error('Bootstrap modal instance is not available.');
                    return;
                }

                const spinner = document.getElementById('quizLoadingSpinner');
                const content = document.getElementById('quizContent');
                const titleEl = document.getElementById('quizTitle');

                if (spinner) {
                    spinner.style.display = 'block';
                    spinner.innerHTML = `
<div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Đang tải...</span>
</div>`;
                }
                if (content) {
                    content.style.display = 'none';
                }
                if (titleEl) {
                    titleEl.textContent = title || 'Quiz';
                }

                const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
                modalInstance.show();

                try {
                    const quiz = await fetchQuizDetail(quizId);
                    displayQuizDetailInModal(quiz);
                } catch (error) {
                    if (spinner) {
                        spinner.innerHTML = `
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i>${error.message}
</div>`;
                    }
                }
            }

            function displayQuizDetailInModal(quiz) {
                const spinner = document.getElementById('quizLoadingSpinner');
                const content = document.getElementById('quizContent');

                if (spinner) {
                    spinner.style.display = 'none';
                }
                if (content) {
                    content.style.display = 'block';
                }

                const timeLimitEl = document.getElementById('quizTimeLimit');
                const maxAttemptsEl = document.getElementById('quizMaxAttempts');
                const passingScoreEl = document.getElementById('quizPassingScore');
                const descriptionContainer = document.getElementById('quizDescriptionContainer');
                const descriptionEl = document.getElementById('quizDescription');
                const questionCountEl = document.getElementById('questionCount');
                const questionsList = document.getElementById('questionsList');

                if (timeLimitEl) {
                    timeLimitEl.textContent = quiz?.timeLimit ?? 0;
                }
                if (maxAttemptsEl) {
                    maxAttemptsEl.textContent = quiz?.maxAttempts ?? 0;
                }
                if (passingScoreEl) {
                    passingScoreEl.textContent = quiz?.passingScore ?? 0;
                }

                if (descriptionContainer && descriptionEl) {
                    if (quiz?.description) {
                        descriptionEl.textContent = quiz.description;
                        descriptionContainer.style.display = 'block';
                    } else {
                        descriptionEl.textContent = '';
                        descriptionContainer.style.display = 'none';
                    }
                }

                const questions = Array.isArray(quiz?.questions) ? quiz.questions.sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0)) : [];
                if (questionCountEl) {
                    questionCountEl.textContent = questions.length;
                }

                if (questionsList) {
                    questionsList.innerHTML = '';

                    if (questions.length === 0) {
                        questionsList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Quiz này chưa có câu hỏi nào.</div>';
                        return;
                    }

                    questions.forEach((question, index) => {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'question-item mb-3 p-3 border rounded';

                        let questionTypeIcon = 'fa-check-circle';
                        let questionTypeBadge = 'Multiple Choice';
                        let questionTypeBadgeClass = 'bg-primary';

                        if (question.questionType === 'TrueFalse') {
                            questionTypeIcon = 'fa-toggle-on';
                            questionTypeBadge = 'True/False';
                            questionTypeBadgeClass = 'bg-info';
                        } else if (question.questionType === 'Essay') {
                            questionTypeIcon = 'fa-pen';
                            questionTypeBadge = 'Essay';
                            questionTypeBadgeClass = 'bg-warning text-dark';
                        }

                        const answers = Array.isArray(question.answers) ? [...question.answers].sort((a, b) => (a.orderIndex ?? 0) - (b.orderIndex ?? 0)) : [];
                        const answersHtml = answers.length > 0
                            ? `<ul class="list-unstyled mt-2 ms-3">${answers.map(answer => {
                                const correctIcon = answer.isCorrect
                                    ? '<i class="fas fa-check-circle text-success me-2"></i>'
                                    : '<i class="far fa-circle text-muted me-2"></i>';
                                return `<li class="mb-1">${correctIcon}${answer.answerText}</li>`;
                            }).join('')}</ul>`
                            : '<div class="text-muted fst-italic">(Không có đáp án)</div>';

                        questionDiv.innerHTML = `
<div class="d-flex justify-content-between align-items-start mb-2">
    <h6 class="mb-0">
        <span class="badge bg-secondary me-2">Câu ${index + 1}</span>
        ${question.questionText}
    </h6>
    <div>
        <span class="badge ${questionTypeBadgeClass} me-1">
            <i class="fas ${questionTypeIcon} me-1"></i>${questionTypeBadge}
        </span>
        <span class="badge bg-success">
            <i class="fas fa-star me-1"></i>${question.points ?? 0} điểm
        </span>
    </div>
</div>
${answersHtml}`;

                        questionsList.appendChild(questionDiv);
                    });
                }
            }

            // Add event listeners to existing lessons
            initializeExistingContent();

            // Add Module
            addModuleBtn.addEventListener('click', function() {
                addModule();
            });

            function initializeExistingContent() {
                // Add event listeners to existing modules and lessons
                const existingModules = document.querySelectorAll('#existing-modules-container .module-item');
                let maxModuleIndex = 0;
                existingModules.forEach((moduleItem, idx) => {
                    addModuleEventListeners(moduleItem);
                    const moduleIdx = parseInt(moduleItem.getAttribute('data-module-index') || idx);
                    if (moduleIdx >= maxModuleIndex) {
                        maxModuleIndex = moduleIdx + 1;
                    }
                    
                    // Initialize lesson types for existing lessons
                    const existingLessons = moduleItem.querySelectorAll('.lesson-item');
                    existingLessons.forEach(lessonItem => {
                        const lessonType = lessonItem.getAttribute('data-lesson-type') || '1';
                        const contentUrl = lessonItem.getAttribute('data-content-url') || '';
                        
                        // Set the appropriate radio button
                        const radioBtn = lessonItem.querySelector(`.lesson-type-radio[value="${lessonType}"]`);
                        if (radioBtn) {
                            radioBtn.checked = true;
                        }
                        
                        // Initialize UI based on lesson type
                        if (lessonType === '1') {
                            // Video: show video input and set URL
                            const videoInputArea = lessonItem.querySelector('.video-input-area');
                            const videoUrlInput = lessonItem.querySelector('.lesson-video-url');
                            if (videoInputArea) videoInputArea.style.display = 'block';
                            if (videoUrlInput && contentUrl) {
                                videoUrlInput.value = contentUrl;
                                lessonItem.setAttribute('data-video-url', contentUrl);
                            }
                        } else {
                            // Docs or Quiz: show file upload area
                            handleLessonTypeChange(lessonItem, lessonType);
                            
                            // If there's existing content, show info
                            if (contentUrl) {
                                const fileInfo = lessonItem.querySelector('.file-info');
                                const fileName = lessonItem.querySelector('.file-name');
                                if (fileInfo && fileName) {
                                    const urlParts = contentUrl.split('/');
                                    const displayName = decodeURIComponent(urlParts[urlParts.length - 1]);
                                    fileName.textContent = displayName;
                                    fileInfo.style.display = 'block';
                                }
                            }
                            
                            // Show Quiz settings for Quiz type
                            if (lessonType === '3') {
                                const quizSettingsArea = lessonItem.querySelector('.quiz-settings-area');
                                if (quizSettingsArea) {
                                    quizSettingsArea.style.display = 'block';
                                }
                                const quizId = lessonItem.getAttribute('data-quiz-id');
                                if (quizId) {
                                    populateQuizSummary(lessonItem, quizId);
                                }
                                attachQuizDetailHandlers(lessonItem);
                            }
                        }
                    });
                });
                moduleIndex = maxModuleIndex;
            }

            function addModule() {
                const moduleHtml = moduleTemplate.innerHTML;
                const moduleDiv = document.createElement('div');
                moduleDiv.innerHTML = moduleHtml;
                const moduleItem = moduleDiv.firstElementChild;
                
                moduleIndex++;
                moduleItem.setAttribute('data-module-index', moduleIndex - 1);
                
                // Update module number and form names
                updateModuleIndexes(moduleItem, moduleIndex - 1);
                
                modulesContainer.appendChild(moduleItem);
                
                // Add event listeners
                addModuleEventListeners(moduleItem);
                
                // Update all module orders
                updateAllModuleOrders();
            }

            function addModuleEventListeners(moduleItem) {
                // Remove module
                const removeBtn = moduleItem.querySelector('.remove-module');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        if (confirm('Bạn có chắc chắn muốn xóa module này và tất cả bài học trong đó?')) {
                            moduleItem.remove();
                            updateAllModuleOrders();
                        }
                    });
                }

                // Move module up/down
                const moveUpBtn = moduleItem.querySelector('.move-up-module');
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', function() {
                        const prev = moduleItem.previousElementSibling;
                        if (prev) {
                            moduleItem.parentNode.insertBefore(moduleItem, prev);
                            updateAllModuleOrders();
                        }
                    });
                }

                const moveDownBtn = moduleItem.querySelector('.move-down-module');
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', function() {
                        const next = moduleItem.nextElementSibling;
                        if (next) {
                            moduleItem.parentNode.insertBefore(next, moduleItem);
                            updateAllModuleOrders();
                        }
                    });
                }

                // Add lesson
                const addLessonBtn = moduleItem.querySelector('.add-lesson-btn');
                if (addLessonBtn) {
                    addLessonBtn.addEventListener('click', function() {
                        addLesson(moduleItem);
                    });
                }

                // Add event listeners to existing lessons in this module
                const existingLessons = moduleItem.querySelectorAll('.lesson-item');
                existingLessons.forEach(lessonItem => {
                    addLessonEventListeners(lessonItem, moduleItem);
                });
            }

            function addLesson(moduleItem) {
                const lessonHtml = lessonTemplate.innerHTML;
                const lessonDiv = document.createElement('div');
                lessonDiv.innerHTML = lessonHtml;
                const lessonItem = lessonDiv.firstElementChild;
                
                const lessonsContainer = moduleItem.querySelector('.lessons-container');
                const moduleIndex = moduleItem.getAttribute('data-module-index');
                const lessonIndex = lessonsContainer.children.length;
                
                lessonItem.setAttribute('data-lesson-index', lessonIndex);
                
                // Set default lesson type to Video (1) and check the radio button
                lessonItem.setAttribute('data-lesson-type', '1');
                const videoRadio = lessonItem.querySelector('.lesson-type-radio[value="1"]');
                if (videoRadio) {
                    videoRadio.checked = true;
                }
                // Show video input area by default
                handleLessonTypeChange(lessonItem, '1');
                
                // Update lesson form names and IDs
                updateLessonIndexes(lessonItem, moduleIndex, lessonIndex);
                
                lessonsContainer.appendChild(lessonItem);
                
                // Add event listeners
                addLessonEventListeners(lessonItem, moduleItem);
                
                // Update lesson orders in this module
                updateLessonOrders(moduleItem);
            }

            function addLessonEventListeners(lessonItem, moduleItem) {
                const lessonsContainer = moduleItem.querySelector('.lessons-container');

                // Remove lesson
                const removeBtn = lessonItem.querySelector('.remove-lesson');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        if (confirm('Bạn có chắc chắn muốn xóa bài học này?')) {
                            lessonItem.remove();
                            updateLessonOrders(moduleItem);
                        }
                    });
                }

                // Move lesson up/down
                const moveUpBtn = lessonItem.querySelector('.move-up-lesson');
                if (moveUpBtn) {
                    moveUpBtn.addEventListener('click', function() {
                        const prev = lessonItem.previousElementSibling;
                        if (prev) {
                            lessonsContainer.insertBefore(lessonItem, prev);
                            updateLessonOrders(moduleItem);
                        }
                    });
                }

                const moveDownBtn = lessonItem.querySelector('.move-down-lesson');
                if (moveDownBtn) {
                    moveDownBtn.addEventListener('click', function() {
                        const next = lessonItem.nextElementSibling;
                        if (next) {
                            lessonsContainer.insertBefore(next, lessonItem);
                            updateLessonOrders(moduleItem);
                        }
                    });
                }

                // Lesson type change (Video/Docs/Quiz)
                const lessonTypeInputs = lessonItem.querySelectorAll('.lesson-type-radio');
                lessonTypeInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        handleLessonTypeChange(lessonItem, this.value);
                    });
                });

                // Video URL input
                const videoUrlInput = lessonItem.querySelector('.lesson-video-url');
                if (videoUrlInput) {
                    videoUrlInput.addEventListener('input', function() {
                        // Store the video URL for later use
                        lessonItem.setAttribute('data-video-url', this.value);
                    });
                }

                // File upload
                const fileInput = lessonItem.querySelector('.content-file-input');
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        handleFileUpload(lessonItem, this);
                    });
                }

                attachQuizDetailHandlers(lessonItem);
            }

            function handleLessonTypeChange(lessonItem, lessonType) {
                const videoInputArea = lessonItem.querySelector('.video-input-area');
                const fileUploadArea = lessonItem.querySelector('.file-upload-area');
                const quizSettingsArea = lessonItem.querySelector('.quiz-settings-area');
                const fileInput = lessonItem.querySelector('.content-file-input');
                const uploadHint = lessonItem.querySelector('.upload-type-text');
                const quizInfoWrapper = lessonItem.querySelector('.quiz-current-wrapper');
                
                // Hide all areas first
                if (videoInputArea) videoInputArea.style.display = 'none';
                if (fileUploadArea) fileUploadArea.style.display = 'none';
                if (quizSettingsArea) quizSettingsArea.style.display = 'none';
                
                // Store lesson type
                lessonItem.setAttribute('data-lesson-type', lessonType);
                
                switch(lessonType) {
                    case '1': // Video
                        if (videoInputArea) videoInputArea.style.display = 'block';
                        // Disable file input for video lessons
                        if (fileInput) {
                            fileInput.disabled = true;
                            fileInput.value = '';
                        }
                        if (quizInfoWrapper) {
                            quizInfoWrapper.style.display = 'none';
                        }
                        lessonItem.removeAttribute('data-has-new-quiz-file');
                        const quizNoticeVideo = lessonItem.querySelector('.quiz-replace-notice');
                        if (quizNoticeVideo) {
                            quizNoticeVideo.classList.add('d-none');
                        }
                        break;
                    case '2': // Docs
                        if (fileUploadArea) fileUploadArea.style.display = 'block';
                        if (fileInput) {
                            fileInput.disabled = false;
                            fileInput.setAttribute('accept', '.pdf,.doc,.docx,.ppt,.pptx,.txt');
                        }
                        if (uploadHint) uploadHint.textContent = 'Hỗ trợ: PDF, Word, PowerPoint, Text';
                        if (quizInfoWrapper) {
                            quizInfoWrapper.style.display = 'none';
                        }
                        lessonItem.removeAttribute('data-has-new-quiz-file');
                        const quizNoticeDocs = lessonItem.querySelector('.quiz-replace-notice');
                        if (quizNoticeDocs) {
                            quizNoticeDocs.classList.add('d-none');
                        }
                        break;
                    case '3': // Quiz
                        if (fileUploadArea) fileUploadArea.style.display = 'block';
                        if (quizSettingsArea) quizSettingsArea.style.display = 'block';
                        if (fileInput) {
                            fileInput.disabled = false;
                            fileInput.setAttribute('accept', '.xlsx,.xls');
                        }
                        if (uploadHint) uploadHint.textContent = 'Hỗ trợ: Excel (.xlsx, .xls)';
                        if (quizInfoWrapper) {
                            quizInfoWrapper.style.display = '';
                        }
                        const quizNoticeQuiz = lessonItem.querySelector('.quiz-replace-notice');
                        if (quizNoticeQuiz) {
                            if (lessonItem.getAttribute('data-has-new-quiz-file') === 'true') {
                                quizNoticeQuiz.classList.remove('d-none');
                            } else {
                                quizNoticeQuiz.classList.add('d-none');
                            }
                        }
                        const currentQuizId = lessonItem.getAttribute('data-quiz-id');
                        if (currentQuizId && quizInfoWrapper && quizInfoWrapper.getAttribute('data-summary-loaded') !== 'true') {
                            populateQuizSummary(lessonItem, currentQuizId);
                        }
                        attachQuizDetailHandlers(lessonItem);
                        break;
                }
            }

            function updateModuleIndexes(moduleItem, index) {
                // Update module number display
                const moduleNumber = moduleItem.querySelector('.module-number');
                if (moduleNumber) moduleNumber.textContent = index + 1;
                
                // Update form field names
                const inputs = moduleItem.querySelectorAll('input[name^="Modules["], textarea[name^="Modules["]');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name.replace(/Modules\[\d*\]/, `Modules[${index}]`);
                        input.setAttribute('name', newName);
                    }
                });

                // Update module order value
                const orderInput = moduleItem.querySelector('.module-order');
                if (orderInput) orderInput.value = index + 1;
            }

            function updateLessonIndexes(lessonItem, moduleIndex, lessonIndex) {
                // Update lesson number display
                const lessonNumber = lessonItem.querySelector('.lesson-number');
                if (lessonNumber) lessonNumber.textContent = lessonIndex + 1;
                
                // Update form field names and IDs
                const inputs = lessonItem.querySelectorAll('input, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes('Modules[].Lessons[]')) {
                        const newName = name.replace('Modules[].Lessons[]', `Modules[${moduleIndex}].Lessons[${lessonIndex}]`);
                        input.setAttribute('name', newName);
                    }

                    const id = input.getAttribute('id');
                    if (id && (id.includes('-') && id.endsWith('-'))) {
                        const newId = id.replace(/-$/, `-${moduleIndex}-${lessonIndex}`);
                        input.setAttribute('id', newId);
                        
                        // Update corresponding label
                        const label = lessonItem.querySelector(`label[for="${id}"]`);
                        if (label) {
                            label.setAttribute('for', newId);
                        }
                    }

                    // Update radio button names for lesson type
                    if (input.type === 'radio' && input.classList.contains('lesson-type-radio')) {
                        const radioName = input.getAttribute('name');
                        if (radioName && radioName.includes('lesson-type-')) {
                            const newRadioName = `lesson-type-${moduleIndex}-${lessonIndex}`;
                            input.setAttribute('name', newRadioName);
                            
                            // Update the ID too
                            const radioId = input.getAttribute('id');
                            if (radioId && radioId.startsWith('type-')) {
                                const typePrefix = radioId.split('-')[1]; // video, docs, or quiz
                                const newRadioId = `type-${typePrefix}-${moduleIndex}-${lessonIndex}`;
                                input.setAttribute('id', newRadioId);
                                
                                // Update corresponding label
                                const radioLabel = lessonItem.querySelector(`label[for="${radioId}"]`);
                                if (radioLabel) {
                                    radioLabel.setAttribute('for', newRadioId);
                                }
                            }
                        }
                    }
                });

                // Update lesson order value
                const orderInput = lessonItem.querySelector('.lesson-order');
                if (orderInput) orderInput.value = lessonIndex + 1;
            }

            function updateAllModuleOrders() {
                // Update existing modules
                const existingModules = document.querySelectorAll('#existing-modules-container .module-item');
                existingModules.forEach((moduleItem, index) => {
                    moduleItem.setAttribute('data-module-index', index);
                    updateModuleIndexes(moduleItem, index);
                    
                    // Update all lessons in this module
                    const lessonItems = moduleItem.querySelectorAll('.lesson-item');
                    lessonItems.forEach((lessonItem, lessonIndex) => {
                        updateLessonIndexes(lessonItem, index, lessonIndex);
                    });
                });

                // Update new modules
                const newModules = modulesContainer.querySelectorAll('.module-item');
                newModules.forEach((moduleItem, index) => {
                    const actualIndex = existingModules.length + index;
                    moduleItem.setAttribute('data-module-index', actualIndex);
                    updateModuleIndexes(moduleItem, actualIndex);
                    
                    // Update all lessons in this module
                    const lessonItems = moduleItem.querySelectorAll('.lesson-item');
                    lessonItems.forEach((lessonItem, lessonIndex) => {
                        updateLessonIndexes(lessonItem, actualIndex, lessonIndex);
                    });
                });
            }

            function updateLessonOrders(moduleItem) {
                const lessonItems = moduleItem.querySelectorAll('.lesson-item');
                const moduleIndex = moduleItem.getAttribute('data-module-index');
                
                lessonItems.forEach((lessonItem, index) => {
                    lessonItem.setAttribute('data-lesson-index', index);
                    updateLessonIndexes(lessonItem, moduleIndex, index);
                });
            }

            function handleFileUpload(lessonItem, fileInput) {
                const fileInfo = lessonItem.querySelector('.file-info');
                const fileName = lessonItem.querySelector('.file-name');
                const fileSize = lessonItem.querySelector('.file-size');
                
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    if (fileName) fileName.textContent = file.name;
                    if (fileSize) fileSize.textContent = `(${formatFileSize(file.size)})`;
                    if (fileInfo) fileInfo.style.display = 'block';

                    if (lessonItem.getAttribute('data-lesson-type') === '3') {
                        lessonItem.setAttribute('data-has-new-quiz-file', 'true');
                        const replaceNotice = lessonItem.querySelector('.quiz-replace-notice');
                        if (replaceNotice) {
                            replaceNotice.classList.remove('d-none');
                        }
                    }
                } else {
                    if (fileInfo) fileInfo.style.display = 'none';
                    if (lessonItem.getAttribute('data-lesson-type') === '3') {
                        lessonItem.removeAttribute('data-has-new-quiz-file');
                        const replaceNotice = lessonItem.querySelector('.quiz-replace-notice');
                        if (replaceNotice) {
                            replaceNotice.classList.add('d-none');
                        }
                    }
                }
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Department selection counter and feedback
            const departmentCheckboxes = document.querySelectorAll('input[name="SelectedDepartmentIds"]');
            const updateDepartmentCounter = () => {
                const selected = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked').length;
                const counterElement = document.querySelector('.department-counter');
                if (counterElement) {
                    counterElement.textContent = `${selected} phòng ban được chọn`;
                }
                
                // Update help text
                const helpText = document.querySelector('.departments-help');
                if (helpText) {
                    if (selected === 0) {
                        helpText.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Vui lòng chọn ít nhất 1 phòng ban';
                        helpText.className = 'text-warning small mt-2 departments-help';
                    } else {
                        helpText.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>Đã chọn ${selected} phòng ban`;
                        helpText.className = 'text-success small mt-2 departments-help';
                    }
                }
            };
            
            departmentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDepartmentCounter();
                    
                    // Add visual feedback to the department card
                    const card = this.closest('.department-check');
                    if (this.checked) {
                        card.style.background = 'linear-gradient(135deg, #e8f5e8, #f0f8f0)';
                        card.style.borderColor = '#28a745';
                        card.style.transform = 'translateY(-2px)';
                    } else {
                        card.style.background = '';
                        card.style.borderColor = '';
                        card.style.transform = '';
                    }
                });
            });
            updateDepartmentCounter();

            // Form submission enhancement
            const form = document.querySelector('.course-edit-form');
            const submitBtn = document.querySelector('.btn-save');
            
            if (form && submitBtn) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    console.log('=== FORM SUBMISSION DEBUG START ===');
                    
                    // Show loading state
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang lưu...';
                    submitBtn.disabled = true;
                    
                    // Validate department selection
                    const selectedDepts = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked');
                    if (selectedDepts.length === 0) {
                        alert('Vui lòng chọn ít nhất 1 phòng ban để áp dụng khóa học!');
                        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Lưu Thay Đổi';
                        submitBtn.disabled = false;
                        return false;
                    }
                    
                    // Build metadata JSON
                    const metadata = buildMetadataJson();
                    
                    console.log('=== METADATA STRUCTURE ===');
                    console.log('Metadata:', JSON.stringify(metadata, null, 2));
                    
                    // Validate metadata before submit
                    let hasError = false;
                    let errorMessages = [];
                    
                    // Check if there are modules
                    if (!metadata.Modules || metadata.Modules.length === 0) {
                        errorMessages.push('Khóa học phải có ít nhất 1 module!');
                        hasError = true;
                    }
                    
                    // Validate each module
                    metadata.Modules.forEach((module, idx) => {
                        if (!module.Title || module.Title.trim() === '') {
                            errorMessages.push(`Module ${idx + 1} thiếu tiêu đề!`);
                            hasError = true;
                        }
                        if (!module.Lessons || module.Lessons.length === 0) {
                            errorMessages.push(`Module "${module.Title || (idx + 1)}" phải có ít nhất 1 bài học!`);
                            hasError = true;
                        } else {
                            // Validate each lesson
                            module.Lessons.forEach((lesson, lessonIdx) => {
                                if (!lesson.Title || lesson.Title.trim() === '') {
                                    errorMessages.push(`Module "${module.Title}" - Bài học ${lessonIdx + 1} thiếu tiêu đề!`);
                                    hasError = true;
                                }
                                
                                // Validate content based on type
                                if (lesson.Type === 1) { // Video
                                    if (!lesson.ContentUrl || lesson.ContentUrl.trim() === '') {
                                        errorMessages.push(`Module ${idx + 1}, Bài học "${lesson.Title}": Vui lòng nhập URL video!`);
                                        hasError = true;
                                    }
                                } else if (lesson.Type === 2) { // Docs
                                    if (lesson.MainFileIndex === null && (!lesson.ContentUrl || lesson.ContentUrl.trim() === '')) {
                                        errorMessages.push(`Module ${idx + 1}, Bài học "${lesson.Title}": Vui lòng upload tài liệu!`);
                                        hasError = true;
                                    }
                                } else if (lesson.Type === 3) { // Quiz
                                    const hasExistingQuiz = !!lesson.QuizId;
                                    const hasNewFile = lesson.MainFileIndex !== null;
                                    if (!hasExistingQuiz && !hasNewFile) {
                                        errorMessages.push(`Module ${idx + 1}, Bài học "${lesson.Title}": Vui lòng upload file Excel Quiz!`);
                                        hasError = true;
                                    }
                                }
                            });
                        }
                    });
                    
                    if (hasError) {
                        console.error('=== VALIDATION ERRORS ===', errorMessages);
                        alert('Vui lòng kiểm tra lại thông tin:\n\n' + errorMessages.join('\n'));
                        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Lưu Thay Đổi';
                        submitBtn.disabled = false;
                        return false;
                    }
                    
                    // Count and log file inputs before disabling
                    const allFileInputs = document.querySelectorAll('.content-file-input');
                    let activeFileCount = 0;
                    console.log('=== FILE INPUTS DEBUG ===');
                    allFileInputs.forEach((input, idx) => {
                        const hasFile = input.files && input.files.length > 0;
                        const isDisabled = input.disabled;
                        console.log(`File input ${idx}: hasFile=${hasFile}, disabled=${isDisabled}, name="${input.name}"`);
                        if (hasFile && !isDisabled) {
                            activeFileCount++;
                        }
                    });
                    console.log(`Total active files: ${activeFileCount}`);
                    
                    // Disable all file inputs that don't have files (to prevent empty file submissions)
                    allFileInputs.forEach(input => {
                        if (!input.files || input.files.length === 0) {
                            input.disabled = true;
                            console.log(`Disabling empty file input: ${input.name}`);
                        } else {
                            console.log(`Keeping active file input: ${input.name}, file: ${input.files[0].name}`);
                        }
                    });
                    
                    // Set metadata to hidden input
                    document.getElementById('metadata-input').value = JSON.stringify(metadata);
                    
                    console.log('=== SUBMITTING FORM ===');
                    
                    // Submit form
                    form.submit();
                });
            }
            
            // Function to build metadata JSON from form data
            function buildMetadataJson() {
                const selectedDepts = Array.from(document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked'))
                    .map(cb => parseInt(cb.value));
                
                const modules = [];
                // Lấy modules từ cả 2 container: existing và new
                const existingModules = document.querySelectorAll('#existing-modules-container .module-item');
                const newModules = document.querySelectorAll('#modules-container .module-item');
                const allModules = [...existingModules, ...newModules];
                
                // Track file uploads to assign MainFileIndex
                let fileUploadCount = 0;
                
                allModules.forEach((moduleEl, moduleIdx) => {
                    const lessons = [];
                    const lessonEls = moduleEl.querySelectorAll('.lesson-item');
                    
                    console.log(`Processing Module ${moduleIdx + 1}:`, moduleEl);
                    
                    lessonEls.forEach((lessonEl, lessonIdx) => {
                        const lessonIdInput = lessonEl.querySelector('.lesson-id');
                        const lessonId = lessonIdInput ? parseInt(lessonIdInput.value) : null;
                        
                        // Tìm input lesson-title - có thể có nhiều input, lấy đúng cái trong card-body
                        const lessonTitleInput = lessonEl.querySelector('input.lesson-title');
                        const lessonTitle = lessonTitleInput ? lessonTitleInput.value.trim() : '';
                        
                        console.log(`  Lesson ${lessonIdx + 1}: title="${lessonTitle}", input found:`, !!lessonTitleInput);
                        
                        // Kiểm tra xem có title không, nếu không có thì báo lỗi
                        if (!lessonTitle) {
                            console.warn('Lesson không có title tại module', moduleIdx, 'lesson', lessonIdx);
                        }
                        
                        // Lấy Type từ data attribute
                                                const lessonType = lessonEl.getAttribute('data-lesson-type') ? parseInt(lessonEl.getAttribute('data-lesson-type')) : 1;
                                                const quizIdAttr = lessonEl.getAttribute('data-quiz-id');
                                                const quizId = lessonType === 3 && quizIdAttr ? parseInt(quizIdAttr) : null;
                        
                        console.log(`  Lesson ${lessonIdx + 1}: type=${lessonType}, title="${lessonTitle}"`);
                        
                        // Xử lý ContentUrl và MainFileIndex dựa trên lesson type
                        let contentUrl = null;
                        let mainFileIndex = null;
                        
                        if (lessonType === 1) {
                            // Video: lấy từ input URL hoặc data attribute
                            const videoUrlInput = lessonEl.querySelector('.lesson-video-url');
                            contentUrl = videoUrlInput?.value?.trim() || lessonEl.getAttribute('data-video-url') || lessonEl.getAttribute('data-content-url') || null;
                            console.log(`    Video lesson - ContentUrl: "${contentUrl}", MainFileIndex: null`);
                        } else {
                            // Docs/Quiz: kiểm tra xem có file upload mới không
                            const fileInput = lessonEl.querySelector('.content-file-input');
                            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                                // Có file mới được upload
                                mainFileIndex = fileUploadCount;
                                fileUploadCount++;
                                console.log(`    Docs/Quiz lesson with NEW file - MainFileIndex: ${mainFileIndex}, file: ${fileInput.files[0].name}`);
                            } else {
                                // Không có file mới, giữ URL hiện tại
                                const existingContentUrl = lessonEl.getAttribute('data-content-url') || null;
                                contentUrl = existingContentUrl && existingContentUrl.trim() !== '' ? existingContentUrl : null;
                                console.log(`    Docs/Quiz lesson with EXISTING content - ContentUrl: "${contentUrl}", MainFileIndex: null`);
                            }
                        }
                        
                        // Get Quiz settings if lesson type is Quiz
                        let quizTimeLimit = null;
                        let quizMaxAttempts = null;
                        let quizPassingScore = null;
                        
                        if (lessonType === 3) {
                            const timeLimitInput = lessonEl.querySelector('.quiz-time-limit');
                            const maxAttemptsInput = lessonEl.querySelector('.quiz-max-attempts');
                            const passingScoreInput = lessonEl.querySelector('.quiz-passing-score');
                            
                            quizTimeLimit = timeLimitInput ? parseInt(timeLimitInput.value) : 30;
                            quizMaxAttempts = maxAttemptsInput ? parseInt(maxAttemptsInput.value) : 3;
                            quizPassingScore = passingScoreInput ? parseInt(passingScoreInput.value) : 70;
                        }
                        
                        const lessonData = {
                            LessonId: lessonId,
                            Title: lessonTitle,
                            Description: '',
                            Type: lessonType,
                            OrderIndex: lessonIdx + 1,
                            ContentUrl: contentUrl,
                            AttachmentUrl: null,
                            QuizId: quizId,
                            IsQuizExcel: lessonType === 3 && mainFileIndex !== null,
                            QuizTitle: lessonType === 3 ? lessonTitle : null,
                            QuizTimeLimit: quizTimeLimit,
                            QuizMaxAttempts: quizMaxAttempts,
                            QuizPassingScore: quizPassingScore,
                            MainFileIndex: mainFileIndex
                        };
                        lessons.push(lessonData);
                    });
                    
                    const moduleIdInput = moduleEl.querySelector('.module-id');
                    const moduleId = moduleIdInput ? parseInt(moduleIdInput.value) : null;
                    
                    // Tìm input module-title
                    const moduleTitleInput = moduleEl.querySelector('input.module-title');
                    const moduleTitle = moduleTitleInput ? moduleTitleInput.value.trim() : '';
                    
                    console.log(`  Module title input found:`, !!moduleTitleInput, `value="${moduleTitle}"`);
                    
                    // Tìm textarea module-description
                    const moduleDescInput = moduleEl.querySelector('textarea.module-description');
                    const moduleDesc = moduleDescInput ? moduleDescInput.value.trim() : '';
                    
                    // Kiểm tra xem có title không
                    if (!moduleTitle) {
                        console.warn('Module không có title tại index', moduleIdx, 'Element:', moduleEl);
                    }
                    
                    // Kiểm tra module phải có ít nhất 1 lesson
                    if (lessons.length === 0) {
                        console.warn('Module không có lesson tại index', moduleIdx);
                    }
                    
                    const moduleData = {
                        ModuleId: moduleId,
                        Title: moduleTitle,
                        Description: moduleDesc,
                        OrderIndex: moduleIdx + 1,
                        Lessons: lessons
                    };
                    modules.push(moduleData);
                });
                
                return {
                    CourseName: document.getElementById('CourseName')?.value || '',
                    CourseCode: document.getElementById('Code')?.value || '',
                    Description: document.getElementById('Description')?.value || '',
                    CourseCategoryId: parseInt(document.getElementById('Category')?.value) || 0,
                    Duration: parseInt(document.getElementById('Duration')?.value) || 0,
                    Level: document.getElementById('Level')?.value || 'Beginner',
                    IsOnline: document.getElementById('IsOnline')?.checked || false,
                    IsMandatory: document.getElementById('IsMandatory')?.checked || false,
                    Departments: selectedDepts,
                    Modules: modules
                };
            }

            // Enhanced form validation feedback
            const inputs = document.querySelectorAll('.form-control, .form-select');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        this.classList.add('is-valid');
                        this.classList.remove('is-invalid');
                    }
                });

                input.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
            });

            // Level selection with visual feedback
            const levelSelect = document.querySelector('#Level');
            if (levelSelect) {
                levelSelect.addEventListener('change', function() {
                    const value = this.value.toLowerCase();
                    let color = '#6c757d';
                    
                    switch(value) {
                        case 'cơ bản':
                            color = '#28a745';
                            break;
                        case 'trung cấp':
                            color = '#ffc107';
                            break;
                        case 'nâng cao':
                            color = '#dc3545';
                            break;
                    }
                    
                    this.style.borderColor = color;
                    this.style.boxShadow = `0 0 0 0.2rem ${color}25`;
                    
                    setTimeout(() => {
                        this.style.borderColor = '';
                        this.style.boxShadow = '';
                    }, 2000);
                });
            }

            // Status toggle enhancement
            const statusToggle = document.querySelector('#IsActive');
            if (statusToggle) {
                statusToggle.addEventListener('change', function() {
                    const label = this.nextElementSibling.querySelector('span');
                    if (this.checked) {
                        label.textContent = 'Khóa học đang hoạt động';
                        label.className = 'fw-semibold text-success';
                    } else {
                        label.textContent = 'Khóa học tạm dừng';
                        label.className = 'fw-semibold text-warning';
                    }
                });
            }
        });
    </script>
}