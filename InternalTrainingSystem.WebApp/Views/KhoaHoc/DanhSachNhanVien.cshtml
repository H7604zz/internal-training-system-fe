@model List<InternalTrainingSystem.WebApp.Models.DTOs.EligibleStaffDto>
@using InternalTrainingSystem.WebApp.Constants
@using InternalTrainingSystem.WebApp.Extensions
@{
    ViewData["Title"] = "Danh Sách Nhân Viên Khóa Học";
    var course = ViewBag.Course as InternalTrainingSystem.WebApp.Models.DTOs.CourseDto;
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/danh-sach-nhan-vien.css" asp-append-version="true" />
}

<div class="employee-list-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="employee-list-header">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h1 class="employee-list-title">
                            <i class="fas fa-users me-3"></i>Danh Sách Nhân Viên Khóa Học
                        </h1>

                        @if (course != null)
                        {
                            <div class="course-info">
                                <h4><i class="fas fa-graduation-cap me-2"></i>@course.CourseName</h4>
                                <p class="mb-2"><strong>Mã khóa học:</strong> @course.Code</p>
                                <p class="mb-0"><strong>Mô tả:</strong> @course.Description</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="search-filter-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>Tìm Kiếm & Lọc
                </h5>

                <!-- Finalize Button - Only visible for DirectManager -->
                @if (ViewBag.UserRole?.ToString() == UserRoles.DirectManager)
                {
                    
                }
                <div id="finalizeButtonContainer">
                    @if (ViewBag.IsFinalized != true)
                    {
                        <button type="button" class="btn btn-success btn-finalize" onclick="finalizeEnrollments()">
                            <i class="fas fa-check-circle me-1"></i>Chốt Danh Sách
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-primary" onclick="openCreateClassModal()" title="Tạo lớp học và gửi thông báo đến nhân viên">
                            <i class="fas fa-plus-circle me-1"></i>Tạo Lớp Học
                        </button>
                    }
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="openCourseClassesModal()" title="Xem các lớp thuộc khóa học này">
                        <i class="fas fa-chalkboard-teacher me-1"></i>Xem Lớp Học
                    </button>
                </div>
            </div>

            <form method="get" class="search-form">
                <input type="hidden" name="id" value="@ViewBag.CourseId" />
                <div class="row g-3">
                    <div class="col-lg-4 col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mã NV/Tên/Email</label>
                            <input type="text" class="form-control" name="search" 
                            value="@ViewBag.Search" placeholder="Nhập mã nhân viên, tên hoặc email...">
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="form-group">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" name="status">
                                <option value="">Tất cả trạng thái</option>
                                <option value="@EnrollmentConstants.Status.NotEnrolled" selected="@(ViewBag.Status == EnrollmentConstants.Status.NotEnrolled)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.NotEnrolled)</option>
                                <option value="@EnrollmentConstants.Status.Enrolled" selected="@(ViewBag.Status == EnrollmentConstants.Status.Enrolled)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.Enrolled)</option>
                                <option value="@EnrollmentConstants.Status.InProgress" selected="@(ViewBag.Status == EnrollmentConstants.Status.InProgress)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.InProgress)</option>
                                <option value="@EnrollmentConstants.Status.Completed" selected="@(ViewBag.Status == EnrollmentConstants.Status.Completed)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.Completed)</option>
                                <option value="@EnrollmentConstants.Status.Dropped" selected="@(ViewBag.Status == EnrollmentConstants.Status.Dropped)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.Dropped)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12">
                        <div class="form-group">
                            <label class="form-label d-block">&nbsp;</label>
                            <div class="search-buttons">
                                <button type="submit" class="btn-search">
                                    <i class="fas fa-search me-1"></i>Tìm kiếm
                                </button>
                                <a href="@Url.Action("DanhSachNhanVien", "KhoaHoc", new { id = ViewBag.CourseId })" class="btn-reset">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Employee List (Table) -->
        <div class="employees-list">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle employee-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px;" class="text-center">STT</th>
                            <th style="width: 140px;">Mã NV</th>
                            <th>Email</th>
                            <th style="min-width: 220px;">Họ và tên</th>
                            <th>Phòng ban</th>
                            <th>Chức vụ</th>
                            <th style="width: 140px;" class="text-center">Trạng thái</th>
                            <th style="min-width: 200px;">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            int startIndex = (ViewBag.CurrentPage != null && ViewBag.PageSize != null) 
                                ? ((int)ViewBag.CurrentPage - 1) * (int)ViewBag.PageSize + 1 
                                : 1; 
                            var stt = startIndex; 
                            foreach (var employee in Model)
                            {
                                <tr data-status="@employee.Status.ToLower()">
                                    <td class="text-center">@stt</td>
                                    <td class="fw-semibold">@employee.EmployeeId</td>
                                    <td class="text-primary">@employee.Email</td>
                                    <td>@employee.FullName</td>
                                    <td>@employee.Department</td>
                                    <td>@employee.Position</td>
                                    <td class="text-center">
                                        <span class="status-badge @employee.StatusBadgeClass">@employee.StatusText</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(employee.Reason))
                                        {
                                            @employee.Reason
                                        }
                                    </td>
                                </tr>
                                stt++;
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="empty-state mb-0">
                                        <i class="fas fa-users-slash"></i>
                                        <h5 class="mt-2 mb-1">Không tìm thấy nhân viên nào</h5>
                                        <div class="text-muted">Không có nhân viên nào phù hợp với bộ lọc hiện tại.</div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            var paginationModel = new InternalTrainingSystem.WebApp.Models.ViewModels.PaginationViewModel
            {
                CurrentPage = ViewBag.CurrentPage,
                TotalPages = ViewBag.TotalPages,
                PageSize = ViewBag.PageSize,
                TotalItems = ViewBag.TotalItems,
                ActionName = "DanhSachNhanVien",
                ControllerName = "KhoaHoc",
                RouteValues = new Dictionary<string, object>
                {
                    { "id", ViewBag.CourseId },
                    { "employeeId", ViewBag.EmployeeId ?? "" },
                    { "status", ViewBag.Status ?? "" }
                }
            };

            @await Html.PartialAsync("_Pagination", paginationModel)
        }
    </div>
</div>

@{
    // Sử dụng TotalEnrolledCount từ ViewBag (đã được tính chính xác từ API)
    var enrolledCount = ViewBag.TotalEnrolledCount != null ? (int)ViewBag.TotalEnrolledCount : 0;
    
    var createClassModel = new InternalTrainingSystem.WebApp.Models.DTOs.CreateClassViewModel
    {
        CourseId = ViewBag.CourseId != null ? (int)ViewBag.CourseId : 0,
        CourseName = course?.CourseName ?? "",
        TotalEmployees = enrolledCount
    };
}

@await Html.PartialAsync("_CreateClassModal", createClassModel)

<!-- Modal: Danh sách lớp của khóa học -->
<div class="modal fade" id="courseClassesModal" tabindex="-1" aria-labelledby="courseClassesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseClassesModalLabel">
                    <i class="fas fa-chalkboard me-2"></i>Danh Sách Lớp Học Của Khóa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="classesLoading" class="text-center py-4 d-none">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <div class="mt-2">Đang tải danh sách lớp...</div>
                </div>
                <div id="classesError" class="d-none"></div>
                <div id="classesEmpty" class="empty-state d-none">
                    <i class="fas fa-chalkboard fa-3x"></i>
                    <h5 class="mt-2">Chưa có lớp nào cho khóa học này</h5>
                </div>
                <div id="classesTableWrapper" class="table-responsive d-none">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 100px;">Mã Lớp</th>
                                <th>Tên Lớp</th>
                                <th style="width: 220px;">Mentor</th>
                                <th style="width: 120px;" class="text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="classesTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        function finalizeEnrollments() {
            const courseId = @ViewBag.CourseId;
            
            // Confirm dialog
            if (!confirm('Bạn có chắc chắn muốn chốt danh sách nhân viên tham gia khóa học này? Sau khi chốt sẽ không thể thay đổi.')) {
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';
            button.disabled = true;

            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("FinalizeEnrollments", "KhoaHoc")';
            
            // Add anti-forgery token
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = $('input[name="__RequestVerificationToken"]').val();
            form.appendChild(tokenInput);
            
            // Add course ID
            const courseIdInput = document.createElement('input');
            courseIdInput.type = 'hidden';
            courseIdInput.name = 'courseId';
            courseIdInput.value = courseId;
            form.appendChild(courseIdInput);
            
            // Submit form
            document.body.appendChild(form);
            form.submit();
        }
        
        function openCreateClassModal() {
            // Debug information
            console.log('Button clicked - trying to open modal');
            const isFinalized = @Json.Serialize(ViewBag.IsFinalized);
            console.log('ViewBag.IsFinalized:', isFinalized);
            
            // Check if finalization is done
            if (isFinalized !== true) {
                alert('Vui lòng chốt danh sách nhân viên trước khi tạo lớp học!');
                return;
            }
            
            // Check if modal exists before trying to open it
            const modalElement = document.getElementById('createClassModal');
            console.log('Modal element found:', modalElement !== null);
            
            if (!modalElement) {
                console.error('Create class modal not found');
                alert('Lỗi: Không tìm thấy modal tạo lớp học. Vui lòng thử lại sau.');
                return;
            }
            
            // Update modal data if needed
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Fetch and show classes for current course
        async function openCourseClassesModal() {
            const courseId = @ViewBag.CourseId;
            const modalEl = document.getElementById('courseClassesModal');
            const loadingEl = document.getElementById('classesLoading');
            const errorEl = document.getElementById('classesError');
            const emptyEl = document.getElementById('classesEmpty');
            const tableWrapperEl = document.getElementById('classesTableWrapper');
            const tbodyEl = document.getElementById('classesTableBody');

            // Reset states
            errorEl.classList.add('d-none');
            emptyEl.classList.add('d-none');
            tableWrapperEl.classList.add('d-none');
            tbodyEl.innerHTML = '';
            loadingEl.classList.remove('d-none');

            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                const res = await fetch(`/lop-hoc/by-course/${courseId}`);
                
                const contentType = res.headers.get('content-type') || '';
                
                let payload = null;
                if (contentType.includes('application/json')) {
                    payload = await res.json();
                } else {
                    const text = await res.text();
                    payload = { success: res.ok, message: text, data: [] };
                }

                loadingEl.classList.add('d-none');

                // 404 means no classes found - this is a valid state, not an error
                if (res.status === 404) {
                    emptyEl.classList.remove('d-none');
                    return;
                }

                // Handle other non-success status codes as errors
                if (!res.ok || payload?.success === false) {
                    const errorMessage = payload?.message || 'Không thể tải danh sách lớp học.';
                    errorEl.textContent = errorMessage;
                    errorEl.classList.remove('d-none');
                    return;
                }

                const list = payload?.data || [];
                
                if (!Array.isArray(list) || list.length === 0) {
                    emptyEl.classList.remove('d-none');
                    return;
                }

                // Render rows
                for (const cls of list) {
                    const id = cls.classId;
                    const name = cls.className || `Lớp #${id}`;
                    const mentor = cls.mentorName || '';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="fw-semibold">#${id}</span></td>
                        <td>${name}</td>
                        <td>${mentor}</td>
                        <td class="text-center">
                            <a class="btn btn-sm btn-outline-primary" href="/lop-hoc/chi-tiet/${id}">
                                <i class="fas fa-external-link-alt me-1"></i>Chi tiết
                            </a>
                        </td>
                    `;
                    tbodyEl.appendChild(tr);
                }

                tableWrapperEl.classList.remove('d-none');
            } catch (e) {
                loadingEl.classList.add('d-none');
                errorEl.textContent = `Lỗi: ${e.message || 'Đã xảy ra lỗi khi tải danh sách lớp học.'}`;
                errorEl.classList.remove('d-none');
            }
        }

        // Handle create class form submission
        document.addEventListener('DOMContentLoaded', function() {
            const createClassForm = document.getElementById('createClassForm');
            if (createClassForm) {
                createClassForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Show loading state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo lớp...';
                    submitBtn.disabled = true;
                    
                    // Submit form
                    this.submit();
                });
            }
        });
    </script>
}
