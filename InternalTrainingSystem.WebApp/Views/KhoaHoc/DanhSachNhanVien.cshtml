@model List<InternalTrainingSystem.WebApp.Models.DTOs.EligibleStaffDto>
@using InternalTrainingSystem.WebApp.Constants
@using InternalTrainingSystem.WebApp.Extensions
@{
    ViewData["Title"] = "Danh Sách Nhân Viên Khóa Học";
    var course = ViewBag.Course as InternalTrainingSystem.WebApp.Models.DTOs.CourseDto;
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/danh-sach-nhan-vien.css" asp-append-version="true" />
}

<div class="employee-list-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="employee-list-header">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h1 class="employee-list-title">
                            <i class="fas fa-users me-3"></i>Danh Sách Nhân Viên Khóa Học
                        </h1>

                        @if (course != null)
                        {
                            <div class="course-info">
                                <h4><i class="fas fa-graduation-cap me-2"></i>@course.CourseName</h4>
                                <p class="mb-2"><strong>Mã khóa học:</strong> @course.Code</p>
                                <p class="mb-0"><strong>Mô tả:</strong> @course.Description</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Search & Filter -->
        <div class="search-filter-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>Tìm Kiếm & Lọc
                </h5>

                <!-- Finalize Button - Only visible for DirectManager -->
                @if (ViewBag.UserRole?.ToString() == UserRoles.DirectManager)
                {
                    <div id="finalizeButtonContainer">
                        @if (ViewBag.IsFinalized != true)
                        {
                            <button type="button" class="btn btn-success btn-finalize" onclick="finalizeEnrollments()">
                                <i class="fas fa-check-circle me-1"></i>Chốt Danh Sách
                            </button>
                        }

                        <!-- Create Class Button - Only show if enrollments are finalized -->
                        @if (ViewBag.IsFinalized == true)
                        {
                            <button type="button" class="btn btn-primary" onclick="openCreateClassModal()">
                                <i class="fas fa-plus me-1"></i>Tạo Lớp Học
                            </button>
                        }
                    </div>
                }
            </div>

            <form method="get" class="search-form">
                <input type="hidden" name="id" value="@ViewBag.CourseId" />
                <div class="row g-3">
                    <div class="col-lg-4 col-md-6">
                        <div class="form-group">
                            <label class="form-label">Mã NV/Tên/Email</label>
                            <input type="text" class="form-control" name="search" 
                            value="@ViewBag.Search" placeholder="Nhập mã nhân viên, tên hoặc email...">
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6">
                        <div class="form-group">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" name="status">
                                <option value="">Tất cả trạng thái</option>
                                <option value="@EnrollmentConstants.Status.NotEnrolled" selected="@(ViewBag.Status == EnrollmentConstants.Status.NotEnrolled)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.NotEnrolled)</option>
                                <option value="@EnrollmentConstants.Status.Enrolled" selected="@(ViewBag.Status == EnrollmentConstants.Status.Enrolled)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.Enrolled)</option>
                                <option value="@EnrollmentConstants.Status.InProgress" selected="@(ViewBag.Status == EnrollmentConstants.Status.InProgress)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.InProgress)</option>
                                <option value="@EnrollmentConstants.Status.Completed" selected="@(ViewBag.Status == EnrollmentConstants.Status.Completed)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.Completed)</option>
                                <option value="@EnrollmentConstants.Status.Dropped" selected="@(ViewBag.Status == EnrollmentConstants.Status.Dropped)">@EnrollmentConstants.GetDisplayText(EnrollmentConstants.Status.Dropped)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-12">
                        <div class="form-group">
                            <label class="form-label d-block">&nbsp;</label>
                            <div class="search-buttons">
                                <button type="submit" class="btn-search">
                                    <i class="fas fa-search me-1"></i>Tìm kiếm
                                </button>
                                <a href="@Url.Action("DanhSachNhanVien", "KhoaHoc", new { id = ViewBag.CourseId })" class="btn-reset">
                                    <i class="fas fa-undo me-1"></i>Reset
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Employee List -->
        <div class="employees-list">
            @if (Model != null && Model.Any())
            {
                @foreach (var employee in Model)
                {
                    <div class="employee-card" data-status="@employee.Status.ToLower()">
                        <div class="employee-header-card">
                            <div class="employee-info">
                                <div class="employee-avatar">
                                    @(employee.FullName.Split(' ').LastOrDefault()?.FirstOrDefault().ToString().ToUpper())
                                </div>
                                <div class="employee-details">
                                    <h5>@employee.FullName</h5>
                                    <div class="employee-meta">
                                        <i class="fas fa-id-card me-1"></i>Mã NV: @employee.EmployeeId
                                    </div>
                                    <div class="employee-meta">
                                        <i class="fas fa-building me-1"></i>@employee.Department
                                    </div>
                                    <div class="employee-meta">
                                        <i class="fas fa-user-tie me-1"></i>@employee.Position
                                    </div>
                                </div>
                                <div class="response-status">
                                    <span class="status-badge @employee.StatusBadgeClass">
                                        @employee.StatusText
                                    </span>
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(employee.Reason) || !string.IsNullOrEmpty(employee.Email))
                        {
                            <div class="employee-body">
                                @if (!string.IsNullOrEmpty(employee.Reason))
                                {
                                    <div class="employee-note">
                                        <i class="fas fa-comment-alt me-2"></i>
                                        <strong>Ghi chú:</strong> @employee.Reason
                                    </div>
                                }

                                <div class="d-flex justify-content-between align-items-center">
                                    @if (!string.IsNullOrEmpty(employee.Email))
                                    {
                                        <div class="contact-info">
                                            <i class="fas fa-envelope me-1"></i>
                                            <span>@employee.Email</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-users-slash"></i>
                    <h3>Không tìm thấy nhân viên nào</h3>
                    <p>Không có nhân viên nào phù hợp với bộ lọc hiện tại.</p>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            var paginationModel = new InternalTrainingSystem.WebApp.Models.ViewModels.PaginationViewModel
            {
                CurrentPage = ViewBag.CurrentPage,
                TotalPages = ViewBag.TotalPages,
                PageSize = ViewBag.PageSize,
                TotalItems = ViewBag.TotalItems,
                ActionName = "DanhSachNhanVien",
                ControllerName = "KhoaHoc",
                RouteValues = new Dictionary<string, object>
                {
                    { "id", ViewBag.CourseId },
                    { "employeeId", ViewBag.EmployeeId ?? "" },
                    { "status", ViewBag.Status ?? "" }
                }
            };

            @await Html.PartialAsync("_Pagination", paginationModel)
        }
    </div>
</div>

<!-- Include Create Class Modal -->
<!-- Debug: ViewBag.IsFinalized = @ViewBag.IsFinalized -->
@if (ViewBag.IsFinalized == true)
{
    <!-- Modal sẽ được include ở đây -->
    var createClassModel = new InternalTrainingSystem.WebApp.Models.DTOs.CreateClassViewModel
    {
        CourseId = (int)ViewBag.CourseId,
        CourseName = course?.CourseName ?? "",
        TotalEmployees = ViewBag.FinalizedEmployeeCount ?? 0
    };

    await Html.PartialAsync("_CreateClassModal", createClassModel);
}
else
{
    <!-- Modal KHÔNG được include vì ViewBag.IsFinalized = @ViewBag.IsFinalized -->
}

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        function finalizeEnrollments() {
            const courseId = @ViewBag.CourseId;
            
            // Confirm dialog
            if (!confirm('Bạn có chắc chắn muốn chốt danh sách nhân viên tham gia khóa học này? Sau khi chốt sẽ không thể thay đổi.')) {
                return;
            }

            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';
            button.disabled = true;

            // Create form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("FinalizeEnrollments", "KhoaHoc")';
            
            // Add anti-forgery token
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = '__RequestVerificationToken';
            tokenInput.value = $('input[name="__RequestVerificationToken"]').val();
            form.appendChild(tokenInput);
            
            // Add course ID
            const courseIdInput = document.createElement('input');
            courseIdInput.type = 'hidden';
            courseIdInput.name = 'courseId';
            courseIdInput.value = courseId;
            form.appendChild(courseIdInput);
            
            // Submit form
            document.body.appendChild(form);
            form.submit();
        }
        
        function openCreateClassModal() {
            // Debug information
            console.log('Button clicked - trying to open modal');
            const isFinalized = @Json.Serialize(ViewBag.IsFinalized);
            console.log('ViewBag.IsFinalized:', isFinalized);
            
            // Check if finalization is done
            if (isFinalized !== true) {
                alert('Vui lòng chốt danh sách nhân viên trước khi tạo lớp học!');
                return;
            }
            
            // Check if modal exists before trying to open it
            const modalElement = document.getElementById('createClassModal');
            console.log('Modal element found:', modalElement !== null);
            
            if (!modalElement) {
                console.error('Create class modal not found');
                alert('Lỗi: Không tìm thấy modal tạo lớp học. Vui lòng thử lại sau.');
                return;
            }
            
            // Update modal data if needed
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Handle create class form submission
        document.addEventListener('DOMContentLoaded', function() {
            const createClassForm = document.getElementById('createClassForm');
            if (createClassForm) {
                createClassForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Show loading state
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tạo lớp...';
                    submitBtn.disabled = true;
                    
                    // Submit form
                    this.submit();
                });
            }
        });
    </script>
}
