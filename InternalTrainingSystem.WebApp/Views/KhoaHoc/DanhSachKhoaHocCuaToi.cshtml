@model List<InternalTrainingSystem.WebApp.Models.DTOs.EmployeeCourseDto>
@{
    ViewData["Title"] = "Khóa Học Của Tôi";
}

@section Styles {
    <link rel="stylesheet" href="~/css/danh-sach-khoa-hoc-nhan-vien.css" asp-append-version="true" />
}

<div class="employee-courses-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="page-header">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <h1 class="page-title">
                            <i class="fas fa-graduation-cap me-3"></i>Khóa Học Của Tôi
                        </h1>
                        <p class="page-subtitle">Quản lý và theo dõi các khóa học bạn được mời tham gia</p>

                        <!-- Statistics -->
                        <div class="stats-row">
                            <div class="stat-item">
                                <div class="stat-number">@ViewBag.TotalCourses</div>
                                <div class="stat-label">Tổng khóa học</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">@ViewBag.AcceptedCount</div>
                                <div class="stat-label">Đã tham gia</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">@ViewBag.PendingCount</div>
                                <div class="stat-label">Chờ phản hồi</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">@ViewBag.DeclinedCount</div>
                                <div class="stat-label">Đã từ chối</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Filter Tabs -->
        <div class="filter-section">
            <div class="container">
                <div class="filter-tabs">
                    <a href="@Url.Action("DanhSachKhoaHocCuaToi", "KhoaHoc", new { status = "all", page = 1 })" 
                       class="filter-tab @(ViewBag.CurrentStatus == "all" ? "active" : "")">
                        <i class="fas fa-list me-2"></i>Tất cả (@ViewBag.TotalCourses)
                    </a>
                    <a href="@Url.Action("DanhSachKhoaHocCuaToi", "KhoaHoc", new { status = "pending", page = 1 })" 
                       class="filter-tab @(ViewBag.CurrentStatus == "pending" ? "active" : "")">
                        <i class="fas fa-clock me-2"></i>Chờ phản hồi (@ViewBag.PendingCount)
                    </a>
                    <a href="@Url.Action("DanhSachKhoaHocCuaToi", "KhoaHoc", new { status = "accepted", page = 1 })" 
                       class="filter-tab @(ViewBag.CurrentStatus == "accepted" ? "active" : "")">
                        <i class="fas fa-check-circle me-2"></i>Đã tham gia (@ViewBag.AcceptedCount)
                    </a>
                    <a href="@Url.Action("DanhSachKhoaHocCuaToi", "KhoaHoc", new { status = "declined", page = 1 })" 
                       class="filter-tab @(ViewBag.CurrentStatus == "declined" ? "active" : "")">
                        <i class="fas fa-times-circle me-2"></i>Đã từ chối (@ViewBag.DeclinedCount)
                    </a>
                </div>
            </div>
        </div>

        <!-- Course List -->
        <div class="courses-section">
            <div class="container">
                @if (Model != null && Model.Any())
                {
                    <div class="courses-grid">
                        @foreach (var course in Model)
                        {
                            <div class="course-card" data-course-id="@course.CourseId">
                                <!-- Course Header -->
                                <div class="course-header">
                                    <div class="course-info">
                                        <h4 class="course-title">@course.CourseName</h4>
                                        <div class="course-meta">
                                            <span class="course-code">
                                                <i class="fas fa-tag me-1"></i>@course.CourseCode
                                            </span>
                                            <span class="course-duration">
                                                <i class="fas fa-clock me-1"></i>@course.Duration
                                            </span>
                                        </div>
                                    </div>
                                    <div class="course-badges">
                                        <span class="badge @course.StatusBadgeClass">
                                            <i class="fas @course.StatusIcon me-1"></i>@course.StatusText
                                        </span>
                                        <span class="badge @course.LevelBadgeClass">
                                            @course.LevelDisplay
                                        </span>
                                        <span class="badge @course.CourseStatusBadgeClass">
                                            @course.CourseStatusText
                                        </span>
                                    </div>
                                </div>

                                <!-- Course Body -->
                                <div class="course-body">
                                    <p class="course-description">@course.Description</p>
                                    
                                    <div class="course-details">
                                        <div class="detail-row">
                                            <i class="fas fa-calendar-alt me-2"></i>
                                            <strong>Thời gian: </strong> @course.StartDateDisplay đến @course.EndDateDisplay
                                        </div>
                                        <div class="detail-row">
                                            <i class="fas fa-user-tie me-2"></i>
                                            <strong>Giảng viên: </strong> @course.TrainerName
                                        </div>
                                        <div class="detail-row">
                                            <i class="fas fa-building me-2"></i>
                                            <strong>Phòng ban: </strong> @course.DepartmentName
                                        </div>
                                        <div class="detail-row">
                                            <i class="fas fa-users me-2"></i>
                                            <strong>Học viên: </strong> @course.CurrentParticipants/@course.MaxParticipants
                                        </div>
                                        <div class="detail-row">
                                            <i class="fas fa-paper-plane me-2"></i>
                                            <strong>Ngày mời: </strong> @course.InvitedDateDisplay
                                        </div>
                                        @if (course.ResponseDate.HasValue)
                                        {
                                            <div class="detail-row">
                                                <i class="fas fa-reply me-2"></i>
                                                <strong>Ngày phản hồi: </strong> @course.ResponseDateDisplay
                                            </div>
                                        }
                                        @if (course.IsPending && course.DaysLeftToRespond > 0)
                                        {
                                            <div class="detail-row text-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Còn @course.DaysLeftToRespond ngày để phản hồi</strong>
                                            </div>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(course.Note))
                                    {
                                        <div class="course-note">
                                            <i class="fas fa-comment-alt me-2"></i>
                                            <strong>Ghi chú:</strong> @course.Note
                                        </div>
                                    }
                                </div>

                                <!-- Course Actions -->
                                @if (course.IsPending)
                                {
                                    <div class="course-actions">
                                        <button type="button" class="btn btn-success" onclick="showResponseModal(@course.CourseId, 'Accepted', '@course.CourseName')">
                                            <i class="fas fa-check me-1"></i>Tham gia
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="showResponseModal(@course.CourseId, 'Declined', '@course.CourseName')">
                                            <i class="fas fa-times me-1"></i>Từ chối
                                        </button>
                                    </div>
                                }
                                else if (course.IsAccepted && course.Status == "Open")
                                {
                                    <div class="course-actions">
                                        <button type="button" class="btn btn-outline-warning" onclick="showResponseModal(@course.CourseId, 'Declined', '@course.CourseName')">
                                            <i class="fas fa-times me-1"></i>Hủy tham gia
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (ViewBag.TotalPages >= 1)
                    {
                        @await Html.PartialAsync("_Pagination", new InternalTrainingSystem.WebApp.Models.ViewModels.PaginationViewModel(
                            ViewBag.CurrentPage ?? 1,
                            ViewBag.TotalPages ?? 1,
                            ViewBag.PageSize ?? InternalTrainingSystem.WebApp.Constants.PaginationConstants.EmployeeCoursePageSize,
                            "DanhSachKhoaHocCuaToi",
                            "KhoaHoc",
                            new Dictionary<string, object>
                            {
                                ["status"] = ViewBag.CurrentStatus ?? "all"
                            }
                        ) { AriaLabel = "Phân trang khóa học của tôi", TotalItems = ViewBag.TotalItems })
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>Chưa có khóa học nào</h3>
                        @if (ViewBag.CurrentStatus == "all")
                        {
                            <p>Bạn chưa được mời tham gia khóa học nào.</p>
                        }
                        else
                        {
                            <p>Không có khóa học nào ở trạng thái này.</p>
                            <a href="@Url.Action("DanhSachKhoaHocCuaToi", "KhoaHoc", new { status = "all" })" class="btn btn-primary">
                                <i class="fas fa-list me-1"></i>Xem tất cả khóa học
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="responseModalLabel">Phản hồi khóa học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="responseForm">
                    <input type="hidden" id="courseId" />
                    <input type="hidden" id="responseType" />
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <strong>Khóa học:</strong> <span id="courseName"></span>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">
                            <strong>Phản hồi:</strong> <span id="responseText" class="fw-bold"></span>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="note" class="form-label">Ghi chú (tùy chọn)</label>
                        <textarea class="form-control" id="note" rows="3" placeholder="Nhập ghi chú của bạn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn" id="confirmBtn" onclick="submitResponse()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentCourseId = null;
        let currentResponseType = null;

        function showResponseModal(courseId, responseType, courseName) {
            currentCourseId = courseId;
            currentResponseType = responseType;
            
            document.getElementById('courseId').value = courseId;
            document.getElementById('responseType').value = responseType;
            document.getElementById('courseName').textContent = courseName;
            document.getElementById('note').value = '';
            
            const responseText = responseType === 'Accepted' ? 'Tham gia khóa học' : 'Từ chối tham gia';
            document.getElementById('responseText').textContent = responseText;
            
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.className = responseType === 'Accepted' ? 'btn btn-success' : 'btn btn-danger';
            confirmBtn.innerHTML = responseType === 'Accepted' ? '<i class="fas fa-check me-1"></i>Xác nhận tham gia' : '<i class="fas fa-times me-1"></i>Xác nhận từ chối';
            
            const modal = new bootstrap.Modal(document.getElementById('responseModal'));
            modal.show();
        }

        function submitResponse() {
            const courseId = document.getElementById('courseId').value;
            const responseType = document.getElementById('responseType').value;
            const note = document.getElementById('note').value;
            
            if (!courseId || !responseType) {
                alert('Dữ liệu không hợp lệ!');
                return;
            }
            
            // Show loading state
            const confirmBtn = document.getElementById('confirmBtn');
            const originalContent = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';
            
            // Call API
            fetch('@Url.Action("PhanHoiKhoaHoc", "KhoaHoc")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    courseId: parseInt(courseId),
                    responseType: responseType,
                    note: note
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert(data.message);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('responseModal'));
                    modal.hide();
                    
                    // Reload page to reflect changes
                    window.location.reload();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi gửi phản hồi. Vui lòng thử lại!');
            })
            .finally(() => {
                // Reset button
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalContent;
            });
        }

        // Auto refresh every 5 minutes to check for new courses
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                window.location.reload();
            }
        }, 5 * 60 * 1000);
    </script>
}