@model InternalTrainingSystem.WebApp.Models.DTOs.CourseLearningDto
@{
    ViewData["Title"] = "Học tập - " + Model.CourseName;
}

@section Styles {
    <link rel="stylesheet" href="~/css/hoc-tap.css" asp-append-version="true" />
    <style>
        /* Lightweight inline styles for lazy video UI */
        .video-lazy { position: relative; background:#000; border-radius:12px; overflow:hidden; min-height:320px; display:flex; align-items:center; justify-content:center; }
        .video-lazy-thumb { position:absolute; inset:0; background:#000 center/cover no-repeat; filter:brightness(0.6); }
        .video-lazy .play-btn-big { position:relative; z-index:2; display:flex; align-items:center; gap:.5rem; padding:.75rem 1.25rem; border-radius:999px; border:none; background:#d93025; color:#fff; font-weight:600; box-shadow:0 4px 16px rgba(0,0,0,.25); }
        .video-lazy .play-btn-big i { font-size:1rem; }
        .video-lazy .spinner-wrap { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:3; }
        
        /* Completed status badge */
        #lesson-completed-status .badge {
            font-size: 0.95rem;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
    </style>
}

<div class="learning-container">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="learning-header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center mb-2">
                            <a href="@Url.Action("DanhSachKhoaHocCuaToi", "KhoaHoc")" class="btn btn-back me-3">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <div>
                                <h1 class="course-title mb-1">@Model.CourseName</h1>
                                <div class="course-meta">
                                    <span class="badge badge-info me-2">
                                        <i class="fas fa-tag me-1"></i>@Model.CourseCode
                                    </span>
                                </div>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <p class="course-description">@Model.Description</p>
                        }
                    </div>
                    <div class="col-md-8">
                        <div class="progress-card">
                            <div class="progress-info">
                                <span class="progress-label">Tiến độ học tập</span>
                                <span class="progress-value">@Model.ProgressDisplay</span>
                            </div>
                            <div class="progress progress-custom">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: @Model.Progress%" 
                                     aria-valuenow="@Model.Progress" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="learning-content">
            <div class="container">
                <div class="row">
                    <!-- Sidebar - Course Outline -->
                    <div class="col-lg-4">
                        <div class="course-outline">
                            <div class="outline-header">
                                <h3>
                                    <i class="fas fa-list-ul me-2"></i>Nội dung khóa học
                                </h3>
                            </div>
                            <div class="outline-body">
                                @if (Model.Modules != null && Model.Modules.Any())
                                {
                                    @foreach (var module in Model.Modules.OrderBy(m => m.OrderIndex))
                                    {
                                        <div class="module-item @(module.IsCompleted ? "completed" : "")">
                                            <div class="module-header" data-bs-toggle="collapse" 
                                                 data-bs-target="#module-@module.ModuleId" 
                                                 aria-expanded="true">
                                                <div class="module-title">
                                                    <i class="fas @(module.IsCompleted ? "fa-check-circle text-success" : "fa-circle text-muted") me-2"></i>
                                                    <span>@module.Title</span>
                                                </div>
                                                <div class="module-meta">
                                                    <span class="lesson-count">@module.CompletedLessons/@module.TotalLessons</span>
                                                    <i class="fas fa-chevron-down"></i>
                                                </div>
                                            </div>
                                            <div class="collapse show" id="module-@module.ModuleId">
                                                <div class="lessons-list">
                                                    @foreach (var lesson in module.Lessons.OrderBy(l => l.OrderIndex))
                                                    {
                                                        <div class="lesson-item @(lesson.IsCompleted ? "completed" : "")" 
                                                             data-lesson-id="@lesson.LessonId"
                                                             onclick="loadLesson(@lesson.LessonId, '@lesson.Type')">
                                                            <i class="fas @lesson.StatusIcon me-2"></i>
                                                            <span class="lesson-title">@lesson.Title</span>
                                                            <i class="fas @lesson.TypeIcon lesson-type-icon"></i>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="empty-state">
                                        <i class="fas fa-book-open"></i>
                                        <p>Chưa có nội dung học tập</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Main Learning Area -->
                    <div class="col-lg-8">
                        <div class="learning-area">
                            <!-- Welcome Screen -->
                            <div id="welcome-screen" class="welcome-screen">
                                <div class="welcome-content">
                                    <i class="fas fa-graduation-cap welcome-icon"></i>
                                    <h2>Chào mừng bạn đến với khóa học!</h2>
                                    <p>Vui lòng chọn một bài học từ danh sách bên trái để bắt đầu.</p>
                                    <div class="course-stats mt-4">
                                        <div class="stat-item">
                                            <i class="fas fa-layer-group"></i>
                                            <div>
                                                <div class="stat-value">@Model.Modules.Count</div>
                                                <div class="stat-label">Chương</div>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <i class="fas fa-book"></i>
                                            <div>
                                                <div class="stat-value">@Model.Modules.Sum(m => m.TotalLessons)</div>
                                                <div class="stat-label">Bài học</div>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <i class="fas fa-clock"></i>
                                            <div>
                                                <div class="stat-value">@Model.DurationDisplay</div>
                                                <div class="stat-label">Thời lượng</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lesson Content Area (Hidden by default) -->
                            <div id="lesson-content" class="lesson-content d-none">
                                <div class="lesson-header">
                                    <h2 id="lesson-title" class="mb-2">Tiêu đề bài học</h2>
                                    <div class="lesson-actions">
                                        <button class="btn btn-outline-success btn-sm" id="btn-complete-lesson" onclick="completeLesson()">
                                            <i class="fas fa-check me-1"></i>Hoàn thành
                                        </button>
                                        <div class="d-none" id="lesson-completed-status">
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Đã hoàn thành
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Video Lesson -->
                                <div id="video-content" class="content-section d-none">
                                    <!-- YouTube Embed -->
                                    <div id="video-youtube" class="video-wrapper d-none">
                                        <iframe id="youtube-iframe" 
                                                width="100%" 
                                                height="500" 
                                                frameborder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowfullscreen>
                                        </iframe>
                                    </div>
                                    
                                    <!-- Lazy overlay: show thumb + play until user clicks (for direct video files) -->
                                    <div id="video-lazy" class="video-lazy d-none">
                                        <div id="video-lazy-thumb" class="video-lazy-thumb"></div>
                                        <button id="video-lazy-play" type="button" class="play-btn-big" onclick="startVideoPlayback()">
                                            <i class="fas fa-play"></i><span>Phát</span>
                                        </button>
                                        <div id="video-lazy-spinner" class="spinner-wrap d-none">
                                            <div class="spinner-border text-light" role="status" aria-hidden="true"></div>
                                        </div>
                                    </div>
                                    <div id="video-loading" class="video-loading d-none d-flex flex-column justify-content-center align-items-center" style="min-height: 320px;">
                                        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
                                        <div class="mt-2 text-muted small">Đang tải video...</div>
                                    </div>
                                    <div class="video-wrapper">
                                        <video id="video-player" class="d-none" controls preload="metadata" controlsList="nodownload">
                                            <source id="video-source" src="" type="video/mp4">
                                            Trình duyệt của bạn không hỗ trợ video.
                                        </video>
                                    </div>
                                </div>

                                <!-- Reading Lesson -->
                                <div id="reading-content" class="content-section d-none">
                                    <div class="reading-wrapper">
                                        <div id="reading-text" class="reading-text"></div>
                                        <div id="reading-document" class="document-viewer d-none">
                                            <iframe id="document-frame" src="" frameborder="0"></iframe>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quiz Lesson -->
                                <div id="quiz-content" class="content-section d-none">
                                    <!-- Quiz Info Card -->
                                    <div class="quiz-info-card">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="info-item">
                                                    <i class="fas fa-clock text-primary"></i>
                                                    <span><strong>Thời gian:</strong> <span id="quiz-time-limit">--</span></span>
                                                </div>
                                                <div class="info-item">
                                                    <i class="fas fa-redo text-info"></i>
                                                    <span><strong>Số lần làm:</strong> <span id="quiz-attempts">--</span></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="info-item">
                                                    <i class="fas fa-check-double text-success"></i>
                                                    <span><strong>Điểm đạt:</strong> <span id="quiz-passing-score">--</span></span>
                                                </div>
                                                <div class="info-item">
                                                    <i class="fas fa-trophy text-warning"></i>
                                                    <span><strong>Điểm cao nhất:</strong> <span id="quiz-best-score">--</span></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button class="btn btn-primary btn-lg" id="btn-start-quiz" onclick="startQuiz()">
                                                <i class="fas fa-play me-2"></i>Bắt đầu làm bài
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Quiz Attempt History -->
                                    <div class="quiz-history-card mt-4">
                                        <h4 class="mb-3">
                                            <i class="fas fa-history me-2"></i>Lịch sử làm bài
                                        </h4>
                                        <div id="quiz-history-list">
                                            <div class="empty-state-small">
                                                <i class="fas fa-clipboard-list"></i>
                                                <p>Chưa có lượt làm bài nào</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentLessonId = null;
        let currentLessonType = null;
        let currentQuizId = null;
        let courseId = @Model.CourseId;
        
        // Store lesson data from server-side model
        const lessonsData = @Html.Raw(Json.Serialize(Model.Modules.SelectMany(m => m.Lessons)));

        // ---------- Helpers ----------
        function getLesson(lessonId) {
            return lessonsData.find(l => l.lessonId === lessonId);
        }

        function isAbsoluteUrl(url) {
            return /^https?:\/\//i.test(url);
        }

        function toAbsoluteUrl(url) {
            if (!url) return '';
            return isAbsoluteUrl(url) ? url : `${window.location.origin}${url.startsWith('/') ? '' : '/'}${url}`;
        }

        function getExtension(url) {
            if (!url) return '';
            const clean = url.split('?')[0].split('#')[0];
            const idx = clean.lastIndexOf('.');
            return idx >= 0 ? clean.substring(idx + 1).toLowerCase() : '';
        }

        function isYouTubeUrl(url) {
            if (!url) return false;
            return /(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/i.test(url);
        }

        function extractYouTubeId(url) {
            const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/i);
            return match ? match[1] : null;
        }

        async function fetchBlobUrl(url) {
            const abs = toAbsoluteUrl(url);
            const resp = await fetch(abs, { credentials: 'include' });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const blob = await resp.blob();
            return URL.createObjectURL(blob);
        }

        let pendingVideoUrl = null; // absolute url string
        let pendingVideoMime = 'video/mp4';
        let currentVideoBlobUrl = null; // revoke when switching lessons

        function resetVideo() {
            const video = document.getElementById('video-player');
            const source = document.getElementById('video-source');
            const loading = document.getElementById('video-loading');
            const lazy = document.getElementById('video-lazy');
            const spinner = document.getElementById('video-lazy-spinner');
            const playBtn = document.getElementById('video-lazy-play');
            const youtube = document.getElementById('video-youtube');
            const youtubeIframe = document.getElementById('youtube-iframe');
            
            loading.classList.add('d-none');
            spinner.classList.add('d-none');
            playBtn.classList.remove('d-none');
            lazy.classList.add('d-none');
            youtube.classList.add('d-none');
            
            video.pause();
            video.classList.add('d-none');
            try { video.removeAttribute('src'); } catch {}
            source.src = '';
            youtubeIframe.src = '';
            
            if (currentVideoBlobUrl) {
                URL.revokeObjectURL(currentVideoBlobUrl);
                currentVideoBlobUrl = null;
            }
            pendingVideoUrl = null;
        }

        function loadLesson(lessonId, lessonType) {
            currentLessonId = lessonId;
            currentLessonType = lessonType;

            // Hide welcome screen and show lesson content
            document.getElementById('welcome-screen').classList.add('d-none');
            document.getElementById('lesson-content').classList.remove('d-none');

            // Hide all content sections
            document.getElementById('video-content').classList.add('d-none');
            document.getElementById('reading-content').classList.add('d-none');
            document.getElementById('quiz-content').classList.add('d-none');

            // Highlight selected lesson
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.lesson-item[data-lesson-id="${lessonId}"]`).classList.add('active');

            // Update completion button status
            updateCompletionButton(lessonId);

            // Load lesson content based on type
            if (lessonType === 'Video') {
                loadVideoLesson(lessonId);
            } else if (lessonType === 'Reading') {
                loadReadingLesson(lessonId);
            } else if (lessonType === 'Quiz') {
                loadQuizLesson(lessonId);
            }
        }

        // Update completion button based on lesson status
        function updateCompletionButton(lessonId) {
            const lesson = getLesson(lessonId);
            const btnComplete = document.getElementById('btn-complete-lesson');
            const completedStatus = document.getElementById('lesson-completed-status');

            if (lesson && lesson.isCompleted) {
                // Lesson is completed - hide button, show status
                btnComplete.classList.add('d-none');
                completedStatus.classList.remove('d-none');
            } else {
                // Lesson not completed - show button, hide status
                btnComplete.classList.remove('d-none');
                completedStatus.classList.add('d-none');
                // Reset button state
                btnComplete.disabled = false;
                btnComplete.innerHTML = '<i class="fas fa-check me-1"></i>Hoàn thành';
            }
        }

        function loadVideoLesson(lessonId) {
            resetVideo();
            const lesson = getLesson(lessonId);
            if (!lesson) {
                alert('Không tìm thấy thông tin bài học!');
                return;
            }

            const url = lesson.contentUrl || lesson.attachmentUrl;
            document.getElementById('lesson-title').textContent = lesson.title || 'Bài học';

            const videoContent = document.getElementById('video-content');
            videoContent.classList.remove('d-none');

            if (!url) {
                alert('Không tìm thấy video cho bài học này!');
                return;
            }

            // Check if it's a YouTube URL
            if (isYouTubeUrl(url)) {
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    const youtube = document.getElementById('video-youtube');
                    const youtubeIframe = document.getElementById('youtube-iframe');
                    youtubeIframe.src = `https://www.youtube.com/embed/${videoId}?rel=0`;
                    youtube.classList.remove('d-none');
                } else {
                    alert('Không thể trích xuất ID video YouTube!');
                }
                return;
            }

            // For direct video files: use lazy load UI
            const lazy = document.getElementById('video-lazy');
            const thumb = document.getElementById('video-lazy-thumb');
            const spinner = document.getElementById('video-lazy-spinner');
            const playBtn = document.getElementById('video-lazy-play');
            spinner.classList.add('d-none');
            playBtn.classList.remove('d-none');
            lazy.classList.remove('d-none');
            thumb.style.backgroundImage = 'linear-gradient(180deg, rgba(0,0,0,.2), rgba(0,0,0,.2))';

            const video = document.getElementById('video-player');
            const source = document.getElementById('video-source');
            video.classList.add('d-none');

            const absUrl = toAbsoluteUrl(url);
            const ext = getExtension(absUrl);
            pendingVideoMime = ext === 'webm' ? 'video/webm' : ext === 'ogg' ? 'video/ogg' : 'video/mp4';
            pendingVideoUrl = absUrl;

            video.oncanplay = function() {
                spinner.classList.add('d-none');
                video.classList.remove('d-none');
                lazy.classList.add('d-none');
            };
            video.onerror = async function() {
                try {
                    spinner.classList.remove('d-none');
                    const blobUrl = await fetchBlobUrl(pendingVideoUrl);
                    currentVideoBlobUrl = blobUrl;
                    const s = document.getElementById('video-source');
                    s.type = pendingVideoMime;
                    s.src = blobUrl;
                    video.load();
                } catch (e) {
                    spinner.classList.add('d-none');
                    console.error('Video load failed:', e);
                    alert('Không thể phát video. Vui lòng thử lại hoặc liên hệ quản trị viên.');
                }
            };
        }

        async function startVideoPlayback() {
            if (!pendingVideoUrl) return;
            const video = document.getElementById('video-player');
            const source = document.getElementById('video-source');
            const spinner = document.getElementById('video-lazy-spinner');
            const playBtn = document.getElementById('video-lazy-play');
            playBtn.classList.add('d-none');
            spinner.classList.remove('d-none');

            // Try direct URL first
            source.type = pendingVideoMime;
            source.src = pendingVideoUrl;
            video.load();
        }

        async function loadReadingLesson(lessonId) {
            const lesson = getLesson(lessonId);
            if (!lesson) {
                alert('Không tìm thấy thông tin bài học!');
                return;
            }

            document.getElementById('lesson-title').textContent = lesson.title || 'Bài học';

            const url = lesson.contentUrl || lesson.attachmentUrl;
            const readingText = document.getElementById('reading-text');
            const readingDoc = document.getElementById('reading-document');
            const iframe = document.getElementById('document-frame');

            // Reset view
            readingText.classList.add('d-none');
            readingDoc.classList.add('d-none');
            readingText.innerHTML = '';
            iframe.src = '';

            if (url) {
                const absUrl = toAbsoluteUrl(url);
                const ext = getExtension(absUrl);
                try {
                    if (ext === 'pdf') {
                        // Use blob URL to avoid forced download by Content-Disposition
                        const blobUrl = await fetchBlobUrl(absUrl);
                        iframe.src = `${blobUrl}#toolbar=1&navpanes=0`;
                        readingDoc.classList.remove('d-none');
                    } else if (['doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx'].includes(ext)) {
                        // Try Office viewer (requires public access to the file URL)
                        const viewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(absUrl)}`;
                        iframe.src = viewerUrl;
                        readingDoc.classList.remove('d-none');
                    } else if (['txt', 'md', 'csv', 'json'].includes(ext)) {
                        const resp = await fetch(absUrl, { credentials: 'include' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const text = await resp.text();
                        readingText.innerText = text;
                        readingText.classList.remove('d-none');
                    } else {
                        // Fallback: try embed via blob
                        const blobUrl = await fetchBlobUrl(absUrl);
                        iframe.src = blobUrl;
                        readingDoc.classList.remove('d-none');
                    }
                } catch (e) {
                    console.error('Reading content load failed:', e);
                    alert('Không thể hiển thị tài liệu. Vui lòng thử lại hoặc tải xuống sau.');
                    return;
                }
            } else if (lesson.description) {
                readingText.innerHTML = lesson.description;
                readingText.classList.remove('d-none');
            } else {
                alert('Không tìm thấy nội dung cho bài học này!');
                return;
            }

            document.getElementById('reading-content').classList.remove('d-none');
        }

        async function loadQuizLesson(lessonId) {
            // Get lesson data from stored data
            const lesson = lessonsData.find(l => l.lessonId === lessonId);
            
            if (!lesson || !lesson.quizId) {
                alert('Không tìm thấy thông tin bài kiểm tra!');
                return;
            }
            
            currentQuizId = lesson.quizId;
            document.getElementById('lesson-title').textContent = lesson.title;
            document.getElementById('quiz-content').classList.remove('d-none');

            // Show loading state
            const btnStartQuiz = document.getElementById('btn-start-quiz');
            btnStartQuiz.disabled = true;
            btnStartQuiz.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang tải...';
            
            document.getElementById('quiz-time-limit').textContent = '--';
            document.getElementById('quiz-attempts').textContent = '--';
            document.getElementById('quiz-passing-score').textContent = '--';
            document.getElementById('quiz-best-score').textContent = '--';
            
            document.getElementById('quiz-history-list').innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>
            `;

            try {
                // Call API 1: Get Quiz Info - /bai-thi/get-quiz-info/{quizId}
                const infoResponse = await fetch(`/bai-thi/get-quiz-info/${currentQuizId}`);
                if (!infoResponse.ok) {
                    throw new Error(`Không thể tải thông tin quiz (Status: ${infoResponse.status})`);
                }
                const quizInfo = await infoResponse.json();

                // Display quiz info
                document.getElementById('quiz-time-limit').textContent = quizInfo.timeLimit > 0 ? `${quizInfo.timeLimit} phút` : 'Không giới hạn';
                document.getElementById('quiz-passing-score').textContent = `${quizInfo.passingScore}%`;
                document.getElementById('quiz-best-score').textContent = quizInfo.bestScore !== null && quizInfo.bestScore !== undefined 
                    ? `${quizInfo.bestScore}%` 
                    : 'Chưa làm bài';

                // Display attempts info
                const remainingAttempts = quizInfo.remainingAttempts;
                const maxAttempts = quizInfo.maxAttempts;
                const attemptCount = maxAttempts > 0 ? (maxAttempts - remainingAttempts) : remainingAttempts;
                
                if (maxAttempts > 0) {
                    document.getElementById('quiz-attempts').textContent = `${attemptCount}/${maxAttempts}`;
                } else {
                    document.getElementById('quiz-attempts').textContent = `${attemptCount}/Không giới hạn`;
                }

                // Update button state based on quiz info
                if (quizInfo.isLocked) {
                    btnStartQuiz.disabled = true;
                    btnStartQuiz.innerHTML = '<i class="fas fa-lock me-2"></i>Quiz đã bị khóa';
                } else if (remainingAttempts === 0 && maxAttempts > 0) {
                    btnStartQuiz.disabled = true;
                    btnStartQuiz.innerHTML = '<i class="fas fa-ban me-2"></i>Đã hết lượt làm bài';
                } else if (quizInfo.hasPassed) {
                    btnStartQuiz.disabled = false;
                    btnStartQuiz.innerHTML = '<i class="fas fa-check-circle me-2"></i>Làm lại bài (Đã đạt)';
                } else {
                    btnStartQuiz.disabled = false;
                    btnStartQuiz.innerHTML = '<i class="fas fa-play me-2"></i>Bắt đầu làm bài';
                }

                // Call API 2: Get Quiz History - /bai-thi/get-quiz-history/{courseId}/{quizId}
                const historyResponse = await fetch(`/bai-thi/get-quiz-history/${courseId}/${currentQuizId}`);
                if (!historyResponse.ok) {
                    throw new Error(`Không thể tải lịch sử làm bài (Status: ${historyResponse.status})`);
                }
                const historyData = await historyResponse.json();

                // Display quiz history
                displayQuizHistory(historyData);

            } catch (error) {
                console.error('Error loading quiz lesson:', error);
                
                // Show error in UI
                document.getElementById('quiz-history-list').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${error.message}
                    </div>
                `;
                
                btnStartQuiz.disabled = true;
                btnStartQuiz.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Không thể tải';
            }
        }

        function displayQuizHistory(historyData) {
            const historyList = document.getElementById('quiz-history-list');
            
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state-small">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Chưa có lượt làm bài nào</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr>';
            html += '<th>#</th>';
            html += '<th>Thời gian làm bài</th>';
            html += '<th>Thời gian nộp bài</th>';
            html += '<th>Điểm</th>';
            html += '<th>Kết quả</th>';
            html += '</tr></thead><tbody>';

            historyData.forEach((attempt, index) => {
                // Format dates
                const startTime = attempt.startTime ? new Date(attempt.startTime).toLocaleString('vi-VN') : '--';
                const endTime = attempt.endTime ? new Date(attempt.endTime).toLocaleString('vi-VN') : 'Chưa hoàn thành';
                
                // Format score
                const score = attempt.score !== null && attempt.score !== undefined 
                    ? `${attempt.score}/${attempt.maxScore || 0}` 
                    : '--';
                
                // Determine status badge
                let statusBadge = 'bg-secondary';
                let statusText = 'Chưa hoàn thành';
                
                if (attempt.status === 'Completed' || attempt.status === 'Submitted') {
                    if (attempt.isPassed) {
                        statusBadge = 'bg-success';
                        statusText = 'Đạt';
                    } else {
                        statusBadge = 'bg-danger';
                        statusText = 'Không đạt';
                    }
                } else if (attempt.status === 'InProgress') {
                    statusBadge = 'bg-warning text-dark';
                    statusText = 'Đang làm';
                }
                
                html += '<tr>';
                html += `<td>${index + 1}</td>`;
                html += `<td>${startTime}</td>`;
                html += `<td>${endTime}</td>`;
                html += `<td><strong>${score}</strong></td>`;
                html += `<td><span class="badge ${statusBadge}">${statusText}</span></td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            historyList.innerHTML = html;
        }

        function loadQuizHistory(quizId, attempts) {
            // This function is kept for backward compatibility but now uses displayQuizHistory
            displayQuizHistory(attempts);
        }

        function startQuiz() {
            if (!currentQuizId || !currentLessonId) {
                alert('Không tìm thấy thông tin bài kiểm tra!');
                return;
            }
            
            // Redirect to quiz page with lessonId and courseId
            window.location.href = `/bai-thi/lam-bai/${currentQuizId}?lessonId=${currentLessonId}&courseId=${courseId}`;
        }

        // Update progress bar without reloading page
        function updateProgressBar() {
            // Calculate total and completed lessons
            const totalLessons = lessonsData.length;
            const completedLessons = lessonsData.filter(l => l.isCompleted).length;
            const progress = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
            
            // Update progress text
            const progressValue = document.querySelector('.progress-value');
            if (progressValue) {
                progressValue.textContent = `${progress}%`;
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
            
            console.log(`Progress updated: ${completedLessons}/${totalLessons} (${progress}%)`);
        }

        function completeLesson() {
            if (!currentLessonId) {
                alert('Vui lòng chọn một bài học!');
                return;
            }

            console.log('Completing lesson with ID:', currentLessonId, 'Type:', typeof currentLessonId);

            if (confirm('Bạn có chắc chắn đã hoàn thành bài học này?')) {
                const btnComplete = document.getElementById('btn-complete-lesson');
                btnComplete.disabled = true;
                btnComplete.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...';

                const requestBody = {
                    lessonId: currentLessonId
                };
                console.log('Request body:', requestBody);

                fetch('@Url.Action("HoanThanhBaiHoc", "KhoaHoc")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update lesson status in local data
                        const lesson = getLesson(currentLessonId);
                        if (lesson) {
                            lesson.isCompleted = true;
                        }

                        // Update UI: Hide button, show completed status
                        btnComplete.classList.add('d-none');
                        document.getElementById('lesson-completed-status').classList.remove('d-none');

                        // Update lesson item in sidebar
                        const lessonItem = document.querySelector(`.lesson-item[data-lesson-id="${currentLessonId}"]`);
                        if (lessonItem) {
                            lessonItem.classList.add('completed');
                            const icon = lessonItem.querySelector('i.fas');
                            if (icon) {
                                icon.className = 'fas fa-check-circle text-success me-2';
                            }
                        }

                        // Update progress bar in header
                        updateProgressBar();

                        alert(data.message);
                    } else {
                        alert(data.message);
                        btnComplete.disabled = false;
                        btnComplete.innerHTML = '<i class="fas fa-check me-1"></i>Hoàn thành';
                    }
                })
                .catch(error => {
                    console.error('Error completing lesson:', error);
                    alert('Có lỗi xảy ra khi đánh dấu hoàn thành bài học!');
                    btnComplete.disabled = false;
                    btnComplete.innerHTML = '<i class="fas fa-check me-1"></i>Hoàn thành';
                });
            }
        }

        // Track video progress for auto-complete
        document.addEventListener('DOMContentLoaded', function() {
            const videoPlayer = document.getElementById('video-player');
            if (videoPlayer) {
                videoPlayer.addEventListener('ended', function() {
                    if (confirm('Bạn đã xem hết video. Đánh dấu hoàn thành bài học này?')) {
                        completeLesson();
                    }
                });
            }
        });
    </script>
}
