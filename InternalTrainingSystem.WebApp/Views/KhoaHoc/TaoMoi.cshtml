@model InternalTrainingSystem.WebApp.Models.DTOs.CreateFullCourseDto
@using InternalTrainingSystem.WebApp.Constants
@using InternalTrainingSystem.WebApp.Extensions
@{
    ViewData["Title"] = "Thêm Khóa Học Mới";
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tao-moi-khoa-hoc.css" asp-append-version="true" />
}

<div class="course-container">
    <div class="container-fluid">
        <div class="form-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="form-title">
                        <i class="fas fa-plus-circle me-3"></i>Thêm Khóa Học Mới
                    </h1>
                    <p class="form-subtitle">Tạo mới khóa học đào tạo nội bộ</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="@Url.Action("Index")" class="btn btn-back">
                        <i class="fas fa-arrow-left me-2"></i>Quay Lại
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Form -->
        <form method="post" asp-controller="KhoaHoc" asp-action="TaoMoi" enctype="multipart/form-data" class="course-edit-form" novalidate>
            @Html.AntiForgeryToken()

            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8 mb-4">
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-info-circle me-2"></i>Thông Tin Cơ Bản
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="CourseName" class="form-label required">Tên khóa học</label>
                                <input asp-for="CourseName" class="form-control" placeholder="Nhập tên khóa học">
                                <span asp-validation-for="CourseName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="CourseCode" class="form-label required">Mã khóa học</label>
                                <input asp-for="CourseCode" class="form-control" placeholder="VD: IT001">
                                <span asp-validation-for="CourseCode" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Mô tả khóa học</label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                                      placeholder="Nhập mô tả chi tiết về khóa học..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CourseCategoryId" class="form-label required">Danh mục</label>
                                <select asp-for="CourseCategoryId" class="form-select">
                                    <option value="">Chọn danh mục</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (var category in ViewBag.Categories)
                                        {
                                            <option value="@category.CourseCategoryId">@category.CategoryName</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CourseCategoryId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Level" class="form-label required">Cấp độ</label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">Chọn cấp độ</option>
                                    <option value="Beginner">Cơ bản</option>
                                    <option value="Intermediate">Trung cấp</option>
                                    <option value="Advanced">Nâng cao</option>
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Duration" class="form-label required">Thời lượng (giờ)</label>
                                <input asp-for="Duration" type="number" class="form-control" min="1"
                                       placeholder="VD: 40" value="1">
                                <span asp-validation-for="Duration" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tùy chọn khóa học</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check form-switch">
                                        @{
                                            var isOnlineChecked = ViewBag.IsOnline ?? Model.IsOnline;
                                        }
                                        <input asp-for="IsOnline" class="form-check-input" type="checkbox" role="switch" checked="@isOnlineChecked" id="IsOnlineCheckbox">
                                        <label asp-for="IsOnline" class="form-check-label">
                                            Khóa học trực tuyến
                                            <br><small class="text-muted">Học viên tự học qua nền tảng online</small>
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input asp-for="IsMandatory" class="form-check-input" type="checkbox" role="switch">
                                        <label asp-for="IsMandatory" class="form-check-label">
                                            Khóa học bắt buộc
                                            <br><small class="text-muted">Nhân viên bắt buộc phải tham gia</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PassScore Field (only for offline courses) -->
                        <div class="row" id="passScoreContainer" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <label asp-for="PassScore" class="form-label">Điểm đạt tối thiểu</label>
                                <input asp-for="PassScore" type="number" class="form-control" min="0" max="10" step="0.1"
                                       placeholder="Nhập điểm tối thiểu để pass khóa học (0-10)">
                                <span asp-validation-for="PassScore" class="text-danger"></span>
                                <small class="text-muted">Điểm tối thiểu mà học viên cần đạt được để hoàn thành khóa học offline (thang điểm 0-10)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Department Selection -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-building me-2"></i>Phòng Ban Áp Dụng
                        </h3>
                        <p class="form-help-text">Chọn các phòng ban mà khóa học này sẽ được áp dụng</p>
                        
                        <div class="departments-selection">
                            @if (ViewBag.Departments != null)
                            {
                                var selectedDepartmentIds = ViewBag.SelectedDepartmentIds as List<int> ?? Model.SelectedDepartmentIds ?? new List<int>();
                                
                                @foreach (var dept in ViewBag.Departments)
                                {
                                    <div class="form-check department-check">
                                        <input class="form-check-input" type="checkbox"
                                               name="SelectedDepartmentIds" value="@dept.DepartmentId"
                                               id="dept_@dept.DepartmentId"
                                               @(selectedDepartmentIds.Contains(dept.DepartmentId) ? "checked" : "")>
                                        <label class="form-check-label" for="dept_@dept.DepartmentId">
                                            <i class="fas fa-building me-2"></i>
                                            @dept.DepartmentName
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- Course Content Section -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-book me-2"></i>Nội Dung Khóa Học
                        </h3>
                        <p class="form-help-text">Tạo các module và bài học cho khóa học. Khóa học phải có ít nhất 1 module và mỗi module phải có ít nhất 1 bài học.</p>

                        <!-- Modules Container -->
                        <div id="modules-container">
                            <!-- Modules will be dynamically added here -->
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary" id="add-module-btn">
                                <i class="fas fa-plus me-2"></i>Thêm Module
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Side Panel -->
                <div class="col-lg-4 mb-4">
                    <!-- Form Help -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-question-circle me-2"></i>Hướng Dẫn
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Tên khóa học nên ngắn gọn và dễ hiểu</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Mã khóa học nên theo chuẩn: AB123</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Chọn cấp độ phù hợp với nội dung khóa học</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Thời lượng tính bằng giờ học lý thuyết</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Chọn ít nhất 1 phòng ban để áp dụng khóa học</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Khóa học sẽ cần được phê duyệt trước khi hoạt động</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Mỗi bài học có 3 loại: Video, Bài Đọc, hoặc Quiz</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Video: URL video + mô tả + link tài liệu đính kèm (tùy chọn)</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Bài Đọc: File tài liệu + mô tả + link tài liệu bổ sung (tùy chọn)</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Quiz: File Excel + cấu hình (số lần làm, điểm pass, thời gian)</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Tài liệu hỗ trợ: PDF, Word, PowerPoint, Excel, Text và OpenOffice</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Link tài liệu có thể từ Google Drive, OneDrive hoặc dịch vụ lưu trữ khác</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Video hỗ trợ URL từ YouTube, Vimeo và các nền tảng khác</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Quiz Excel phải có định dạng chuẩn (tải template mẫu)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-card" style="position: sticky; top: 20px;">
                        <h3 class="form-section-title">
                            <i class="fas fa-save me-2"></i>Thao Tác
                        </h3>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-plus me-2"></i>Tạo Khóa Học
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>Hủy Bỏ
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Module Template -->
<template id="module-template">
    <div class="module-card" data-module-index="">
        <div class="module-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder me-2"></i>Module <span class="module-number">1</span>
                </h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-light move-up-module" title="Di chuyển lên">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light move-down-module" title="Di chuyển xuống">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button type="button" class="btn btn-danger remove-module" title="Xóa module">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="p-3">
            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label required">Tên Module</label>
                    <input type="text" name="Modules[0].Title" class="form-control" placeholder="Nhập tên module" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Thứ tự</label>
                    <input type="number" name="Modules[0].OrderIndex" class="form-control module-order" min="1" value="1" readonly>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Mô tả Module</label>
                <textarea name="Modules[0].Description" class="form-control" rows="2" placeholder="Nhập mô tả module..."></textarea>
            </div>

            <!-- Lessons Section -->
            <div class="lessons-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-play-circle me-2"></i>Bài Học</h6>
                    <button type="button" class="add-lesson-btn btn btn-sm">
                        <i class="fas fa-plus me-1"></i>Thêm Bài Học
                    </button>
                </div>
                <div class="lessons-container">
                    <!-- Lessons will be added here -->
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Lesson Template -->
<template id="lesson-template">
    <div class="lesson-item" data-lesson-index="">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h6 class="mb-0">
                <i class="fas fa-play me-2"></i>Bài học <span class="lesson-number">1</span>
            </h6>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary move-up-lesson" title="Di chuyển lên">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary move-down-lesson" title="Di chuyển xuống">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-outline-danger remove-lesson" title="Xóa bài học">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-8">
                <label class="form-label required">Tên Bài Học</label>
                <input type="text" name="Modules[0].Lessons[0].Title" class="form-control" placeholder="Nhập tên bài học" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Thứ tự</label>
                <input type="number" name="Modules[0].Lessons[0].OrderIndex" class="form-control lesson-order" min="1" value="1" readonly>
            </div>
        </div>

        <!-- Lesson Type Selection -->
        <div class="mb-4">
            <label class="form-label required">Loại Bài Học</label>
            <div class="btn-group w-100 lesson-type-selector" role="group">
                <input type="radio" class="btn-check" name="Modules[0].Lessons[0].LessonType" id="lesson-type-video-0-0" value="Video" checked>
                <label class="btn btn-outline-primary" for="lesson-type-video-0-0">
                    <i class="fas fa-video me-2"></i>Video
                </label>
                
                <input type="radio" class="btn-check" name="Modules[0].Lessons[0].LessonType" id="lesson-type-reading-0-0" value="Reading">
                <label class="btn btn-outline-info" for="lesson-type-reading-0-0">
                    <i class="fas fa-book-open me-2"></i>Bài Đọc
                </label>
                
                <input type="radio" class="btn-check" name="Modules[0].Lessons[0].LessonType" id="lesson-type-quiz-0-0" value="Quiz">
                <label class="btn btn-outline-success" for="lesson-type-quiz-0-0">
                    <i class="fas fa-question-circle me-2"></i>Quiz
                </label>
            </div>
        </div>

        <!-- Video Content Section -->
        <div class="lesson-content-section video-content-section">
            <h6 class="mb-3">
                <i class="fas fa-video me-2 text-primary"></i>Nội Dung Video
            </h6>
            
            <!-- Type hidden field -->
            <input type="hidden" name="Modules[0].Lessons[0].Type" value="1" class="lesson-type-value">
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label required">URL Video</label>
                    <input type="url" name="Modules[0].Lessons[0].ContentUrl" class="form-control video-url" 
                           placeholder="Nhập URL video (YouTube, Vimeo, ...)">
                    <small class="form-text text-muted">Hỗ trợ YouTube, Vimeo và các nền tảng video khác</small>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Mô tả Video</label>
                    <textarea name="Modules[0].Lessons[0].Description" class="form-control video-description" rows="3" 
                              placeholder="Nhập mô tả chi tiết cho video này..."></textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Link Tài Liệu Đính Kèm (Tùy chọn)</label>
                          <input type="url" name="Modules[0].Lessons[0].AttachmentUrl" class="form-control video-attachment" 
                           placeholder="Nhập URL tài liệu đính kèm (Google Drive, OneDrive, ...)">
                    <small class="form-text text-muted">
                        Nhập link tài liệu từ Google Drive, OneDrive hoặc các dịch vụ lưu trữ khác
                    </small>
                </div>
            </div>
        </div>

        <!-- Reading Content Section -->
        <div class="lesson-content-section reading-content-section" style="display: none;">
            <h6 class="mb-3">
                <i class="fas fa-book-open me-2 text-info"></i>Nội Dung Bài Đọc
            </h6>
            
            <!-- Type hidden field -->
            <input type="hidden" name="Modules[0].Lessons[0].Type" value="2" class="lesson-type-value" disabled>
            
            <!-- MainFileIndex will be set dynamically when file is added -->
            <input type="hidden" name="Modules[0].Lessons[0].MainFileIndex" class="main-file-index" value="">
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label required">File Tài Liệu Chính</label>
                    <input type="file" name="LessonFiles" class="form-control reading-file" 
                           accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.rtf,.odt,.ods,.odp"
                           data-lesson-file-type="reading">
                    <small class="form-text text-muted">
                        Hỗ trợ: PDF, Word, PowerPoint, Excel, Text. Kích thước tối đa: 50MB
                    </small>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Mô tả Bài Đọc</label>
                    <textarea name="Modules[0].Lessons[0].Description" class="form-control reading-description" rows="3" 
                              placeholder="Nhập mô tả chi tiết cho bài đọc này..."></textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Link Tài Liệu Đính Kèm (Tùy chọn)</label>
                      <input type="url" name="Modules[0].Lessons[0].AttachmentUrl" class="form-control reading-attachment" 
                           placeholder="Nhập URL tài liệu đính kèm bổ sung (Google Drive, OneDrive, ...)">
                    <small class="form-text text-muted">
                        Nhập link tài liệu tham khảo thêm từ Google Drive, OneDrive hoặc các dịch vụ lưu trữ khác
                    </small>
                </div>
            </div>
        </div>

        <!-- Quiz Content Section -->
        <div class="lesson-content-section quiz-content-section" style="display: none;">
            <h6 class="mb-3">
                <i class="fas fa-question-circle me-2 text-success"></i>Cấu Hình Quiz
            </h6>
            
            <!-- Type hidden field -->
            <input type="hidden" name="Modules[0].Lessons[0].Type" value="3" class="lesson-type-value" disabled>
            
            <!-- MainFileIndex will be set dynamically when file is added -->
            <input type="hidden" name="Modules[0].Lessons[0].MainFileIndex" class="main-file-index" value="">
            
            <!-- IsQuizExcel always true -->
            <input type="hidden" name="Modules[0].Lessons[0].IsQuizExcel" value="true" class="quiz-is-excel">
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label required">File Excel Quiz</label>
                    <input type="file" name="LessonFiles" class="form-control quiz-file" accept=".xlsx,.xls"
                           data-lesson-file-type="quiz">
                    <small class="form-text text-muted">
                        File Excel phải có định dạng chuẩn
                        <a href="~/templates/quiz-template.xlsx" download="Quiz_Template.xlsx" class="text-primary">
                            <i class="fas fa-download me-1"></i>Tải template
                        </a>
                    </small>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label required">Số Lần Làm Tối Đa</label>
                          <input type="number" name="Modules[0].Lessons[0].QuizMaxAttempts" class="form-control quiz-max-attempts" 
                           min="1" max="10" value="3" placeholder="VD: 3">
                    <small class="form-text text-muted">Từ 1 đến 10 lần</small>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label required">Điểm Pass (%)</label>
                          <input type="number" name="Modules[0].Lessons[0].QuizPassingScore" class="form-control quiz-passing-score" 
                           min="0" max="100" value="70" placeholder="VD: 70">
                    <small class="form-text text-muted">Từ 0% đến 100%</small>
                </div>

                <div class="col-md-4">
                    <label class="form-label required">Thời Gian (phút)</label>
                          <input type="number" name="Modules[0].Lessons[0].QuizTimeLimit" class="form-control quiz-time-limit" 
                           min="1" max="180" value="30" placeholder="VD: 30">
                    <small class="form-text text-muted">Từ 1 đến 180 phút</small>
                </div>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        $(document).ready(function() {
            let moduleCount = 0;

            // Toggle PassScore field based on IsOnline checkbox
            function togglePassScoreField() {
                const isOnline = $('#IsOnlineCheckbox').is(':checked');
                if (isOnline) {
                    $('#passScoreContainer').hide();
                    $('#PassScore').removeAttr('required');
                } else {
                    $('#passScoreContainer').show();
                }
            }

            // Initialize PassScore field visibility on page load
            togglePassScoreField();

            // Toggle PassScore field when IsOnline checkbox changes
            $('#IsOnlineCheckbox').on('change', function() {
                togglePassScoreField();
            });

            // Auto-generate course code from course name
            $('#CourseName').on('blur', function() {
                const courseName = $(this).val().trim();
                const courseCodeField = $('#CourseCode');
                
                if (courseName && !courseCodeField.val()) {
                    // Take first 2 words and get first letter of each
                    const words = courseName.split(' ').slice(0, 2);
                    const initials = words.map(word => word.charAt(0).toUpperCase()).join('');
                    
                    // Generate random 3-digit number
                    const randomNum = String(Math.floor(Math.random() * 900) + 100).padStart(3, '0');
                    
                    // Create course code: TK-012
                    const courseCode = `${initials}${randomNum}`;
                    courseCodeField.val(courseCode);
                }
            });

            // Add module button click
            $('#add-module-btn').click(function() {
                addModule();
            });

            // Check if we have existing modules from server (in case of validation errors)
            const existingModules = @Html.Raw(Json.Serialize(Model.Modules));
            const selectedDepartments = @Html.Raw(Json.Serialize(ViewBag.SelectedDepartmentIds ?? Model.SelectedDepartmentIds ?? new List<int>()));
            
            if (existingModules && existingModules.length > 0) {
                // Restore existing modules and lessons
                restoreExistingData(existingModules);
            } else {
                // Add initial module if no existing data
                addModule();
            }

            // Restore selected departments
            if (selectedDepartments && selectedDepartments.length > 0) {
                selectedDepartments.forEach(departmentId => {
                    const checkbox = $(`#dept_${departmentId}`);
                    if (checkbox.length > 0) {
                        checkbox.prop('checked', true);
                    }
                });
            }

            function restoreExistingData(modules) {
                modules.forEach((moduleData, moduleIndex) => {
                    const moduleCard = addModuleWithData(moduleData, moduleIndex);
                    
                    // Restore lessons for this module
                    if (moduleData.lessons && moduleData.lessons.length > 0) {
                        moduleData.lessons.forEach((lessonData, lessonIndex) => {
                            addLessonWithData(moduleCard, lessonData, moduleIndex, lessonIndex);
                        });
                    } else {
                        // Add at least one empty lesson if no lessons exist
                        addLesson(moduleCard);
                    }
                });
                
                updateModuleOrders();
            }

            function addModuleWithData(moduleData, moduleIndex) {
                const template = document.getElementById('module-template');
                const clone = template.content.cloneNode(true);
                
                // Update module index and names
                const moduleDiv = clone.querySelector('.module-card');
                moduleDiv.setAttribute('data-module-index', moduleIndex);
                
                // Update module number
                clone.querySelector('.module-number').textContent = moduleIndex + 1;
                
                // Fill in module data
                clone.querySelector('input[name*="Title"]').value = moduleData.title || '';
                clone.querySelector('textarea[name*="Description"]').value = moduleData.description || '';
                clone.querySelector('input[name*="OrderIndex"]').value = moduleData.orderIndex || moduleIndex + 1;
                
                // Update form field names
                updateModuleFieldNames(clone, moduleIndex);
                
                // Add event listeners
                addModuleEventListeners(clone);
                
                // Append to container
                document.getElementById('modules-container').appendChild(clone);
                
                moduleCount = Math.max(moduleCount, moduleIndex + 1);
                
                return moduleDiv;
            }

            function addLessonWithData(moduleCard, lessonData, moduleIndex, lessonIndex) {
                const lessonsContainer = moduleCard.querySelector('.lessons-container');
                
                const template = document.getElementById('lesson-template');
                const clone = template.content.cloneNode(true);
                
                // Update lesson index and names
                const lessonDiv = clone.querySelector('.lesson-item');
                lessonDiv.setAttribute('data-lesson-index', lessonIndex);
                
                // Update lesson number
                clone.querySelector('.lesson-number').textContent = lessonIndex + 1;
                
                // Fill in lesson data
                clone.querySelector('input[name*="Title"]').value = lessonData.title || '';
                clone.querySelector('input[name*="OrderIndex"]').value = lessonData.orderIndex || lessonIndex + 1;
                
                // Set lesson type - map from backend enum (1=Video, 2=Reading, 3=Quiz)
                const lessonType = lessonData.type || lessonData.lessonType || 1; // Default Video
                const videoRadio = clone.querySelector('input[value="Video"]');
                const readingRadio = clone.querySelector('input[value="Reading"]');
                const quizRadio = clone.querySelector('input[value="Quiz"]');
                const videoSection = clone.querySelector('.video-content-section');
                const readingSection = clone.querySelector('.reading-content-section');
                const quizSection = clone.querySelector('.quiz-content-section');
                
                // Get Type hidden fields
                const videoTypeField = videoSection.querySelector('.lesson-type-value');
                const readingTypeField = readingSection.querySelector('.lesson-type-value');
                const quizTypeField = quizSection.querySelector('.lesson-type-value');
                
                if (lessonType === 2 || lessonType === 'Reading') {
                    if (readingRadio) readingRadio.checked = true;
                    if (videoSection) videoSection.style.display = 'none';
                    if (readingSection) readingSection.style.display = 'block';
                    if (quizSection) quizSection.style.display = 'none';
                    
                    // Enable Reading type field
                    videoTypeField.disabled = true;
                    readingTypeField.disabled = false;
                    quizTypeField.disabled = true;
                    
                    // Enable reading file, disable quiz file
                    const readingFile = clone.querySelector('.reading-file');
                    const quizFile = clone.querySelector('.quiz-file');
                    if (readingFile) readingFile.disabled = false;
                    if (quizFile) quizFile.disabled = true;
                    
                    // Fill reading data
                    if (lessonData.description) {
                        const readingDescriptionField = clone.querySelector('.reading-description');
                        if (readingDescriptionField) readingDescriptionField.value = lessonData.description;
                    }
                    if (lessonData.attachmentUrl) {
                        const readingAttachmentField = clone.querySelector('.reading-attachment');
                        if (readingAttachmentField) readingAttachmentField.value = lessonData.attachmentUrl;
                    }
                    if (lessonData.mainFileIndex !== null && lessonData.mainFileIndex !== undefined) {
                        clone.querySelector('.reading-content-section .main-file-index').value = lessonData.mainFileIndex;
                    }
                } else if (lessonType === 3 || lessonType === 'Quiz') {
                    if (quizRadio) quizRadio.checked = true;
                    if (videoSection) videoSection.style.display = 'none';
                    if (readingSection) readingSection.style.display = 'none';
                    if (quizSection) quizSection.style.display = 'block';
                    
                    // Enable Quiz type field
                    videoTypeField.disabled = true;
                    readingTypeField.disabled = true;
                    quizTypeField.disabled = false;
                    
                    // Enable quiz file, disable reading file
                    const readingFile = clone.querySelector('.reading-file');
                    const quizFile = clone.querySelector('.quiz-file');
                    if (readingFile) readingFile.disabled = true;
                    if (quizFile) quizFile.disabled = false;
                    
                    // Fill quiz data
                    if (lessonData.quizMaxAttempts) {
                        const quizAttemptsField = clone.querySelector('.quiz-max-attempts');
                        if (quizAttemptsField) quizAttemptsField.value = lessonData.quizMaxAttempts;
                    }
                    if (lessonData.quizPassingScore) {
                        const quizPassingScoreField = clone.querySelector('.quiz-passing-score');
                        if (quizPassingScoreField) quizPassingScoreField.value = lessonData.quizPassingScore;
                    }
                    if (lessonData.quizTimeLimit) {
                        const quizTimeLimitField = clone.querySelector('.quiz-time-limit');
                        if (quizTimeLimitField) quizTimeLimitField.value = lessonData.quizTimeLimit;
                    }
                    if (lessonData.mainFileIndex !== null && lessonData.mainFileIndex !== undefined) {
                        clone.querySelector('.quiz-content-section .main-file-index').value = lessonData.mainFileIndex;
                    }
                } else {
                    if (videoRadio) videoRadio.checked = true;
                    if (videoSection) videoSection.style.display = 'block';
                    if (readingSection) readingSection.style.display = 'none';
                    if (quizSection) quizSection.style.display = 'none';
                    
                    videoTypeField.disabled = false;
                    readingTypeField.disabled = true;
                    quizTypeField.disabled = true;
                    
                    const readingFile = clone.querySelector('.reading-file');
                    const quizFile = clone.querySelector('.quiz-file');
                    if (readingFile) readingFile.disabled = true;
                    if (quizFile) quizFile.disabled = true;
                    
                    if (lessonData.contentUrl) {
                        const videoUrlField = clone.querySelector('.video-url');
                        if (videoUrlField) videoUrlField.value = lessonData.contentUrl;
                    }
                    if (lessonData.description) {
                        const videoDescriptionField = clone.querySelector('.video-description');
                        if (videoDescriptionField) videoDescriptionField.value = lessonData.description;
                    }
                    if (lessonData.attachmentUrl) {
                        const videoAttachmentField = clone.querySelector('.video-attachment');
                        if (videoAttachmentField) videoAttachmentField.value = lessonData.attachmentUrl;
                    }
                }
                
                updateLessonFieldNames(clone, moduleIndex, lessonIndex);
                
                addLessonEventListeners(clone);
                
                lessonsContainer.appendChild(clone);

                const newLesson = lessonsContainer.lastElementChild;
                initializeLessonTypeState(newLesson);
            }

            function addModule() {
                const template = document.getElementById('module-template');
                const clone = template.content.cloneNode(true);
                
                const moduleDiv = clone.querySelector('.module-card');
                moduleDiv.setAttribute('data-module-index', moduleCount);
                
                clone.querySelector('.module-number').textContent = moduleCount + 1;
                
                updateModuleFieldNames(clone, moduleCount);
                
                addModuleEventListeners(clone);
                
                document.getElementById('modules-container').appendChild(clone);
                
                addLesson(moduleDiv);
                
                moduleCount++;
                updateModuleOrders();
            }

            function updateModuleFieldNames(element, moduleIndex) {
                const inputs = element.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name.replace(/Modules\[\d+\]/, `Modules[${moduleIndex}]`);
                        input.setAttribute('name', newName);
                    }
                });
            }

            function addModuleEventListeners(clone) {
                clone.querySelector('.remove-module').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    moduleCard.remove();
                    updateModuleOrders();
                });

                clone.querySelector('.move-up-module').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    const prevModule = moduleCard.previousElementSibling;
                    if (prevModule) {
                        moduleCard.parentNode.insertBefore(moduleCard, prevModule);
                        updateModuleOrders();
                    }
                });

                clone.querySelector('.move-down-module').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    const nextModule = moduleCard.nextElementSibling;
                    if (nextModule) {
                        moduleCard.parentNode.insertBefore(nextModule, moduleCard);
                        updateModuleOrders();
                    }
                });

                clone.querySelector('.add-lesson-btn').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    addLesson(moduleCard);
                });
            }

            function addLesson(moduleCard) {
                const moduleIndex = moduleCard.getAttribute('data-module-index');
                const lessonsContainer = moduleCard.querySelector('.lessons-container');
                const lessonCount = lessonsContainer.children.length;
                
                const template = document.getElementById('lesson-template');
                const clone = template.content.cloneNode(true);
                
                const lessonDiv = clone.querySelector('.lesson-item');
                lessonDiv.setAttribute('data-lesson-index', lessonCount);
                
                clone.querySelector('.lesson-number').textContent = lessonCount + 1;
                
                updateLessonFieldNames(clone, moduleIndex, lessonCount);
                
                const readingFile = clone.querySelector('.reading-file');
                const quizFile = clone.querySelector('.quiz-file');
                const readingMainFileIndex = clone.querySelector('.reading-content-section .main-file-index');
                const quizMainFileIndex = clone.querySelector('.quiz-content-section .main-file-index');
                
                if (readingFile) readingFile.disabled = true;
                if (quizFile) quizFile.disabled = true;
                if (readingMainFileIndex) readingMainFileIndex.disabled = true; 
                if (quizMainFileIndex) quizMainFileIndex.disabled = true;
                
                addLessonEventListeners(clone);
                
                lessonsContainer.appendChild(clone);

                const newLesson = lessonsContainer.lastElementChild;
                initializeLessonTypeState(newLesson);
                
                updateLessonOrders(moduleCard);
            }

            function updateLessonFieldNames(element, moduleIndex, lessonIndex) {
                const inputs = element.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name
                            .replace(/Modules\[\d+\]/, `Modules[${moduleIndex}]`)
                            .replace(/Lessons\[\d+\]/, `Lessons[${lessonIndex}]`);
                        input.setAttribute('name', newName);
                    }
                    
                    const id = input.getAttribute('id');
                    if (id && id.includes('lesson-type-')) {
                        const newId = id.replace(/-\d+-\d+$/, `-${moduleIndex}-${lessonIndex}`);
                        input.setAttribute('id', newId);
                        
                        const label = element.querySelector(`label[for="${id}"]`);
                        if (label) {
                            label.setAttribute('for', newId);
                        }
                    }
                });
            }

            function addLessonEventListeners(clone) {
                const lessonTypeRadios = clone.querySelectorAll('input[name*="LessonType"]');
                
                lessonTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const lessonItem = this.closest('.lesson-item');
                        const moduleCard = lessonItem.closest('.module-card');
                        const moduleIndex = moduleCard.getAttribute('data-module-index');
                        const lessonIndex = lessonItem.getAttribute('data-lesson-index');

                        const videoSection = lessonItem.querySelector('.video-content-section');
                        const readingSection = lessonItem.querySelector('.reading-content-section');
                        const quizSection = lessonItem.querySelector('.quiz-content-section');

                        const videoTypeField = videoSection.querySelector('.lesson-type-value');
                        const readingTypeField = readingSection.querySelector('.lesson-type-value');
                        const quizTypeField = quizSection.querySelector('.lesson-type-value');

                        const videoUrlField = lessonItem.querySelector('.video-url');
                        const videoDescField = lessonItem.querySelector('.video-description');
                        const videoAttachmentField = lessonItem.querySelector('.video-attachment');

                        const readingFileField = lessonItem.querySelector('.reading-file');
                        const readingMainFileIndex = lessonItem.querySelector('.reading-content-section .main-file-index');
                        const readingDescField = lessonItem.querySelector('.reading-description');
                        const readingAttachmentField = lessonItem.querySelector('.reading-attachment');

                        const quizFileField = lessonItem.querySelector('.quiz-file');
                        const quizMainFileIndex = lessonItem.querySelector('.quiz-content-section .main-file-index');
                        const quizMaxAttemptsField = lessonItem.querySelector('.quiz-max-attempts');
                        const quizPassingScoreField = lessonItem.querySelector('.quiz-passing-score');
                        const quizTimeLimitField = lessonItem.querySelector('.quiz-time-limit');
                        const quizIsExcelField = lessonItem.querySelector('.quiz-is-excel');

                        const removeName = field => { if (field) field.removeAttribute('name'); };
                        const setName = (field, property) => { if (field) field.setAttribute('name', `Modules[${moduleIndex}].Lessons[${lessonIndex}].${property}`); };

                        if (this.value === 'Video') {
                            videoSection.style.display = 'block';
                            readingSection.style.display = 'none';
                            quizSection.style.display = 'none';

                            videoTypeField.disabled = false;
                            readingTypeField.disabled = true;
                            quizTypeField.disabled = true;

                            if (videoUrlField) videoUrlField.setAttribute('required', 'required');
                            setName(videoDescField, 'Description');
                            setName(videoAttachmentField, 'AttachmentUrl');

                            if (readingFileField) {
                                readingFileField.value = '';
                                readingFileField.disabled = true;
                                readingFileField.removeAttribute('required');
                            }
                            if (readingMainFileIndex) {
                                readingMainFileIndex.value = '';
                                readingMainFileIndex.disabled = true;
                                removeName(readingMainFileIndex);
                            }
                            if (readingDescField) {
                                readingDescField.value = '';
                                removeName(readingDescField);
                            }
                            if (readingAttachmentField) {
                                readingAttachmentField.value = '';
                                removeName(readingAttachmentField);
                            }

                            if (quizFileField) {
                                quizFileField.value = '';
                                quizFileField.disabled = true;
                                quizFileField.removeAttribute('required');
                            }
                            if (quizMainFileIndex) {
                                quizMainFileIndex.value = '';
                                quizMainFileIndex.disabled = true;
                                removeName(quizMainFileIndex);
                            }
                            removeName(quizMaxAttemptsField);
                            removeName(quizPassingScoreField);
                            removeName(quizTimeLimitField);
                            removeName(quizIsExcelField);
                        } else if (this.value === 'Reading') {
                            videoSection.style.display = 'none';
                            readingSection.style.display = 'block';
                            quizSection.style.display = 'none';

                            videoTypeField.disabled = true;
                            readingTypeField.disabled = false;
                            quizTypeField.disabled = true;

                            if (videoUrlField) {
                                videoUrlField.value = '';
                                videoUrlField.removeAttribute('required');
                            }
                            if (videoDescField) {
                                videoDescField.value = '';
                                removeName(videoDescField);
                            }
                            if (videoAttachmentField) {
                                videoAttachmentField.value = '';
                                removeName(videoAttachmentField);
                            }

                            if (readingFileField) {
                                readingFileField.disabled = false;
                                readingFileField.setAttribute('required', 'required');
                            }
                            if (readingMainFileIndex) {
                                readingMainFileIndex.disabled = false;
                                setName(readingMainFileIndex, 'MainFileIndex');
                            }
                            setName(readingDescField, 'Description');
                            setName(readingAttachmentField, 'AttachmentUrl');

                            if (quizFileField) {
                                quizFileField.value = '';
                                quizFileField.disabled = true;
                                quizFileField.removeAttribute('required');
                            }
                            if (quizMainFileIndex) {
                                quizMainFileIndex.value = '';
                                quizMainFileIndex.disabled = true;
                                removeName(quizMainFileIndex);
                            }
                            removeName(quizMaxAttemptsField);
                            removeName(quizPassingScoreField);
                            removeName(quizTimeLimitField);
                            removeName(quizIsExcelField);
                        } else if (this.value === 'Quiz') {
                            videoSection.style.display = 'none';
                            readingSection.style.display = 'none';
                            quizSection.style.display = 'block';

                            videoTypeField.disabled = true;
                            readingTypeField.disabled = true;
                            quizTypeField.disabled = false;

                            if (videoUrlField) {
                                videoUrlField.value = '';
                                videoUrlField.removeAttribute('required');
                            }
                            if (videoDescField) {
                                videoDescField.value = '';
                                removeName(videoDescField);
                            }
                            if (videoAttachmentField) {
                                videoAttachmentField.value = '';
                                removeName(videoAttachmentField);
                            }

                            if (readingFileField) {
                                readingFileField.value = '';
                                readingFileField.disabled = true;
                                readingFileField.removeAttribute('required');
                            }
                            if (readingMainFileIndex) {
                                readingMainFileIndex.value = '';
                                readingMainFileIndex.disabled = true;
                                removeName(readingMainFileIndex);
                            }
                            if (readingDescField) {
                                readingDescField.value = '';
                                removeName(readingDescField);
                            }
                            if (readingAttachmentField) {
                                readingAttachmentField.value = '';
                                removeName(readingAttachmentField);
                            }

                            if (quizFileField) {
                                quizFileField.disabled = false;
                                quizFileField.setAttribute('required', 'required');
                            }
                            if (quizMainFileIndex) {
                                quizMainFileIndex.disabled = false;
                                setName(quizMainFileIndex, 'MainFileIndex');
                            }
                            setName(quizMaxAttemptsField, 'QuizMaxAttempts');
                            setName(quizPassingScoreField, 'QuizPassingScore');
                            setName(quizTimeLimitField, 'QuizTimeLimit');
                            setName(quizIsExcelField, 'IsQuizExcel');
                        }
                    });
                });

                clone.querySelector('.remove-lesson').addEventListener('click', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const moduleCard = lessonItem.closest('.module-card');
                    lessonItem.remove();
                    updateLessonOrders(moduleCard);
                });

                clone.querySelector('.move-up-lesson').addEventListener('click', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const prevLesson = lessonItem.previousElementSibling;
                    const moduleCard = lessonItem.closest('.module-card');
                    if (prevLesson) {
                        lessonItem.parentNode.insertBefore(lessonItem, prevLesson);
                        updateLessonOrders(moduleCard);
                    }
                });

                clone.querySelector('.move-down-lesson').addEventListener('click', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const nextLesson = lessonItem.nextElementSibling;
                    const moduleCard = lessonItem.closest('.module-card');
                    if (nextLesson) {
                        lessonItem.parentNode.insertBefore(nextLesson, lessonItem);
                        updateLessonOrders(moduleCard);
                    }
                });

                const videoUrl = clone.querySelector('.video-url');
                if (videoUrl) {
                    videoUrl.addEventListener('blur', function() {
                        if (this.value && !this.checkValidity()) {
                            alert('Vui lòng nhập URL video hợp lệ');
                        }
                    });
                }

                const maxAttempts = clone.querySelector('.quiz-max-attempts');
                const passingScore = clone.querySelector('.quiz-passing-score');
                const timeLimit = clone.querySelector('.quiz-time-limit');
                
                if (maxAttempts) {
                    maxAttempts.addEventListener('change', function() {
                        if (this.value < 1) this.value = 1;
                        if (this.value > 10) this.value = 10;
                    });
                }
                
                if (passingScore) {
                    passingScore.addEventListener('change', function() {
                        if (this.value < 0) this.value = 0;
                        if (this.value > 100) this.value = 100;
                    });
                }
                
                if (timeLimit) {
                    timeLimit.addEventListener('change', function() {
                        if (this.value < 1) this.value = 1;
                        if (this.value > 180) this.value = 180;
                    });
                }
            }

            function updateModuleOrders() {
                const moduleCards = document.querySelectorAll('.module-card');
                moduleCards.forEach((card, index) => {
                    card.setAttribute('data-module-index', index);
                    card.querySelector('.module-number').textContent = index + 1;
                    card.querySelector('.module-order').value = index + 1;
                    
                    const inputs = card.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.includes('Modules[')) {
                            const newName = name.replace(/Modules\[\d+\]/, `Modules[${index}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                    
                    updateLessonOrders(card);
                });
            }

            function updateLessonOrders(moduleCard) {
                const moduleIndex = moduleCard.getAttribute('data-module-index');
                const lessonItems = moduleCard.querySelectorAll('.lesson-item');
                
                lessonItems.forEach((item, index) => {
                    item.setAttribute('data-lesson-index', index);
                    item.querySelector('.lesson-number').textContent = index + 1;
                    item.querySelector('.lesson-order').value = index + 1;
                    
                    const inputs = item.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.includes('Lessons[')) {
                            const newName = name.replace(/Lessons\[\d+\]/, `Lessons[${index}]`);
                            input.setAttribute('name', newName);
                        }
                        
                        const id = input.getAttribute('id');
                        if (id && id.includes('lesson-type-')) {
                            const newId = id.replace(/-\d+-\d+$/, `-${moduleIndex}-${index}`);
                            input.setAttribute('id', newId);
                            
                            const label = item.querySelector(`label[for="${id}"]`);
                            if (label) {
                                label.setAttribute('for', newId);
                            }
                        }
                    });
                });
            }

            function initializeLessonTypeState(lessonElement) {
                if (!lessonElement) return;
                const activeRadio = lessonElement.querySelector('input[name*="LessonType"]:checked');
                if (activeRadio) {
                    activeRadio.dispatchEvent(new Event('change'));
                }
            }

            $('form').on('submit', function(e) {
                const modules = document.querySelectorAll('.module-card');
                if (modules.length === 0) {
                    e.preventDefault();
                    alert('Vui lòng thêm ít nhất 1 module cho khóa học.');
                    return false;
                }

                let hasError = false;
                let fileIndex = 0; 
                
                modules.forEach((module, index) => {
                    const lessons = module.querySelectorAll('.lesson-item');
                    if (lessons.length === 0) {
                        hasError = true;
                        alert(`Module ${index + 1} phải có ít nhất 1 bài học.`);
                    }
                    
                    lessons.forEach((lesson, lessonIndex) => {
                        const lessonType = lesson.querySelector('input[name*="LessonType"]:checked');
                        if (!lessonType) {
                            hasError = true;
                            alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Vui lòng chọn loại bài học.`);
                            return;
                        }
                        
                        if (lessonType.value === 'Video') {
                            const videoUrl = lesson.querySelector('.video-url');
                            if (!videoUrl || !videoUrl.value.trim()) {
                                hasError = true;
                                alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Vui lòng nhập URL video.`);
                            }
                            
                            const videoMainFileIndex = lesson.querySelector('.video-content-section .main-file-index');
                            if (videoMainFileIndex) {
                                videoMainFileIndex.removeAttribute('name'); 
                            }
                        } else if (lessonType.value === 'Reading') {
                            const readingFile = lesson.querySelector('.reading-file');
                            
                            
                            const wasDisabled = readingFile.disabled;
                            readingFile.disabled = false;
                            
                            if (!readingFile || !readingFile.files || readingFile.files.length === 0) {
                                hasError = true;
                                alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Vui lòng upload file tài liệu chính.`);
                                if (wasDisabled) readingFile.disabled = true; 
                            } else {
                                const mainFileIndexField = lesson.querySelector('.reading-content-section .main-file-index');
                                if (mainFileIndexField) {
                                    mainFileIndexField.value = fileIndex;
                                    mainFileIndexField.disabled = false; 
                                    const moduleIdx = lesson.closest('.module-card').getAttribute('data-module-index');
                                    const lessonIdx = lesson.getAttribute('data-lesson-index');
                                    mainFileIndexField.setAttribute('name', `Modules[${moduleIdx}].Lessons[${lessonIdx}].MainFileIndex`);
                                    fileIndex++; 
                                }
                            }
                        } else if (lessonType.value === 'Quiz') {
                            const quizFile = lesson.querySelector('.quiz-file');
                            
                            const wasDisabled = quizFile.disabled;
                            quizFile.disabled = false;
                            
                            if (!quizFile || !quizFile.files || quizFile.files.length === 0) {
                                hasError = true;
                                alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Vui lòng upload file Excel Quiz.`);
                                if (wasDisabled) quizFile.disabled = true; 
                            } else {
                                const mainFileIndexField = lesson.querySelector('.quiz-content-section .main-file-index');
                                if (mainFileIndexField) {
                                    mainFileIndexField.value = fileIndex;
                                    mainFileIndexField.disabled = false; 
                                    const moduleIdx = lesson.closest('.module-card').getAttribute('data-module-index');
                                    const lessonIdx = lesson.getAttribute('data-lesson-index');
                                    mainFileIndexField.setAttribute('name', `Modules[${moduleIdx}].Lessons[${lessonIdx}].MainFileIndex`);
                                    fileIndex++; 
                                }
                            }
                            
                            const maxAttempts = lesson.querySelector('.quiz-max-attempts');
                            const passingScore = lesson.querySelector('.quiz-passing-score');
                            const timeLimit = lesson.querySelector('.quiz-time-limit');
                            
                            if (maxAttempts && (maxAttempts.value < 1 || maxAttempts.value > 10)) {
                                hasError = true;
                                alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Số lần làm bài phải từ 1 đến 10.`);
                            }
                            if (passingScore && (passingScore.value < 0 || passingScore.value > 100)) {
                                hasError = true;
                                alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Điểm pass phải từ 0% đến 100%.`);
                            }
                            if (timeLimit && (timeLimit.value < 1 || timeLimit.value > 180)) {
                                hasError = true;
                                alert(`Module ${index + 1}, Bài học ${lessonIndex + 1}: Thời gian làm bài phải từ 1 đến 180 phút.`);
                            }
                        }
                    });
                });

                if (hasError) {
                    e.preventDefault();
                    return false;
                }

                const selectedDepts = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked');
                if (selectedDepts.length === 0) {
                    e.preventDefault();
                    alert('Vui lòng chọn ít nhất 1 phòng ban để áp dụng khóa học.');
                    return false;
                }
            });
        });
    </script>
}