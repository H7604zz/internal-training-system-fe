@model InternalTrainingSystem.WebApp.Models.DTOs.CreateFullCourseDto
@using InternalTrainingSystem.WebApp.Constants
@using InternalTrainingSystem.WebApp.Extensions
@{
    ViewData["Title"] = "Thêm Khóa Học Mới";
}

@section Styles {
    <link rel="stylesheet" href="~/css/khoa-hoc.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tao-moi-khoa-hoc.css" asp-append-version="true" />
}

<div class="course-container">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="form-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="form-title">
                        <i class="fas fa-plus-circle me-3"></i>Thêm Khóa Học Mới
                    </h1>
                    <p class="form-subtitle">Tạo mới khóa học đào tạo nội bộ</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="@Url.Action("Index")" class="btn btn-back">
                        <i class="fas fa-arrow-left me-2"></i>Quay Lại
                    </a>
                </div>
            </div>
        </div>

        <!-- Add Form -->
        <form method="post" asp-controller="KhoaHoc" asp-action="TaoMoi" enctype="multipart/form-data" class="course-edit-form" novalidate>
            @Html.AntiForgeryToken()

            <div class="row">
                <!-- Main Form -->
                <div class="col-lg-8 mb-4">
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-info-circle me-2"></i>Thông Tin Cơ Bản
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="CourseName" class="form-label required">Tên khóa học</label>
                                <input asp-for="CourseName" class="form-control" placeholder="Nhập tên khóa học">
                                <span asp-validation-for="CourseName" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="CourseCode" class="form-label required">Mã khóa học</label>
                                <input asp-for="CourseCode" class="form-control" placeholder="VD: IT-001">
                                <span asp-validation-for="CourseCode" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Mô tả khóa học</label>
                            <textarea asp-for="Description" class="form-control" rows="4" 
                                      placeholder="Nhập mô tả chi tiết về khóa học..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="CourseCategoryId" class="form-label required">Danh mục</label>
                                <select asp-for="CourseCategoryId" class="form-select">
                                    <option value="">Chọn danh mục</option>
                                    @if (ViewBag.Categories != null)
                                    {
                                        @foreach (var category in ViewBag.Categories)
                                        {
                                            <option value="@category.CourseCategoryId">@category.CategoryName</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CourseCategoryId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Level" class="form-label required">Cấp độ</label>
                                <select asp-for="Level" class="form-select">
                                    <option value="">Chọn cấp độ</option>
                                    <option value="Beginner">Cơ bản</option>
                                    <option value="Intermediate">Trung cấp</option>
                                    <option value="Advanced">Nâng cao</option>
                                </select>
                                <span asp-validation-for="Level" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Duration" class="form-label required">Thời lượng (giờ)</label>
                                <input asp-for="Duration" type="number" class="form-control" min="1"
                                       placeholder="VD: 40" value="1">
                                <span asp-validation-for="Duration" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tùy chọn khóa học</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsOnline" class="form-check-input" type="checkbox" role="switch" checked>
                                        <label asp-for="IsOnline" class="form-check-label">
                                            Khóa học trực tuyến
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input asp-for="IsMandatory" class="form-check-input" type="checkbox" role="switch">
                                        <label asp-for="IsMandatory" class="form-check-label">
                                            Khóa học bắt buộc
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Department Selection -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-building me-2"></i>Phòng Ban Áp Dụng
                        </h3>
                        <p class="form-help-text">Chọn các phòng ban mà khóa học này sẽ được áp dụng</p>
                        
                        <div class="departments-selection">
                            @if (ViewBag.Departments != null)
                            {
                                var selectedDepartmentIds = ViewBag.SelectedDepartmentIds as List<int> ?? Model.SelectedDepartmentIds ?? new List<int>();
                                
                                @foreach (var dept in ViewBag.Departments)
                                {
                                    <div class="form-check department-check">
                                        <input class="form-check-input" type="checkbox"
                                               name="SelectedDepartmentIds" value="@dept.DepartmentId"
                                               id="dept_@dept.DepartmentId"
                                               @(selectedDepartmentIds.Contains(dept.DepartmentId) ? "checked" : "")>
                                        <label class="form-check-label" for="dept_@dept.DepartmentId">
                                            <i class="fas fa-building me-2"></i>
                                            @dept.DepartmentName
                                        </label>
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- Course Content Section -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-book me-2"></i>Nội Dung Khóa Học
                        </h3>
                        <p class="form-help-text">Tạo các module và bài học cho khóa học. Khóa học phải có ít nhất 1 module và mỗi module phải có ít nhất 1 bài học.</p>

                        <!-- Modules Container -->
                        <div id="modules-container">
                            <!-- Modules will be dynamically added here -->
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary" id="add-module-btn">
                                <i class="fas fa-plus me-2"></i>Thêm Module
                            </button>
                        </div>

                        <!-- Hidden file input for lesson files -->
                        <input type="file" id="lesson-file-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.mp4,.mp3" style="display: none;">
                    </div>
                </div>

                <!-- Side Panel -->
                <div class="col-lg-4 mb-4">
                    <!-- Form Actions -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-save me-2"></i>Thao Tác
                        </h3>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-save">
                                <i class="fas fa-plus me-2"></i>Tạo Khóa Học
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-cancel">
                                <i class="fas fa-times me-2"></i>Hủy Bỏ
                            </a>
                        </div>

                    </div>

                    <!-- Form Help -->
                    <div class="form-card">
                        <h3 class="form-section-title">
                            <i class="fas fa-question-circle me-2"></i>Hướng Dẫn
                        </h3>
                        
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Tên khóa học nên ngắn gọn và dễ hiểu</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Mã khóa học nên theo chuẩn: AB-123</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Chọn cấp độ phù hợp với nội dung khóa học</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Thời lượng tính bằng giờ học lý thuyết</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Chọn ít nhất 1 phòng ban để áp dụng khóa học</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Khóa học sẽ cần được phê duyệt trước khi hoạt động</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>"Trực tuyến" cho khóa học online, "Bắt buộc" cho khóa học bắt buộc</span>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Module Template -->
<template id="module-template">
    <div class="module-card" data-module-index="">
        <div class="module-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder me-2"></i>Module <span class="module-number">1</span>
                </h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-light move-up-module" title="Di chuyển lên">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light move-down-module" title="Di chuyển xuống">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button type="button" class="btn btn-danger remove-module" title="Xóa module">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="p-3">
            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label required">Tên Module</label>
                    <input type="text" name="Modules[0].Title" class="form-control" placeholder="Nhập tên module" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Thứ tự</label>
                    <input type="number" name="Modules[0].OrderIndex" class="form-control module-order" min="1" value="1" readonly>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Mô tả Module</label>
                <textarea name="Modules[0].Description" class="form-control" rows="2" placeholder="Nhập mô tả module..."></textarea>
            </div>

            <!-- Lessons Section -->
            <div class="lessons-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6><i class="fas fa-play-circle me-2"></i>Bài Học</h6>
                    <button type="button" class="add-lesson-btn btn btn-sm">
                        <i class="fas fa-plus me-1"></i>Thêm Bài Học
                    </button>
                </div>
                <div class="lessons-container">
                    <!-- Lessons will be added here -->
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Lesson Template -->
<template id="lesson-template">
    <div class="lesson-item" data-lesson-index="">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h6 class="mb-0">
                <i class="fas fa-play me-2"></i>Bài học <span class="lesson-number">1</span>
            </h6>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary move-up-lesson" title="Di chuyển lên">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-outline-secondary move-down-lesson" title="Di chuyển xuống">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-outline-danger remove-lesson" title="Xóa bài học">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-8">
                <label class="form-label required">Tên Bài Học</label>
                <input type="text" name="Modules[0].Lessons[0].Title" class="form-control" placeholder="Nhập tên bài học" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Thứ tự</label>
                <input type="number" name="Modules[0].Lessons[0].OrderIndex" class="form-control lesson-order" min="1" value="1" readonly>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label required">Loại Bài Học</label>
                <select name="Modules[0].Lessons[0].Type" class="form-select lesson-type" required>
                    <option value="">Chọn loại bài học</option>
                    <option value="1">Video</option>
                    <option value="2">Đọc hiểu</option>
                    <option value="3">Tệp tin</option>
                    <option value="4">Liên kết</option>
                    <option value="5">Bài kiểm tra</option>
                </select>
            </div>
            <div class="col-md-6">
                <div class="lesson-type-badge">
                    <span class="badge bg-secondary type-indicator">Chọn loại</span>
                </div>
            </div>
        </div>

        <!-- Content fields (shown/hidden based on lesson type) -->
        <div class="lesson-content-fields">
            <!-- URL field for Video/Link types -->
            <div class="content-field url-field" style="display: none;">
                <label class="form-label">URL</label>
                <input type="url" name="Modules[0].Lessons[0].ContentUrl" class="form-control" placeholder="Nhập URL">
            </div>

            <!-- File upload field for File type -->
            <div class="content-field file-field" style="display: none;">
                <label class="form-label">Tệp tin</label>
                <input type="file" name="LessonFiles" class="form-control" accept=".pdf,.doc,.docx,.ppt,.pptx,.mp4,.mp3">
                <input type="hidden" name="Modules[0].Lessons[0].UploadBinary" value="true">
            </div>

            <!-- HTML content field for Reading type -->
            <div class="content-field html-field" style="display: none;">
                <label class="form-label">Nội dung</label>
                <textarea name="Modules[0].Lessons[0].ContentHtml" class="form-control" rows="4" placeholder="Nhập nội dung bài học..."></textarea>
            </div>

            <!-- Quiz fields for Quiz type -->
            <div class="content-field quiz-field" style="display: none;">
                <div class="mb-3">
                    <label class="form-label">Tiêu đề Quiz</label>
                    <input type="text" name="Modules[0].Lessons[0].QuizTitle" class="form-control" placeholder="Nhập tiêu đề quiz">
                </div>
                <div class="form-check">
                    <input type="checkbox" name="Modules[0].Lessons[0].IsQuizExcel" class="form-check-input">
                    <label class="form-check-label">Quiz từ file Excel</label>
                </div>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        $(document).ready(function() {
            let moduleCount = 0;

            // Auto-generate course code from course name
            $('#CourseName').on('blur', function() {
                const courseName = $(this).val().trim();
                const courseCodeField = $('#CourseCode');
                
                if (courseName && !courseCodeField.val()) {
                    // Take first 2 words and get first letter of each
                    const words = courseName.split(' ').slice(0, 2);
                    const initials = words.map(word => word.charAt(0).toUpperCase()).join('');
                    
                    // Generate random 3-digit number
                    const randomNum = String(Math.floor(Math.random() * 900) + 100).padStart(3, '0');
                    
                    // Create course code: TK-012
                    const courseCode = `${initials}-${randomNum}`;
                    courseCodeField.val(courseCode);
                }
            });

            // Add module button click
            $('#add-module-btn').click(function() {
                addModule();
            });

            // Check if we have existing modules from server (in case of validation errors)
            const existingModules = @Html.Raw(Json.Serialize(Model.Modules));
            const selectedDepartments = @Html.Raw(Json.Serialize(ViewBag.SelectedDepartmentIds ?? Model.SelectedDepartmentIds ?? new List<int>()));
            
            if (existingModules && existingModules.length > 0) {
                // Restore existing modules and lessons
                restoreExistingData(existingModules);
            } else {
                // Add initial module if no existing data
                addModule();
            }

            // Restore selected departments
            if (selectedDepartments && selectedDepartments.length > 0) {
                selectedDepartments.forEach(departmentId => {
                    const checkbox = $(`#dept_${departmentId}`);
                    if (checkbox.length > 0) {
                        checkbox.prop('checked', true);
                    }
                });
                console.log('Restored selected departments:', selectedDepartments);
            }

            function restoreExistingData(modules) {
                modules.forEach((moduleData, moduleIndex) => {
                    const moduleCard = addModuleWithData(moduleData, moduleIndex);
                    
                    // Restore lessons for this module
                    if (moduleData.lessons && moduleData.lessons.length > 0) {
                        moduleData.lessons.forEach((lessonData, lessonIndex) => {
                            addLessonWithData(moduleCard, lessonData, moduleIndex, lessonIndex);
                        });
                    } else {
                        // Add at least one empty lesson if no lessons exist
                        addLesson(moduleCard);
                    }
                });
                
                updateModuleOrders();
            }

            function addModuleWithData(moduleData, moduleIndex) {
                const template = document.getElementById('module-template');
                const clone = template.content.cloneNode(true);
                
                // Update module index and names
                const moduleDiv = clone.querySelector('.module-card');
                moduleDiv.setAttribute('data-module-index', moduleIndex);
                
                // Update module number
                clone.querySelector('.module-number').textContent = moduleIndex + 1;
                
                // Fill in module data
                clone.querySelector('input[name*="Title"]').value = moduleData.title || '';
                clone.querySelector('textarea[name*="Description"]').value = moduleData.description || '';
                clone.querySelector('input[name*="OrderIndex"]').value = moduleData.orderIndex || moduleIndex + 1;
                
                // Update form field names
                updateModuleFieldNames(clone, moduleIndex);
                
                // Add event listeners
                addModuleEventListeners(clone);
                
                // Append to container
                document.getElementById('modules-container').appendChild(clone);
                
                moduleCount = Math.max(moduleCount, moduleIndex + 1);
                
                return moduleDiv;
            }

            function addLessonWithData(moduleCard, lessonData, moduleIndex, lessonIndex) {
                const lessonsContainer = moduleCard.querySelector('.lessons-container');
                
                const template = document.getElementById('lesson-template');
                const clone = template.content.cloneNode(true);
                
                // Update lesson index and names
                const lessonDiv = clone.querySelector('.lesson-item');
                lessonDiv.setAttribute('data-lesson-index', lessonIndex);
                
                // Update lesson number
                clone.querySelector('.lesson-number').textContent = lessonIndex + 1;
                
                // Fill in lesson data
                clone.querySelector('input[name*="Title"]').value = lessonData.title || '';
                clone.querySelector('input[name*="OrderIndex"]').value = lessonData.orderIndex || lessonIndex + 1;
                clone.querySelector('select[name*="Type"]').value = lessonData.type || '';
                
                // Fill content based on lesson type
                if (lessonData.contentUrl) {
                    clone.querySelector('input[name*="ContentUrl"]').value = lessonData.contentUrl;
                }
                if (lessonData.contentHtml) {
                    clone.querySelector('textarea[name*="ContentHtml"]').value = lessonData.contentHtml;
                }
                if (lessonData.quizTitle) {
                    clone.querySelector('input[name*="QuizTitle"]').value = lessonData.quizTitle;
                }
                if (lessonData.uploadBinary) {
                    clone.querySelector('input[name*="UploadBinary"]').value = lessonData.uploadBinary;
                }
                if (lessonData.isQuizExcel) {
                    clone.querySelector('input[name*="IsQuizExcel"]').checked = lessonData.isQuizExcel;
                }
                
                // Update form field names
                updateLessonFieldNames(clone, moduleIndex, lessonIndex);
                
                // Add event listeners
                addLessonEventListeners(clone);
                
                // Show appropriate content fields based on lesson type
                if (lessonData.type) {
                    updateLessonContentFields(clone.querySelector('.lesson-item'), lessonData.type.toString());
                }
                
                // Append to lessons container
                lessonsContainer.appendChild(clone);
            }

            function addModule() {
                const template = document.getElementById('module-template');
                const clone = template.content.cloneNode(true);
                
                // Update module index and names
                const moduleDiv = clone.querySelector('.module-card');
                moduleDiv.setAttribute('data-module-index', moduleCount);
                
                // Update module number
                clone.querySelector('.module-number').textContent = moduleCount + 1;
                
                // Update form field names
                updateModuleFieldNames(clone, moduleCount);
                
                // Add event listeners
                addModuleEventListeners(clone);
                
                // Append to container
                document.getElementById('modules-container').appendChild(clone);
                
                // Add initial lesson
                addLesson(moduleDiv);
                
                moduleCount++;
                updateModuleOrders();
            }

            function updateModuleFieldNames(element, moduleIndex) {
                const inputs = element.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name.replace(/Modules\[\d+\]/, `Modules[${moduleIndex}]`);
                        input.setAttribute('name', newName);
                    }
                });
            }

            function addModuleEventListeners(clone) {
                // Remove module button
                clone.querySelector('.remove-module').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    moduleCard.remove();
                    updateModuleOrders();
                });

                // Move module up
                clone.querySelector('.move-up-module').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    const prevModule = moduleCard.previousElementSibling;
                    if (prevModule) {
                        moduleCard.parentNode.insertBefore(moduleCard, prevModule);
                        updateModuleOrders();
                    }
                });

                // Move module down
                clone.querySelector('.move-down-module').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    const nextModule = moduleCard.nextElementSibling;
                    if (nextModule) {
                        moduleCard.parentNode.insertBefore(nextModule, moduleCard);
                        updateModuleOrders();
                    }
                });

                // Add lesson button
                clone.querySelector('.add-lesson-btn').addEventListener('click', function() {
                    const moduleCard = this.closest('.module-card');
                    addLesson(moduleCard);
                });
            }

            function addLesson(moduleCard) {
                const moduleIndex = moduleCard.getAttribute('data-module-index');
                const lessonsContainer = moduleCard.querySelector('.lessons-container');
                const lessonCount = lessonsContainer.children.length;
                
                const template = document.getElementById('lesson-template');
                const clone = template.content.cloneNode(true);
                
                // Update lesson index and names
                const lessonDiv = clone.querySelector('.lesson-item');
                lessonDiv.setAttribute('data-lesson-index', lessonCount);
                
                // Update lesson number
                clone.querySelector('.lesson-number').textContent = lessonCount + 1;
                
                // Update form field names
                updateLessonFieldNames(clone, moduleIndex, lessonCount);
                
                // Add event listeners
                addLessonEventListeners(clone);
                
                // Append to lessons container
                lessonsContainer.appendChild(clone);
                
                updateLessonOrders(moduleCard);
            }

            function updateLessonFieldNames(element, moduleIndex, lessonIndex) {
                const inputs = element.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        const newName = name
                            .replace(/Modules\[\d+\]/, `Modules[${moduleIndex}]`)
                            .replace(/Lessons\[\d+\]/, `Lessons[${lessonIndex}]`);
                        input.setAttribute('name', newName);
                    }
                });
            }

            function addLessonEventListeners(clone) {
                // Remove lesson button
                clone.querySelector('.remove-lesson').addEventListener('click', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const moduleCard = lessonItem.closest('.module-card');
                    lessonItem.remove();
                    updateLessonOrders(moduleCard);
                });

                // Move lesson up
                clone.querySelector('.move-up-lesson').addEventListener('click', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const prevLesson = lessonItem.previousElementSibling;
                    const moduleCard = lessonItem.closest('.module-card');
                    if (prevLesson) {
                        lessonItem.parentNode.insertBefore(lessonItem, prevLesson);
                        updateLessonOrders(moduleCard);
                    }
                });

                // Move lesson down
                clone.querySelector('.move-down-lesson').addEventListener('click', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const nextLesson = lessonItem.nextElementSibling;
                    const moduleCard = lessonItem.closest('.module-card');
                    if (nextLesson) {
                        lessonItem.parentNode.insertBefore(nextLesson, lessonItem);
                        updateLessonOrders(moduleCard);
                    }
                });

                // Lesson type change
                clone.querySelector('.lesson-type').addEventListener('change', function() {
                    const lessonItem = this.closest('.lesson-item');
                    const selectedType = this.value;
                    updateLessonContentFields(lessonItem, selectedType);
                    updateLessonTypeBadge(lessonItem, selectedType);
                });
            }

            function updateLessonContentFields(lessonItem, type) {
                const contentFields = lessonItem.querySelectorAll('.content-field');
                contentFields.forEach(field => field.style.display = 'none');

                const typeIndicator = lessonItem.querySelector('.type-indicator');
                
                switch(type) {
                    case '1': // Video
                        lessonItem.querySelector('.url-field').style.display = 'block';
                        typeIndicator.className = 'badge bg-danger type-indicator';
                        typeIndicator.textContent = 'Video';
                        break;
                    case '2': // Reading
                        lessonItem.querySelector('.html-field').style.display = 'block';
                        typeIndicator.className = 'badge bg-info type-indicator';
                        typeIndicator.textContent = 'Đọc hiểu';
                        break;
                    case '3': // File
                        lessonItem.querySelector('.file-field').style.display = 'block';
                        typeIndicator.className = 'badge bg-warning type-indicator';
                        typeIndicator.textContent = 'Tệp tin';
                        break;
                    case '4': // Link
                        lessonItem.querySelector('.url-field').style.display = 'block';
                        typeIndicator.className = 'badge bg-primary type-indicator';
                        typeIndicator.textContent = 'Liên kết';
                        break;
                    case '5': // Quiz
                        lessonItem.querySelector('.quiz-field').style.display = 'block';
                        typeIndicator.className = 'badge bg-success type-indicator';
                        typeIndicator.textContent = 'Bài kiểm tra';
                        break;
                    default:
                        typeIndicator.className = 'badge bg-secondary type-indicator';
                        typeIndicator.textContent = 'Chọn loại';
                }
            }

            function updateLessonTypeBadge(lessonItem, type) {
                // Already handled in updateLessonContentFields
            }

            function updateModuleOrders() {
                const moduleCards = document.querySelectorAll('.module-card');
                moduleCards.forEach((card, index) => {
                    card.setAttribute('data-module-index', index);
                    card.querySelector('.module-number').textContent = index + 1;
                    card.querySelector('.module-order').value = index + 1;
                    
                    // Update all field names in this module
                    const inputs = card.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.includes('Modules[')) {
                            const newName = name.replace(/Modules\[\d+\]/, `Modules[${index}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                    
                    updateLessonOrders(card);
                });
            }

            function updateLessonOrders(moduleCard) {
                const moduleIndex = moduleCard.getAttribute('data-module-index');
                const lessonItems = moduleCard.querySelectorAll('.lesson-item');
                
                lessonItems.forEach((item, index) => {
                    item.setAttribute('data-lesson-index', index);
                    item.querySelector('.lesson-number').textContent = index + 1;
                    item.querySelector('.lesson-order').value = index + 1;
                    
                    // Update all field names in this lesson
                    const inputs = item.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.includes('Lessons[')) {
                            const newName = name.replace(/Lessons\[\d+\]/, `Lessons[${index}]`);
                            input.setAttribute('name', newName);
                        }
                    });
                });
            }

            // Form validation
            $('form').on('submit', function(e) {
                const modules = document.querySelectorAll('.module-card');
                if (modules.length === 0) {
                    e.preventDefault();
                    alert('Vui lòng thêm ít nhất 1 module cho khóa học.');
                    return false;
                }

                // Check each module has at least one lesson
                let hasError = false;
                modules.forEach((module, index) => {
                    const lessons = module.querySelectorAll('.lesson-item');
                    if (lessons.length === 0) {
                        hasError = true;
                        alert(`Module ${index + 1} phải có ít nhất 1 bài học.`);
                    }
                });

                if (hasError) {
                    e.preventDefault();
                    return false;
                }

                // Check department selection
                const selectedDepts = document.querySelectorAll('input[name="SelectedDepartmentIds"]:checked');
                if (selectedDepts.length === 0) {
                    e.preventDefault();
                    alert('Vui lòng chọn ít nhất 1 phòng ban để áp dụng khóa học.');
                    return false;
                }
            });
        });
    </script>
}