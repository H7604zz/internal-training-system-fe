@using InternalTrainingSystem.WebApp.Constants

@{
    var userFullName = Context.Session.GetString("UserFullName");
    var userEmail = Context.Session.GetString("UserEmail");
}

@if (!string.IsNullOrEmpty(userFullName))
{
    <!-- Notification Bell -->
    <li class="nav-item dropdown me-2">
        <a class="nav-link dropdown-toggle text-white position-relative p-2" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Thông báo">
            <i class="fas fa-bell fs-5"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-badge" style="display: none; font-size: 0.6rem;">
                0
            </span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end notification-dropdown shadow-lg" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 450px; overflow-y: auto;">
            <li class="dropdown-header d-flex justify-content-between align-items-center py-2 px-3 bg-light">
                <span class="fw-bold text-dark">
                    <i class="fas fa-bell me-2"></i>Thông báo
                </span>
                <button class="btn btn-sm btn-outline-primary" onclick="markAllAsRead()" id="mark-all-btn">
                    <i class="fas fa-check-double me-1"></i>Đánh dấu tất cả
                </button>
            </li>
            <li><hr class="dropdown-divider m-0"></li>
            <div id="notification-list" class="notification-list">
                <li class="text-center p-4">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <div class="mt-2 text-muted">Đang tải thông báo...</div>
                </li>
            </div>
            <li><hr class="dropdown-divider m-0"></li>
            <li class="text-center p-2">
                <a class="btn btn-sm btn-link text-decoration-none me-2" href="#" onclick="loadMoreNotifications()">
                    <i class="fas fa-list me-1"></i>Xem tất cả
                </a>
                <button class="btn btn-sm btn-outline-success" onclick="createTestNotification()" title="Tạo thông báo test">
                    <i class="fas fa-plus me-1"></i>Test
                </button>
            </li>
        </ul>
    </li>

    <!-- User Menu -->
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-user-circle me-1"></i>@userFullName
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
            <li><h6 class="dropdown-header">@userEmail</h6></li>
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" asp-controller="NguoiDung" asp-action="ThongTinCaNhan">
                    <i class="fas fa-user me-2"></i>Thông tin cá nhân
                </a>
            </li>
            @if (User.IsInRole(UserRoles.Staff))
            {
                <li>
                    <a class="dropdown-item" asp-controller="KhoaHoc" asp-action="DanhSachKhoaHocCuaToi">
                        <i class="fas fa-graduation-cap me-2"></i>Khóa học của tôi
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-controller="NguoiDung" asp-action="ThoiKhoaBieu">
                        <i class="fas fa-calendar-alt me-2"></i>Thời khóa biểu
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" asp-controller="NguoiDung" asp-action="BaoCaoTinhHinh">
                        <i class="fas fa-chart-line me-2"></i>Báo cáo tình hình
                    </a>
                </li>
                
            }
            @if (User.IsInRole(UserRoles.Mentor))
            {
                <li>
                    <a class="dropdown-item" asp-controller="NguoiDung" asp-action="ThoiKhoaBieu">
                        <i class="fas fa-calendar-alt me-2"></i>Thời khóa biểu
                    </a>
                </li>
            }
            <li><hr class="dropdown-divider"></li>
            <li>
                <a class="dropdown-item" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                </a>
            </li>
        </ul>
    </li>

    <!-- User Menu & Notification Scripts -->
    <script src="~/js/notifications.js" asp-append-version="true"></script>
    <script>
        // Logout function
        function logout() {
            if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
                window.location.href = '@Url.Action("DangXuat", "XacThuc")';
            }
        }

        // Auto logout when session expires
        function checkSessionExpiry() {
            fetch('@Url.Action("ThongTinCaNhan", "NguoiDung")', {
                method: 'GET'
            })
                .then(response => {
                    // Nếu redirect về trang đăng nhập (status 302), session đã hết hạn
                    if (response.redirected && response.url.includes('dang-nhap')) {
                        alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
                        window.location.href = '@Url.Action("DangNhap", "XacThuc")';
                    }
                })
                .catch(error => {
                    console.error('Session check error:', error);
                });
        }

        // Check session every 5 minutes
        setInterval(checkSessionExpiry, 5 * 60 * 1000);
    </script>
}
else
{
    <li class="nav-item">
        <a class="nav-link text-white" asp-controller="XacThuc" asp-action="DangNhap">
            <i class="fas fa-sign-in-alt me-1"></i>Đăng Nhập
        </a>
    </li>
}