@using InternalTrainingSystem.WebApp.Constants
@using InternalTrainingSystem.WebApp.Models.DTOs
@{
    ViewData["Title"] = "Chi tiết khóa học";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model List<EligibleStaffResponse>

<div class="course-detail-container p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-3">
            <a href="/QuanLyTrucTiep/TrangChuQuanLyTrucTiep" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Quay lại danh sách
            </a>
            <div>
                <h4 class="fw-bold mb-1">
                    Chi tiết khóa học: <span class="text-primary">Lập trình Web cơ bản</span>
                </h4>
                <p class="text-muted mb-0">Ngày khai giảng: <strong>15/10/2025</strong></p>
                <p class="text-muted mb-0">Số lượng Dự Kiến: <strong>25</strong></p>
            </div>
        </div>
        <form asp-action="NotifyEligibleUsers" asp-controller="Course" method="post">
            <input type="hidden" name="courseId" value="@ViewBag.CourseId" />

            @if (ViewBag.IsNotificationSent)
            {
                <button type="submit" class="btn btn-success" disabled>
                    <i class="bi bi-send"></i> Đã gửi lúc
                    @(((DateTime?)ViewBag.SentAt)?.ToString("dd/MM/yyyy HH:mm"))
                </button>
            }
            else
            {
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-send"></i> Gửi thông báo
                </button>
            }
        </form>
    </div>
    @if (Model != null && Model.Any())
    {
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">Danh sách học viên</h5>
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Mã nhân viên</th>
                        <th>Tên học viên</th>
                        <th>Email</th>
                        <th>Phòng ban</th>
                        <th>Trạng thái</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                    <tbody>
                        @foreach (var staff in Model)
                        {
                            <tr>
                                <td>@staff.EmployeeId</td>
                                <td>@staff.FullName</td>
                                <td>@staff.Email</td>
                                <td>@staff.Department</td>
                                <td>
                                    @if (staff.Status == EnrollmentConstants.Status.Enrolled)
                                    {
                                        <span class="badge bg-success">Chấp nhận</span>
                                    }
                                    else if (staff.Status == EnrollmentConstants.Status.NotEnrolled)
                                    {
                                        <span class="badge bg-danger">Không chấp nhận</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Chưa duyệt</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (staff.Status == EnrollmentConstants.Status.NotEnrolled)
                                    {
                                        <button class="btn btn-outline-info btn-sm btn-detail"
                                                data-name="@staff.FullName"
                                                data-reason="@staff.Reason">
                                            Chi tiết
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>

            </table>
        </div>
    </div>
    }
    else
    {
        <p>Không có nhân viên nào cần xác nhận chứng chỉ.</p>
    }
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết học viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Tên học viên:</strong> <span id="studentName"></span></p>
                <p><strong>Lý do đăng ký:</strong></p>
                <p class="border p-2 bg-light" id="studentReason"></p>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnReject" class="btn btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Không chấp nhận
                </button>
                <button type="button" id="btnApprove" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Chấp nhận
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/chitietkhoahoc.css?v=@DateTime.Now.Ticks" />
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modalEl = document.getElementById("detailModal");
            const modal = new bootstrap.Modal(modalEl);
            let currentButton = null;

            document.querySelectorAll(".btn-detail").forEach(btn => {
                btn.addEventListener("click", function () {
                    currentButton = this;
                    document.getElementById("studentName").textContent = this.dataset.name;
                    document.getElementById("studentReason").textContent = this.dataset.reason;
                    modal.show();
                });
            });

            document.getElementById("btnApprove").addEventListener("click", function () {
                if (!currentButton) return;
                modal.hide();

                modalEl.addEventListener("hidden.bs.modal", function handler() {
                    const td = currentButton.closest("td");
                    td.innerHTML = `✅`;
                    currentButton = null;
                    modalEl.removeEventListener("hidden.bs.modal", handler);
                });
            });

            document.getElementById("btnReject").addEventListener("click", function () {
                if (!currentButton) return;
                modal.hide();

                modalEl.addEventListener("hidden.bs.modal", function handler() {
                    const td = currentButton.closest("td");
                    td.innerHTML = `❌`;
                    currentButton = null;
                    modalEl.removeEventListener("hidden.bs.modal", handler);
                });
            });

            document.getElementById("btnSendNotification").addEventListener("click", function () {
                if (confirm("Bạn có chắc muốn gửi thông báo đến tất cả học viên không?")) {
                    alert("✅ Thông báo đã được gửi thành công đến tất cả học viên!");
                }
            });
        });
    </script>
}

