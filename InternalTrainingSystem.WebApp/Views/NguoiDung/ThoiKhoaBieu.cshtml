@using InternalTrainingSystem.WebApp.Constants
@model List<InternalTrainingSystem.WebApp.Models.DTOs.ScheduleItemResponseDto>
@{
    ViewData["Title"] = "Thời Khóa Biểu";
}

@section Styles {
    <link rel="stylesheet" href="~/css/schedule.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/attendance.css" asp-append-version="true" />
}

<div class="schedule-container">
    @Html.AntiForgeryToken()
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-calendar-alt me-2"></i>Thời Khóa Biểu</h1>
            <p>Xem lịch học và trạng thái điểm danh của bạn</p>
        </div>

        <div class="schedule-wrapper">
            @if (Model != null && Model.Any())
            {
                var minDate = Model.Min(s => s.Day.Date);
                var maxDate = Model.Max(s => s.Day.Date);

                // Tìm tuần đầu tiên (thứ 2)
                var startOfWeek = minDate;
                while (startOfWeek.DayOfWeek != DayOfWeek.Monday)
                {
                    startOfWeek = startOfWeek.AddDays(-1);
                }

                var weeks = new List<DateTime>();
                var currentWeekStart = startOfWeek;
                while (currentWeekStart <= maxDate)
                {
                    weeks.Add(currentWeekStart);
                    currentWeekStart = currentWeekStart.AddDays(7);
                }

                // Tìm tuần hiện tại
                var today = DateTime.Now.Date;
                var currentWeekStartDate = today;
                while (currentWeekStartDate.DayOfWeek != DayOfWeek.Monday)
                {
                    currentWeekStartDate = currentWeekStartDate.AddDays(-1);
                }
                var currentWeekIndex = weeks.FindIndex(w => w == currentWeekStartDate);
                if (currentWeekIndex == -1)
                {
                    currentWeekIndex = weeks.FindIndex(w => w <= today && w.AddDays(6) >= today);
                }

                <div class="table-responsive" id="scheduleTableContainer" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-bordered mb-0" style="font-size: 0.9rem;">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="width: 100px;">Tuần</th>
                                <th>Thứ 2</th>
                                <th>Thứ 3</th>
                                <th>Thứ 4</th>
                                <th>Thứ 5</th>
                                <th>Thứ 6</th>
                                <th>Thứ 7</th>
                                <th>Chủ Nhật</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int weekIndex = 0; weekIndex < weeks.Count; weekIndex++)
                            {
                                var weekStart = weeks[weekIndex];
                                var weekEnd = weekStart.AddDays(6);
                                var isCurrentWeek = weekIndex == currentWeekIndex;
                                <tr class="schedule-week-row" id="@(isCurrentWeek ? "currentWeek" : "")">
                                    <td class="text-center fw-bold align-middle" style="@(isCurrentWeek ? "background-color: #fff3cd;" : "")">
                                        @weekStart.ToString("dd/MM", System.Globalization.CultureInfo.InvariantCulture)
                                        - @weekEnd.ToString("dd/MM", System.Globalization.CultureInfo.InvariantCulture)
                                    </td>
                                    @for (int dayOffset = 0; dayOffset < 7; dayOffset++)
                                    {
                                        var currentDate = weekStart.AddDays(dayOffset);
                                        var daySchedules = Model.Where(s => s.Day.Date == currentDate).OrderBy(s => s.StartTime).ToList();

                                        <td class="align-top" style="min-width: 120px;">
                                            <div class="text-center text-muted small mb-1">
                                                @currentDate.ToString("dd/MM", System.Globalization.CultureInfo.InvariantCulture)
                                            </div>
                                            @if (daySchedules.Any())
                                            {
                                                @foreach (var schedule in daySchedules)
                                                {
                                                    <div class="mb-2 p-2 rounded" style="background-color: #e3f2fd; border-left: 3px solid #2196F3;">
                                                        <div class="fw-bold" style="color: #1976D2; font-size: 0.85rem;">
                                                            @schedule.StartTime.ToString(@"hh\:mm") - @schedule.EndTime.ToString(@"hh\:mm")
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(schedule.Location))
                                                        {
                                                            <div class="text-muted small">
                                                                <i class="fas fa-map-marker-alt me-1"></i>@schedule.Location
                                                            </div>
                                                        }
                                                        <div class="small mt-1" style="color: #424242;">
                                                            <i class="fas fa-book me-1"></i>@schedule.CourseCode
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(schedule.OnlineLink))
                                                        {
                                                            <div class="small mt-1">
                                                                <a href="@schedule.OnlineLink" target="_blank" class="text-decoration-none">
                                                                    <i class="fas fa-video me-1"></i>Link học online
                                                                </a>
                                                            </div>
                                                        }
                                                        @if (User.IsInRole(UserRoles.Staff) &&
                                                                !string.IsNullOrEmpty(schedule.AttendanceStatus))
                                                        {
                                                            var badgeClass = schedule.AttendanceStatus switch
                                                            {
                                                                AttendanceConstants.Status.Present => "badge bg-success",
                                                                AttendanceConstants.Status.Absent => "badge bg-danger",
                                                                _ => "badge bg-secondary"
                                                            };
                                                            var statusText = schedule.AttendanceStatus switch
                                                            {
                                                                AttendanceConstants.Status.Present => "Có mặt",
                                                                AttendanceConstants.Status.Absent => "Vắng",
                                                                _ => "Chưa điểm danh"
                                                            };
                                                            <div class="mt-2 text-center">
                                                                <span class="@badgeClass" style="font-size: 0.7rem;">@statusText</span>
                                                            </div>
                                                        }
                                                        @if (User.IsInRole(UserRoles.Mentor))
                                                        {
                                                            var scheduleDateTime = schedule.Day.Date + schedule.StartTime;
                                                            var isPastSchedule = scheduleDateTime < DateTime.Now;
                                                            var startTimeStr = schedule.StartTime.ToString(@"hh\:mm");
                                                            var endTimeStr = schedule.EndTime.ToString(@"hh\:mm");
                                                            
                                                            <div class="mt-2">
                                                                @if (!isPastSchedule)
                                                                {
                                                                    <a asp-controller="NguoiDung" asp-action="DiemDanh" asp-route-scheduleId="@schedule.ScheduleId" 
                                                                       class="btn btn-sm btn-primary w-100 mb-1">
                                                                        <i class="fas fa-clipboard-check me-1"></i>Điểm danh
                                                                    </a>
                                                                <button type="button" class="btn btn-sm btn-warning w-100" 
                                                                        onclick="openRescheduleModal(@schedule.ScheduleId, '@schedule.Day.ToString("yyyy-MM-dd")', '@startTimeStr', '@endTimeStr', '@schedule.Location')">
                                                                        <i class="fas fa-calendar-alt me-1"></i>Đổi lịch học
                                                                    </button>
                                                                }
                                                                
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="text-center text-muted small">-</div>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h3>Chưa có lịch học</h3>
                    <p>Bạn chưa được xếp vào lớp học nào.</p>
                    <a asp-controller="KhoaHoc" asp-action="DanhSachKhoaHocCuaToi" class="btn-back">
                        <i class="fas fa-arrow-left"></i>
                        Về khóa học của tôi
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Reschedule Modal -->
<div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rescheduleModalLabel">Đổi lịch học</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rescheduleForm">
                    <input type="hidden" id="scheduleId" />
                    <div class="mb-3">
                        <label for="newDate" class="form-label">Ngày học mới <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="newDate" required />
                    </div>
                    <div class="mb-3">
                        <label for="newStartTime" class="form-label">Giờ bắt đầu <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="newStartTime" required />
                    </div>
                    <div class="mb-3">
                        <label for="newEndTime" class="form-label">Giờ kết thúc <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="newEndTime" required />
                    </div>
                    <div class="mb-3">
                        <label for="newLocation" class="form-label">Địa điểm <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newLocation" required />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitReschedule()">Xác nhận đổi lịch</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto scroll to current week
        document.addEventListener('DOMContentLoaded', function() {
            var currentWeek = document.getElementById('currentWeek');
            if (currentWeek) {
                var container = document.getElementById('scheduleTableContainer');
                if (container) {
                    var containerRect = container.getBoundingClientRect();
                    var currentWeekRect = currentWeek.getBoundingClientRect();
                    var scrollTop = currentWeekRect.top - containerRect.top + container.scrollTop - 100;
                    container.scrollTo({
                        top: scrollTop,
                        behavior: 'smooth'
                    });
                }
            }
        });

        // Open reschedule modal
        function openRescheduleModal(scheduleId, currentDate, startTime, endTime, location) {
            document.getElementById('scheduleId').value = scheduleId;
            document.getElementById('newDate').value = currentDate;
            document.getElementById('newStartTime').value = startTime;
            document.getElementById('newEndTime').value = endTime;
            document.getElementById('newLocation').value = location || '';
            
            var modal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
            modal.show();
        }

        // Submit reschedule
        async function submitReschedule() {
            const form = document.getElementById('rescheduleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const scheduleId = document.getElementById('scheduleId').value;
            const newDate = document.getElementById('newDate').value;
            const newStartTime = document.getElementById('newStartTime').value;
            const newEndTime = document.getElementById('newEndTime').value;
            const newLocation = document.getElementById('newLocation').value.trim();

            if (!newLocation) {
                alert('Vui lòng điền đầy đủ thông tin.');
                return;
            }

            // Convert HH:mm to TimeSpan format (HH:mm:ss.fffffff) for API
            const formatTimeForApi = (time) => {
                if (!time) return '';
                // Convert HH:mm to HH:mm:ss.0000000
                if (time.includes(':') && time.split(':').length === 2) {
                    return `${time}:00.0000000`;
                }
                // If already has seconds, add milliseconds
                if (time.split(':').length === 3 && !time.includes('.')) {
                    return `${time}.0000000`;
                }
                return time;
            };

            const requestData = {
                newDate: newDate,
                newStartTime: formatTimeForApi(newStartTime),
                newEndTime: formatTimeForApi(newEndTime),
                newLocation: newLocation
            };

            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
                if (!token) {
                    // Create a temporary form to get the token
                    const tempForm = document.createElement('form');
                    tempForm.innerHTML = '@Html.AntiForgeryToken()';
                    document.body.appendChild(tempForm);
                    const newToken = tempForm.querySelector('input[name="__RequestVerificationToken"]')?.value;
                    document.body.removeChild(tempForm);
                    
                    if (!newToken) {
                        alert('Không thể lấy token xác thực. Vui lòng tải lại trang.');
                        return;
                    }
                }

                const response = await fetch(`/lop-hoc/doi-lich-hoc/${scheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token || document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const result = await response.text();
                    alert(result || 'Đổi lịch học thành công.');
                    var modal = bootstrap.Modal.getInstance(document.getElementById('rescheduleModal'));
                    modal.hide();
                    location.reload();
                } else {
                    const errorText = await response.text();
                    alert('Lỗi: ' + (errorText || `Mã lỗi: ${response.status}`));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi đổi lịch học: ' + error.message);
            }
        }
    </script>
}

