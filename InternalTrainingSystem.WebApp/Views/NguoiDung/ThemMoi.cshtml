@model InternalTrainingSystem.WebApp.Models.DTOs.CreateStaffDto
@{
    ViewData["Title"] = "Thêm Mới Nhân Viên";
}

@section Styles {
    <link rel="stylesheet" href="~/css/user-create.css" asp-append-version="true" />
}

<div class="user-create-container">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user-circle me-2"></i>Thông Tin Nhân Viên
                        </h5>
                    </div>
                    <div class="card-body">
                        <form asp-action="ThemMoi" method="post" novalidate>
                            @Html.AntiForgeryToken()
                            
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <label asp-for="EmployeeId" class="form-label required">
                                        <i class="fas fa-id-card me-1"></i>Mã Nhân Viên
                                    </label>
                                    <input asp-for="EmployeeId" class="form-control  " 
                                           placeholder="Nhập mã nhân viên (ví dụ: EMP001)">
                                    <span asp-validation-for="EmployeeId" class="text-danger"></span>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Mã nhân viên duy nhất trong hệ thống
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label asp-for="FullName" class="form-label required">
                                        <i class="fas fa-user me-1"></i>Họ và Tên
                                    </label>
                                    <input asp-for="FullName" class="form-control  " 
                                           placeholder="Nhập họ và tên đầy đủ">
                                    <span asp-validation-for="FullName" class="text-danger"></span>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Họ và tên đầy đủ của nhân viên
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label asp-for="Email" class="form-label required">
                                        <i class="fas fa-envelope me-1"></i>Email
                                    </label>
                                    <input asp-for="Email" type="email" class="form-control  " 
                                           placeholder="email@company.com">
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Email sẽ được sử dụng để đăng nhập và nhận thông báo
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label asp-for="Phone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>Số Điện Thoại
                                    </label>
                                    <input asp-for="Phone" type="tel" class="form-control  " 
                                           placeholder="0123456789">
                                    <span asp-validation-for="Phone" class="text-danger"></span>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Số điện thoại liên hệ (không bắt buộc)
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label asp-for="DepartmentId" class="form-label required">
                                        <i class="fas fa-building me-1"></i>Phòng Ban
                                    </label>
                                    <select asp-for="DepartmentId" class="form-select">
                                        <option value="">-- Chọn phòng ban --</option>
                                        @if (ViewBag.Departments != null)
                                        {
                                            var departments = ViewBag.Departments as List<InternalTrainingSystem.WebApp.Models.DTOs.DepartmnentViewDto>;
                                            if (departments != null)
                                            {
                                                foreach (var dept in departments)
                                                {
                                                    <option value="@dept.DepartmentId">@dept.DepartmentName</option>
                                                }
                                            }
                                        }
                                    </select>
                                    <span asp-validation-for="DepartmentId" class="text-danger"></span>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Chọn phòng ban mà nhân viên thuộc về
                                    </div>
                                </div>

                                <div class="col-md-6 mb-4">
                                    <label asp-for="Position" class="form-label">
                                        <i class="fas fa-briefcase me-1"></i>Chức Vụ
                                    </label>
                                    <input asp-for="Position" class="form-control  " 
                                           placeholder="Nhập chức vụ (ví dụ: Nhân viên, Chuyên viên...)">
                                    <span asp-validation-for="Position" class="text-danger"></span>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Chức vụ hiện tại của nhân viên (không bắt buộc)
                                    </div>
                                </div>

                                @if (ViewBag.IsAdmin == true)
                                {
                                    <div class="col-md-6 mb-4">
                                        <label asp-for="RoleName" class="form-label required">
                                            <i class="fas fa-user-tag me-1"></i>Vai Trò
                                        </label>
                                        <select asp-for="RoleName" class="form-select">
                                            <option value="">-- Chọn vai trò --</option>
                                            @if (ViewBag.Roles != null)
                                            {
                                                var roles = ViewBag.Roles as List<InternalTrainingSystem.WebApp.Models.DTOs.RoleDto>;
                                                if (roles != null)
                                                {
                                                    foreach (var role in roles)
                                                    {
                                                        <option value="@role.Name" selected="@(role.Name == "Staff")">@role.Name</option>
                                                    }
                                                }
                                            }
                                        </select>
                                        <span asp-validation-for="RoleName" class="text-danger"></span>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Chọn vai trò cho người dùng trong hệ thống
                                        </div>
                                    </div>
                                }
                            </div>

                            <div class="form-actions">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="reset" class="btn btn-secondary btn-lg w-100">
                                            <i class="fas fa-redo me-2"></i>Làm Mới
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                            <i class="fas fa-user-plus me-2"></i>Tạo Nhân Viên
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-question-circle me-2"></i>Hướng Dẫn
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="help-list">
                            <div class="help-item">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <span>Mã nhân viên phải là duy nhất trong hệ thống và không được trùng lặp</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <span>Email phải hợp lệ và chưa được sử dụng trong hệ thống</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <span>Sau khi tạo tài khoản thành công, email kích hoạt và mật khẩu tạm sẽ được gửi đến địa chỉ email đã đăng ký</span>
                            </div>
                            <div class="help-item">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <span>Nhân viên nên đổi mật khẩu ngay sau lần đăng nhập đầu tiên để bảo mật tài khoản</span>
                            </div>
                            @if (ViewBag.IsAdmin == true)
                            {
                                <div class="help-item">
                                    <i class="fas fa-user-shield text-primary"></i>
                                    <span><strong>Admin:</strong> Bạn có thể chọn bất kỳ vai trò nào cho người dùng mới</span>
                                </div>
                            }
                            else
                            {
                                <div class="help-item">
                                    <i class="fas fa-user-shield text-info"></i>
                                    <span><strong>HR:</strong> Người dùng mới sẽ được tạo với vai trò Staff mặc định</span>
                                </div>
                            }
                            <div class="help-item">
                                <i class="fas fa-lightbulb text-warning"></i>
                                <span>Tất cả các trường đánh dấu (*) là bắt buộc phải điền</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Character counter for employee ID
            $('#EmployeeId').on('input', function() {
                const maxLength = 100;
                const currentLength = $(this).val().length;
                
                if (currentLength > 0) {
                    $('.emp-counter').remove();
                    $(this).parent().find('.form-text').after(
                        `<small class="text-muted emp-counter">${currentLength}/${maxLength} ký tự</small>`
                    );
                }
            });

            // Character counter for full name
            $('#FullName').on('input', function() {
                const maxLength = 100;
                const currentLength = $(this).val().length;
                
                if (currentLength > 0) {
                    $('.name-counter').remove();
                    $(this).parent().find('.form-text').after(
                        `<small class="text-muted name-counter">${currentLength}/${maxLength} ký tự</small>`
                    );
                }
            });

            // Phone validation enhancement
            $('#Phone').on('blur', function() {
                const phone = $(this).val().trim();
                const phoneRegex = /^[0-9]{10,11}$/;
                
                if (phone && !phoneRegex.test(phone)) {
                    $(this).addClass('is-invalid');
                    if ($(this).next('.invalid-feedback-phone').length === 0) {
                        $(this).after('<div class="invalid-feedback-phone text-danger">Số điện thoại không hợp lệ (10-11 chữ số)</div>');
                    }
                } else {
                    $(this).removeClass('is-invalid');
                    $('.invalid-feedback-phone').remove();
                }
            });

            // Form validation before submit
            $('form').on('submit', function(e) {
                let isValid = true;

                // Validate required fields
                const requiredFields = ['#EmployeeId', '#FullName', '#Email', '#DepartmentId'];
                
                // Nếu là Admin, thêm RoleName vào danh sách validate
                @if (ViewBag.IsAdmin == true)
                {
                    <text>
                    requiredFields.push('#RoleName');
                    </text>
                }
                
                requiredFields.forEach(function(field) {
                    const value = $(field).val();
                    if (!value || value.trim() === '') {
                        isValid = false;
                        $(field).addClass('is-invalid');
                    } else {
                        $(field).removeClass('is-invalid');
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    $('html, body').animate({
                        scrollTop: $('.is-invalid:first').offset().top - 100
                    }, 500);
                    
                    return false;
                }
            });

            // Remove validation class on input
            $('.form-control, .form-select').on('input change', function() {
                $(this).removeClass('is-invalid');
                $('.invalid-feedback-phone').remove();
            });

            // Reset form handler
            $('button[type="reset"]').on('click', function() {
                setTimeout(function() {
                    $('.form-control, .form-select').removeClass('is-invalid');
                    $('.invalid-feedback-phone, .emp-counter, .name-counter').remove();
                }, 10);
            });
        });
    </script>
}
